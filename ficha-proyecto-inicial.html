<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS - Ficha de Proyecto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 210px;
            background: #3a3a3a;
            color: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .logo-section {
            padding: 20px;
            border-bottom: 1px solid #555;
            text-align: center;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .user-info {
            padding: 15px;
            border-bottom: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-icon i {
            color: #d1d5db;
            font-size: 14px;
        }

        .user-details {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-version {
            font-size: 11px;
            color: #aaa;
            margin-top: 3px;
        }

        .company-select {
            width: calc(100% - 30px);
            margin: 15px;
            padding: 8px 12px;
            background: #444;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
        }

        .company-select:hover {
            background: #4a4a4a;
        }

        .menu {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .menu-item {
            padding: 12px 15px;
            color: #ccc;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 4px;
            transition: all 0.2s;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-item:hover {
            background: #444;
            color: white;
        }

        .menu-item.active {
            background: #ee8866;
            color: white;
        }

        .menu-icon {
            font-size: 18px;
            flex-shrink: 0;
            width: 18px;
            display: inline-flex;
            justify-content: center;
            color: #a8b0bb;
        }

        .menu-icon i {
            font-size: 15px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-volver {
            padding: 8px 16px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .btn-volver i {
            margin-right: 6px;
            color: #7b8794;
        }

        .btn-volver:hover {
            background: #e0e0e0;
        }

        .header-project-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-project-info .info-label {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 6px 14px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .header-project-info .info-label .label-title {
            font-size: 10px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-project-info .info-label .label-value {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-top: 2px;
        }

        .header-project-info .info-label .label-value.empty {
            color: #bbb;
            font-style: italic;
            font-weight: 400;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            align-items: center;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            color: #666;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .tab-button i {
            margin-right: 6px;
            font-size: 13px;
        }

        .tab-button:hover {
            background: #e0e0e0;
        }

        .tab-button.active {
            background: #ee8866;
            color: white;
        }

        .tab-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-nueva-oi-tabs {
            margin-left: auto;
            padding: 9px 14px;
            border: none;
            border-radius: 6px;
            background: #111;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: none;
        }

        .btn-nueva-oi-tabs:hover {
            background: #2a2a2a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        /* Section Card */
        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .section-header {
            background: #fafafa;
            padding: 14px 20px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }

        .section-body {
            padding: 24px;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-grid .full-width {
            grid-column: 1 / -1;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #444;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: Arial, sans-serif;
            transition: border-color 0.2s;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ee8866;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group select:disabled {
            background: #f5f5f5;
            color: #999;
        }

        /* Form actions */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #ee8866;
            color: white;
        }

        .btn-primary:hover {
            background: #e67550;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Estado badge */
        .estado-proyecto {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .estado-sin-iniciar {
            background: #f5f5f5;
            color: #666;
        }

        .estado-en-ejecucion {
            background: #fff3e0;
            color: #e65100;
        }

        .estado-finalizado {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .estado-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .estado-sin-iniciar .estado-dot { background: #999; }
        .estado-en-ejecucion .estado-dot { background: #e65100; }
        .estado-finalizado .estado-dot { background: #2e7d32; }

        /* Empty tab placeholder */
        .tab-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .tab-placeholder .placeholder-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
        }

        .tab-placeholder h3 {
            font-size: 18px;
            color: #666;
            margin-bottom: 8px;
        }

        .tab-placeholder p {
            font-size: 14px;
        }

        /* Toast */
        .toast {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 5000;
            animation: toastIn 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Nuevo badge */
        .badge-nuevo {
            display: inline-block;
            background: #e3f2fd;
            color: #1565c0;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Read-only mode */
        .form-value {
            padding: 10px 12px;
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        /* ==========================================
           CALENDARIO EMBEBIDO
           ========================================== */
        .cal-workspace {
            display: flex;
            gap: 0;
            height: calc(100vh - 220px);
            min-height: 500px;
        }

        /* Panel Inspectores */
        .cal-inspectors {
            width: 200px;
            background: white;
            border: 1px solid #e3e3e3;
            border-radius: 10px 0 0 10px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .cal-inspectors-title {
            padding: 12px 14px;
            font-weight: 600;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
        }

        .cal-inspector-card {
            padding: 10px 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .cal-inspector-card:hover {
            background: #f9f9f9;
        }

        .cal-inspector-card.selected {
            background: #fff3e0;
            border-left: 3px solid #ee8866;
        }

        .cal-inspector-info .cal-inspector-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .cal-inspector-info .cal-inspector-role {
            font-size: 11px;
            color: #999;
        }

        .cal-inspector-count {
            background: #eee;
            color: #666;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        .cal-inspector-count.has-items {
            background: #ee8866;
            color: white;
        }

        .cal-inspector-right {
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .cal-inspector-menu-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid #e5e7eb;
            background: white;
            color: #94a3b8;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        .cal-inspector-menu-btn:hover {
            border-color: #cbd5e1;
            color: #64748b;
        }

        .cal-inspector-menu {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            min-width: 130px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12);
            z-index: 20;
            overflow: hidden;
        }

        .cal-inspector-menu.show {
            display: block;
        }

        .cal-inspector-menu button {
            width: 100%;
            border: none;
            background: white;
            text-align: left;
            padding: 9px 10px;
            font-size: 12px;
            color: #334155;
            cursor: pointer;
        }

        .cal-inspector-menu button:hover {
            background: #f8fafc;
        }

        /* Área del calendario */
        .cal-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border: 1px solid #e3e3e3;
            border-left: none;
            border-radius: 0 10px 10px 0;
            overflow: hidden;
        }

        .cal-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid #eee;
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .cal-nav-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            transition: all 0.2s;
        }

        .cal-nav-btn.today-btn {
            width: auto;
            border-radius: 20px;
            padding: 0 16px;
            font-size: 13px;
        }

        .cal-nav-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .cal-month-title {
            font-size: 20px;
            font-weight: 400;
            color: #333;
            margin: 0 10px;
        }

        /* Legend */
        .cal-legend {
            display: flex;
            gap: 16px;
            padding: 6px 16px;
            font-size: 11px;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        .cal-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .cal-legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .cal-legend-dot.etfa { background: #4CAF50; }
        .cal-legend-dot.medicion { background: #2196F3; }
        .cal-legend-dot.no-autorizado { background: #f44336; }

        /* Calendar Grid */
        .cal-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto;
            grid-auto-rows: auto;
            overflow-y: auto;
        }

        .cal-day-header {
            padding: 8px;
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            background: #fafafa;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .cal-day {
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            padding: 4px;
            min-height: 80px;
            position: relative;
        }

        .cal-day.empty {
            background: #f9f9f9;
        }

        .cal-day .day-num {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            padding: 2px 4px;
        }

        .cal-day.weekend {
            background: #fafafa;
        }

        /* OI Cards */
        .cal-oi {
            padding: 4px 6px;
            margin-bottom: 3px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            line-height: 1.3;
        }

        .cal-oi:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .cal-oi.assigned {
            background: #ee8866;
            color: white;
        }

        .cal-oi.unassigned {
            background: #555;
            color: white;
        }

        .cal-grid.assigning-mode .cal-oi {
            cursor: pointer;
        }

        .cal-oi.assign-selected {
            outline: 2px solid #111;
            outline-offset: 1px;
            transform: translateY(-1px);
        }

        .cal-oi .oi-title {
            font-weight: bold;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .cal-oi .oi-detail {
            font-size: 9px;
            opacity: 0.85;
        }

        .cal-oi .oi-type-icon {
            font-size: 9px;
            opacity: 0.95;
            line-height: 1;
        }

        .cal-oi .etfa-dot {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            line-height: 1;
            background: rgba(255,255,255,0.2);
        }

        .cal-oi .etfa-dot.green { color: #d9ffe3; }
        .cal-oi .etfa-dot.red { color: #ffd8d8; }
        .cal-oi .etfa-dot.blue { color: #dbeafe; }

        /* Drag & Drop */
        .cal-oi.dragging {
            opacity: 0.4;
            transform: scale(0.95);
        }

        .cal-day.drag-over {
            background: #fff3e0 !important;
            box-shadow: inset 0 0 0 2px #ee8866;
        }

        .cal-oi.drag-over-oi {
            outline: 2px solid #ee8866;
            outline-offset: 1px;
        }

        .cal-inspector-card.dragging-inspector {
            opacity: 0.5;
        }

        .cal-oi.inspector-drop-target {
            outline: 2px dashed #2196F3;
            outline-offset: 1px;
        }

        .cal-day .oi-container {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .cal-assign-bar {
            position: fixed;
            left: 210px;
            right: 0;
            bottom: 0;
            background: #f3f4f6;
            border-top: 2px solid #e67e53;
            padding: 8px 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 3500;
            box-shadow: 0 -6px 16px rgba(0,0,0,0.08);
        }

        .cal-assign-bar.show {
            display: flex;
        }

        .cal-assign-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cal-assign-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #ff6f3d;
            color: white;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }

        .cal-assign-text {
            font-size: 12px;
            color: #475569;
        }

        .cal-assign-text strong {
            display: block;
            color: #1f2937;
            font-size: 14px;
            line-height: 1.2;
        }

        .cal-assign-count {
            border: 1px solid #f0b59c;
            border-radius: 8px;
            padding: 6px 10px;
            background: #fff4ef;
            color: #475569;
            font-size: 12px;
        }

        .cal-assign-count .num {
            font-size: 22px;
            line-height: 1;
            color: #ff6f3d;
            font-weight: 700;
            margin-right: 4px;
            vertical-align: middle;
        }

        .cal-assign-actions {
            display: flex;
            gap: 8px;
        }

        .cal-assign-btn {
            min-width: 118px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid #a3a3a3;
            background: white;
            color: #4b5563;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .cal-assign-btn.confirm {
            border-color: transparent;
            background: #b8b8bc;
            color: white;
        }

        .cal-assign-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        /* ==========================================
           PUNTOS DE MUESTREO
           ========================================== */
        .muestreo-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .muestreo-table thead th {
            background: #fafafa;
            padding: 10px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }

        .muestreo-table tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            vertical-align: middle;
        }

        .muestreo-table tbody tr:hover {
            background: #fafafa;
        }

        .muestreo-table .col-num {
            width: 30px;
            text-align: center;
            color: #999;
        }

        .muestreo-table .col-action {
            width: 40px;
            text-align: center;
        }

        .muestreo-table .col-input {
            width: 70px;
        }

        .muestreo-table .col-input input {
            width: 60px;
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }

        .muestreo-table .col-input input:focus {
            outline: none;
            border-color: #ee8866;
        }

        .btn-delete-row {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .btn-delete-row:hover {
            color: #c0392b;
        }

        /* Modal Punto de Muestreo */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-box {
            background: white;
            border-radius: 10px;
            width: 480px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-box-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
        }

        .modal-box-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-box-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-box-close:hover {
            color: #333;
        }

        .modal-box-body {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .modal-box-body .form-group label .required {
            color: #e74c3c;
        }

        .modal-box-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 16px 24px;
            border-top: 1px solid #eee;
        }

        .btn-modal-cancel {
            padding: 10px 24px;
            background: #f0f0f0;
            color: #555;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-modal-cancel:hover {
            background: #e0e0e0;
        }

        .btn-modal-save {
            padding: 10px 24px;
            background: #5cb3a0;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-modal-save:hover {
            background: #4a9e8c;
        }

        .lab-panel-lateral {
            right: calc(-100vw + 210px);
            width: calc(100vw - 210px);
            max-width: none;
            background: #f5f7fb;
        }

        .lab-panel-lateral.show {
            right: 0;
        }

        .lab-panel-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .lab-panel-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-top: 1px solid #e5e7eb;
            background: #fff;
        }

        .lab-panel-footer .btn-panel {
            min-width: 130px;
            border-radius: 999px;
            font-weight: 600;
        }

        .lab-panel-footer .btn-panel-secondary {
            border: 1px solid #d1d5db;
            background: #fff;
        }

        .lab-section {
            border: 1px solid #dbe2ec;
            border-left: 3px solid #ee8866;
            border-radius: 8px;
            background: #ffffff;
            padding: 14px;
        }

        .lab-section-title {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #334155;
            margin-bottom: 12px;
        }

        .lab-section-title i {
            color: #ee8866;
            font-size: 12px;
        }

        .lab-panel-body {
            gap: 14px;
        }

        .lab-header {
            background: #f3f3f4;
            border: 1px solid #e3e3e3;
            border-radius: 8px;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0;
            overflow: visible;
            min-height: 0;
            height: auto;
            margin-bottom: 12px;
        }

        .lab-header-summary {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            background: #f0f0f1;
        }

        .lab-summary-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
        }

        .lab-summary-left {
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .lab-summary-label {
            font-size: 11px;
            color: #9b9fa6;
            text-transform: uppercase;
            letter-spacing: .04em;
            font-weight: 600;
        }

        .lab-summary-code {
            font-size: 18px;
            font-weight: 700;
            color: #ef835d;
            line-height: 1;
        }

        .lab-summary-right {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .lab-summary-total {
            text-align: right;
            color: #7b8088;
            min-width: 96px;
        }

        .lab-summary-total .k {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .04em;
            margin-bottom: 1px;
        }

        .lab-summary-total .v {
            font-size: 34px;
            font-weight: 700;
            color: #3b3f46;
            line-height: 1.1;
        }

        .lab-header-line2 {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 14px;
            padding: 10px 18px 12px;
            border-top: 1px solid #e5e5e5;
            background: #f5f5f6;
            font-size: 12px;
            color: #475569;
        }

        .lab-line2-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .lab-line2-item i {
            color: #8b95a3;
            font-size: 11px;
        }

        .lab-line2-item strong {
            color: #1f2937;
            font-weight: 600;
        }

        .lab-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            border: 1px solid #d9d9db;
            background: #f4f4f5;
            color: #666b73;
            font-size: 11px;
            font-weight: 700;
            padding: 5px 12px;
            line-height: 1.2;
        }

        .lab-pill.state {
            border-color: #eb8a61;
            background: #ef835d;
            color: #ffffff;
        }

        .lab-oi-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 10px;
            font-size: 12px;
            color: #475569;
        }

        .lab-meta-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid #dbe2ec;
            background: #f8fafc;
            color: #475569;
            font-size: 12px;
        }

        .lab-oi-meta strong {
            color: #0f172a;
        }

        .lab-fields {
            display: grid;
            grid-template-columns: 1.4fr 1fr 1fr;
            gap: 12px;
        }

        .lab-fields .form-group {
            margin: 0;
        }

        .lab-panel-lateral .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 6px;
        }

        .lab-panel-lateral input[type="text"],
        .lab-panel-lateral input[type="date"],
        .lab-panel-lateral input[type="time"],
        .lab-panel-lateral textarea,
        .lab-panel-lateral select {
            height: 40px;
            border: 1px solid #d5dde8;
            border-radius: 8px;
            background: #f8fafd;
            color: #1f2937;
            font-size: 13px;
            padding: 8px 12px;
            outline: none;
            transition: all .18s ease;
        }

        .lab-panel-lateral textarea {
            height: auto;
            min-height: 84px;
        }

        .lab-panel-lateral input:focus,
        .lab-panel-lateral textarea:focus,
        .lab-panel-lateral select:focus {
            border-color: #f0a48d;
            box-shadow: 0 0 0 3px rgba(238, 136, 102, 0.12);
            background: #fff;
        }

        .lab-obs-group {
            margin-top: 2px;
        }

        .lab-obs-group textarea {
            min-height: 72px;
            resize: vertical;
        }

        .lab-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .lab-toolbar-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #475569;
        }

        .lab-toolbar-actions input {
            accent-color: #ee8866;
        }

        .lab-count {
            font-size: 12px;
            font-weight: 600;
            color: #334155;
        }

        .lab-table-wrap {
            border: 1px solid #dde5ef;
            border-radius: 8px;
            overflow: auto;
            max-height: 45vh;
            background: #fff;
        }

        .lab-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .lab-table th {
            position: sticky;
            top: 0;
            background: #f3f6fb;
            z-index: 1;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: .02em;
            color: #64748b;
            border-bottom: 1px solid #dde5ef;
            padding: 9px 10px;
        }

        .lab-table td {
            border-bottom: 1px solid #edf2f7;
            padding: 7px 10px;
            color: #334155;
            vertical-align: middle;
        }

        .lab-table tbody tr:nth-child(even) {
            background: #fbfcfe;
        }

        .lab-table tbody tr:hover {
            background: #f6f9fd;
        }

        .lab-table tr:last-child td {
            border-bottom: none;
        }

        .lab-table .sample-code {
            font-weight: 600;
            color: #0f172a;
        }

        .lab-table input[type="checkbox"] {
            accent-color: #ee8866;
        }

        .lab-table input[type="date"],
        .lab-table input[type="time"] {
            width: 100%;
            min-width: 120px;
            height: 34px;
            font-size: 12px;
            padding: 6px 8px;
        }

        .lab-obs-cell {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .lab-obs-status {
            font-size: 10px;
            font-weight: 700;
            border-radius: 999px;
            padding: 2px 7px;
            border: 1px solid #dbe3ef;
            background: #f8fafc;
            color: #64748b;
            white-space: nowrap;
        }

        .lab-obs-status.has-note {
            border-color: #f0b59c;
            background: #fff2ec;
            color: #e67550;
        }

        .lab-obs-btn {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            border: 1px solid #dbe3ef;
            background: #fff;
            color: #8aa0be;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
        }

        .lab-obs-btn:hover {
            border-color: #b9c8dd;
            color: #5f7fa6;
            background: #f8fafc;
        }

        @media (max-width: 920px) {
            .lab-panel-lateral {
                width: 100vw;
                max-width: 100vw;
            }

            .lab-summary-code {
                font-size: 22px;
            }

            .lab-fields {
                grid-template-columns: 1fr;
            }
        }

        .btn-agregar-punto {
            padding: 8px 20px;
            background: #ee8866;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .btn-agregar-punto:hover {
            background: #e67550;
        }

        /* ==========================================
           LISTADO OI
           ========================================== */
        .oi-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .oi-search {
            flex: 1;
            max-width: 320px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .oi-search:focus {
            border-color: #ee8866;
        }

        .oi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .oi-table thead th {
            background: #fafafa;
            padding: 10px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 2px solid #eee;
            white-space: nowrap;
        }

        .oi-table tbody td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            vertical-align: middle;
        }

        .oi-table tbody tr:hover {
            background: #fafafa;
        }

        .oi-table .col-num {
            width: 30px;
            text-align: center;
            color: #999;
        }

        .oi-table .col-action {
            width: 40px;
            text-align: center;
        }

        .oi-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .oi-status-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .oi-status-pendiente { background: #fff3e0; color: #e65100; }
        .oi-status-pendiente .dot { background: #e65100; }
        .oi-status-programada { background: #e3f2fd; color: #1565c0; }
        .oi-status-programada .dot { background: #1565c0; }
        .oi-status-ejecutada { background: #e8f5e9; color: #2e7d32; }
        .oi-status-ejecutada .dot { background: #2e7d32; }
        .oi-status-cancelada { background: #fce4ec; color: #c62828; }
        .oi-status-cancelada .dot { background: #c62828; }

        .oi-table .acciones-cell {
            display: flex;
            gap: 6px;
        }

        .btn-oi-action {
            padding: 4px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
        }

        .btn-oi-action:hover {
            border-color: #ee8866;
            color: #ee8866;
        }

        .btn-oi-action.delete {
            color: #e74c3c;
            border-color: #f5c6cb;
        }

        .btn-oi-action.delete:hover {
            background: #fce4ec;
            border-color: #e74c3c;
        }

        .oi-count-info {
            font-size: 12px;
            color: #999;
        }

        .oi-cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .oi-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #fff;
            padding: 10px 12px;
            box-shadow: 0 1px 1px rgba(15, 23, 42, 0.04);
        }

        .oi-card-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .oi-card-id {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
            flex-wrap: wrap;
        }

        .oi-card-code {
            font-size: 14px;
            font-weight: 700;
            color: #0f172a;
            letter-spacing: 0.1px;
        }

        .oi-pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.2px;
            background: #ecfeff;
            color: #0f766e;
            border: 1px solid #ccfbf1;
        }

        .oi-pill i {
            margin-right: 5px;
            font-size: 10px;
            color: #5b6675;
        }

        .oi-pill.muted {
            background: #f8fafc;
            color: #475569;
            border-color: #e2e8f0;
        }

        .oi-card-line {
            font-size: 13px;
            color: #475569;
            line-height: 1.35;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .oi-card-line .k {
            font-weight: 700;
            color: #334155;
        }

        .oi-info-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .oi-info-icon {
            font-size: 12px;
            color: #8b95a1;
            line-height: 1;
            width: 12px;
            display: inline-flex;
            justify-content: center;
        }

        .oi-info-item .v {
            color: #334155;
        }

        .oi-card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .oi-options-wrap {
            position: relative;
        }

        .oi-options-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            background: #e67e53;
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .oi-options-btn:hover {
            background: #d96f44;
        }

        .oi-options-menu {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            min-width: 150px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.12);
            z-index: 30;
            overflow: hidden;
        }

        .oi-options-menu.show {
            display: block;
        }

        .oi-options-item {
            width: 100%;
            padding: 9px 12px;
            border: none;
            background: white;
            text-align: left;
            font-size: 12px;
            color: #334155;
            cursor: pointer;
            transition: background 0.15s;
        }

        .oi-options-item:hover {
            background: #f8fafc;
        }

        .oi-options-item.delete {
            color: #dc2626;
        }

        /* Expandable row */
        .oi-table tbody tr.oi-detail-row td {
            padding: 0;
            background: #f9f9f9;
        }

        .oi-detail-content {
            padding: 12px 16px;
        }

        .oi-detail-content h4 {
            font-size: 12px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .oi-puntos-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .oi-puntos-detail-table th {
            background: #eee;
            padding: 6px 8px;
            text-align: left;
            font-size: 10px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
        }

        .oi-puntos-detail-table td {
            padding: 6px 8px;
            border-bottom: 1px solid #e8e8e8;
            color: #333;
        }

        .etfa-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }

        .etfa-badge.etfa-si { background: #e8f5e9; color: #2e7d32; }
        .etfa-badge.etfa-no { background: #fce4ec; color: #c62828; }

        .estrato-tag {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            background: #e3f2fd;
            color: #1565c0;
            margin-right: 3px;
        }

        .btn-expand {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 11px;
            cursor: pointer;
            color: #555;
            transition: all 0.2s;
        }

        .btn-expand:hover {
            border-color: #ee8866;
            color: #ee8866;
        }

        /* ==========================================
           PANEL LATERAL - CREAR OI
           ========================================== */
        .panel-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 3000;
        }

        .panel-overlay.show {
            display: block;
        }

        .panel-lateral {
            position: fixed;
            top: 0;
            right: -520px;
            width: 520px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 3001;
            display: flex;
            flex-direction: column;
            transition: right 0.3s ease;
        }

        .panel-lateral.show {
            right: 0;
        }

        /* Override específico para panel laboratorio (evita que tome el ancho base de panel-lateral) */
        .panel-lateral.lab-panel-lateral {
            right: calc(-100vw + 210px);
            width: calc(100vw - 210px);
            max-width: none;
        }

        .panel-lateral.lab-panel-lateral.show {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .panel-header h3 {
            font-size: 17px;
            font-weight: 600;
            color: #333;
        }

        .panel-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #999;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .panel-close:hover { color: #333; }

        /* OI resumen header */
        .oi-resumen {
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .oi-resumen-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .oi-resumen-left {
            min-width: 0;
            flex: 1;
        }

        .oi-resumen-title {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            line-height: 1.2;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .oi-resumen-sub {
            font-size: 13px;
            color: #4b5563;
            margin-bottom: 2px;
        }

        .oi-resumen-date {
            font-size: 13px;
            font-weight: 700;
            color: #374151;
        }

        .oi-resumen-tipo {
            margin-top: 5px;
            display: none;
        }

        .oi-tipo-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            background: #eef2ff;
            border: 1px solid #c7d2fe;
            color: #4338ca;
        }

        .oi-resumen-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            min-width: 220px;
        }

        .oi-contacto-line {
            font-size: 12px;
            color: #4b5563;
        }

        .oi-contacto-line strong {
            color: #111827;
            font-weight: 600;
        }

        .oi-estado-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            padding: 5px 12px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            border: 1px solid transparent;
        }

        .oi-estado-pendiente {
            background: #fff7ed;
            border-color: #fed7aa;
            color: #c2410c;
        }

        .oi-estado-programada {
            background: #eff6ff;
            border-color: #bfdbfe;
            color: #1d4ed8;
        }

        .oi-estado-ejecutada {
            background: #ecfdf5;
            border-color: #a7f3d0;
            color: #047857;
        }

        .oi-estado-cancelada {
            background: #fef2f2;
            border-color: #fecaca;
            color: #b91c1c;
        }

        .oi-personas-section {
            margin-top: 6px;
            border-top: 1px solid #eee;
            padding-top: 14px;
        }

        .oi-usuarios-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .oi-usuario-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
            background: #f3f4f6;
            color: #4b5563;
        }

        .oi-usuario-remove {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 1px solid #d1d5db;
            background: white;
            color: #9ca3af;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .oi-usuario-remove:hover {
            border-color: #ef4444;
            color: #ef4444;
            background: #fff5f5;
        }

        .oi-usuario-chip .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .oi-usuario-chip.coordinador .dot { background: #34a853; }
        .oi-usuario-chip.supervisor .dot { background: #1a73e8; }
        .oi-usuario-chip.inspector .dot { background: #f97316; }

        /* Step tabs */
        .panel-steps {
            display: flex;
            border-bottom: 2px solid #eee;
            flex-shrink: 0;
        }

        .panel-step-tab {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .panel-step-tab.active {
            color: #ee8866;
            border-bottom-color: #ee8866;
        }

        .panel-step-tab .step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #eee;
            color: #999;
            font-size: 11px;
            font-weight: 700;
            margin-right: 6px;
        }

        .panel-step-tab.active .step-num {
            background: #ee8866;
            color: white;
        }

        /* Step content */
        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
        }

        .panel-step-content {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .panel-step-content.active {
            display: flex;
        }

        .panel-lateral.view-unified .panel-step-content + .panel-step-content {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid #eceff3;
        }

        .panel-lateral.view-unified .puntos-list-header {
            margin-top: 8px;
        }

        .panel-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 24px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }

        .panel-footer-left {
            display: flex;
            gap: 8px;
        }

        .btn-panel {
            padding: 9px 20px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-panel-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-panel-secondary:hover { background: #e0e0e0; }

        .btn-panel-primary {
            background: #ee8866;
            color: white;
        }

        .btn-panel-primary:hover { background: #e67550; }

        .btn-panel-success {
            background: #5cb3a0;
            color: white;
        }

        .btn-panel-success:hover { background: #4a9e8c; }

        /* Type toggle */
        .type-toggle {
            display: flex;
            gap: 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .type-toggle button {
            flex: 1;
            padding: 9px 12px;
            border: none;
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: #555;
            border-right: 1px solid #ddd;
            transition: all 0.2s;
        }

        .type-toggle button:last-child { border-right: none; }

        .type-toggle button.active {
            background: #ee8866;
            color: white;
        }

        /* Recurrence checkbox */
        .recurrence-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: #f8f8f8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            user-select: none;
        }

        .recurrence-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #ee8866;
        }

        .recurrence-section {
            display: none;
            padding: 16px;
            background: #fafafa;
            border: 1px solid #eee;
            border-radius: 8px;
            flex-direction: column;
            gap: 14px;
        }

        .recurrence-section.show { display: flex; }

        .freq-toggle {
            display: flex;
            gap: 0;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #ddd;
            width: fit-content;
        }

        .freq-toggle button {
            padding: 7px 18px;
            border: none;
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: #555;
            border-right: 1px solid #ddd;
            transition: all 0.2s;
        }

        .freq-toggle button:last-child { border-right: none; }
        .freq-toggle button.active { background: #ee8866; color: white; }

        .freq-description { font-size: 12px; color: #888; }

        .week-days { display: flex; gap: 6px; }

        .week-days label {
            display: flex; align-items: center; justify-content: center;
            width: 34px; height: 34px; border-radius: 50%;
            border: 1px solid #ddd; font-size: 11px; font-weight: 600;
            cursor: pointer; color: #555; background: white; transition: all 0.2s;
        }

        .week-days label.checked { background: #ee8866; color: white; border-color: #ee8866; }
        .week-days input[type="checkbox"] { display: none; }

        .interval-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
        .interval-row input { width: 60px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 13px; }

        .end-options { display: flex; flex-direction: column; gap: 8px; }
        .end-option { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
        .end-option input[type="radio"] { accent-color: #ee8866; }
        .end-option input[type="date"],
        .end-option input[type="number"] { padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .end-option input[type="number"] { width: 60px; text-align: center; }

        .recurrence-preview {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565c0;
        }

        .recurrence-preview .preview-count {
            margin-left: auto; background: #1565c0; color: white;
            padding: 2px 10px; border-radius: 10px; font-weight: 700; font-size: 12px;
        }

        /* Botón agregar muestras */
        .btn-abrir-form {
            width: 100%;
            padding: 10px 14px;
            background: white;
            border: 1px dashed #bbb;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-abrir-form:hover { border-color: #ee8866; color: #ee8866; }

        .btn-abrir-form .ico { font-size: 16px; }

        /* Formulario agregar muestras */
        .add-muestras-form {
            display: none;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .add-muestras-form.show { display: block; }

        .form-title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
        }

        .form-title-bar span {
            font-size: 12px; font-weight: 700; color: #555;
            text-transform: uppercase; letter-spacing: 0.3px;
        }

        .form-title-bar button {
            background: none; border: none; font-size: 16px;
            color: #999; cursor: pointer; line-height: 1;
        }

        .form-title-bar button:hover { color: #333; }

        .form-inner {
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
            min-width: 0;
        }

        .form-field label {
            font-size: 10px; font-weight: 700; color: #999;
            text-transform: uppercase; letter-spacing: 0.3px;
        }

        .form-field select,
        .form-field input[type="number"] {
            padding: 7px 8px; border: 1px solid #ddd;
            border-radius: 5px; font-size: 12px;
            background: white; color: #333; width: 100%;
        }

        .field-help {
            margin-top: 4px;
            font-size: 11px;
            color: #999;
        }

        /* ETFA toggle */
        .etfa-toggle-compact {
            display: flex; gap: 0;
            border-radius: 5px; overflow: hidden; border: 1px solid #ddd;
        }

        .etfa-toggle-compact button {
            padding: 7px 12px; border: none; background: white;
            font-size: 11px; font-weight: 600; cursor: pointer;
            color: #999; transition: all 0.15s;
        }

        .etfa-toggle-compact button:first-child { border-right: 1px solid #ddd; }
        .etfa-toggle-compact button.active-etfa { background: #4CAF50; color: white; }
        .etfa-toggle-compact button.active-noetfa { background: #ef5350; color: white; }

        /* Puntos check list */
        .puntos-check-list {
            max-height: 130px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .puntos-check-list.modern {
            max-height: 260px;
            border: 1px solid #e3e7ed;
            border-radius: 10px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.7);
        }

        .puntos-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }

        .puntos-search-input {
            flex: 1;
            min-width: 0;
            padding: 8px 10px;
            border: 1px solid #d5dbe3;
            border-radius: 8px;
            font-size: 12px;
            color: #334155;
            background: #fff;
        }

        .puntos-search-input:focus {
            outline: none;
            border-color: #ee8866;
            box-shadow: 0 0 0 3px rgba(238, 136, 102, 0.14);
        }

        .puntos-selection-info {
            font-size: 11px;
            color: #64748b;
            margin: 4px 0 8px;
        }

        .punto-check-item {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 7px 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.1s;
            font-size: 12px;
            color: #333;
        }

        .puntos-check-list.modern .punto-check-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eef2f7;
        }

        .punto-check-item:last-child { border-bottom: none; }
        .punto-check-item:hover { background: #fef5f2; }

        .punto-check-item input[type="checkbox"] {
            width: 15px; height: 15px; accent-color: #ee8866;
            flex-shrink: 0; cursor: pointer;
        }

        .punto-check-item .pci-name { font-weight: 600; }
        .punto-check-item .pci-detail { color: #94a3b8; font-size: 11px; margin-left: 4px; }

        .punto-check-text {
            display: flex;
            flex-direction: column;
            gap: 0;
            min-width: 0;
            flex: 1;
        }

        .punto-check-line {
            display: flex;
            align-items: center;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .punto-check-badges {
            display: flex;
            gap: 4px;
            margin-left: auto;
            align-self: flex-end;
            padding-bottom: 1px;
            flex-shrink: 0;
        }

        .pci-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 10px;
            font-weight: 700;
            border: 1px solid #e2e8f0;
            color: #64748b;
            background: #f8fafc;
            line-height: 1.1;
        }

        .punto-check-item.disabled {
            opacity: 0.35; pointer-events: none;
        }

        .btn-agregar-muestras {
            padding: 9px 16px; background: #ee8866; color: white;
            border: none; border-radius: 5px; font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all 0.15s;
            width: 100%;
        }

        .btn-agregar-muestras:hover { background: #e67550; }

        /* Lista compacta */
        .puntos-list-header {
            display: flex; align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .puntos-list-count { font-size: 12px; color: #ee8866; font-weight: 600; }

        .punto-list-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 10px; background: white;
            border: 1px solid #eee; border-radius: 6px;
            margin-bottom: 4px; transition: all 0.15s;
        }

        .punto-list-item:hover { border-color: #ddd; }

        .punto-list-icon {
            width: 26px; height: 26px; border-radius: 50%;
            background: #ee8866; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; flex-shrink: 0;
        }

        .punto-list-info {
            flex: 1; min-width: 0;
            display: flex; flex-direction: column; gap: 2px;
        }

        .punto-list-name { font-size: 12px; font-weight: 600; color: #333; }

        .punto-list-place {
            font-size: 11px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .punto-list-details {
            font-size: 10px; color: #999;
            display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
        }

        .punto-list-details .detail-sep { color: #ddd; }

        .punto-list-tag {
            display: inline-block; padding: 1px 6px;
            border-radius: 3px; font-size: 9px; font-weight: 700;
        }

        .punto-list-tag.tag-etfa { background: #e8f5e9; color: #2e7d32; }
        .punto-list-tag.tag-noetfa { background: #fce4ec; color: #c62828; }
        .punto-list-tag.tag-estrato { background: #fff3e0; color: #e65100; }

        .punto-list-remove {
            width: 22px; height: 22px; border-radius: 50%;
            border: none; background: transparent; color: #ccc;
            font-size: 14px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all 0.15s; flex-shrink: 0;
        }

        .punto-list-remove:hover { background: #fee; color: #e53935; }

        .puntos-empty-msg {
            text-align: center; padding: 20px 16px;
            color: #ccc; font-size: 12px;
        }

        .panel-section-title {
            font-size: 11px; font-weight: 700; color: #888;
            text-transform: uppercase; letter-spacing: 0.3px;
        }

        .empty-table-msg {
            text-align: center;
            padding: 30px 20px;
            color: #999;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-section">
            <a href="#" class="logo">SGS</a>
        </div>

        <div class="user-info">
            <div class="user-icon"><i class="fa-regular fa-user"></i></div>
            <div class="user-details">
                <div class="user-name">VIVIANA LOPEZ</div>
                <div class="user-version">Versión 1.0.2</div>
            </div>
        </div>

        <select class="company-select">
            <option>SGS CHILE</option>
        </select>

        <nav class="menu">
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-solid fa-house"></i></span>
                <span>INICIO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-regular fa-file-lines"></i></span>
                <span>DOCUMENTOS</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-regular fa-pen-to-square"></i></span>
                <span>INFORME DE TERRENO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-solid fa-list-check"></i></span>
                <span>LISTADO OL</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-regular fa-rectangle-list"></i></span>
                <span>LISTADO OI</span>
            </a>
            <a href="gestion-proyectos.html" class="menu-item active">
                <span class="menu-icon"><i class="fa-regular fa-building"></i></span>
                <span>PROYECTOS</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-regular fa-calendar-days"></i></span>
                <span>CALENDARIO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon"><i class="fa-solid fa-box-archive"></i></span>
                <span>PREPARACIÓN DE MATERIALES</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
            <div class="header">
            <div class="header-left">
                <a href="gestion-proyectos.html" class="btn-volver"><i class="fa-solid fa-arrow-left"></i>Volver</a>
                <h1 id="headerTitle">Ficha Proyecto</h1>
            </div>
            <div class="header-project-info" id="headerProjectInfo">
                <div class="info-label">
                    <span class="label-title">Cliente</span>
                    <span class="label-value empty" id="headerCliente">Sin definir</span>
                </div>
                <div class="info-label">
                    <span class="label-title">OL</span>
                    <span class="label-value empty" id="headerOL">-</span>
                </div>
                <div class="info-label">
                    <span class="label-title">Proyecto</span>
                    <span class="label-value empty" id="headerProyecto">-</span>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" data-tab="ficha"><i class="fa-regular fa-clipboard"></i>Ficha</button>
                <button class="tab-button" data-tab="listado-oi" id="tabListadoOI"><i class="fa-regular fa-rectangle-list"></i>Listado OI</button>
                <button class="tab-button" data-tab="calendario" id="tabCalendario"><i class="fa-regular fa-calendar-days"></i>Calendario</button>
                <button class="btn-nueva-oi-tabs" id="btnNuevaOITabs" onclick="abrirModalOI()">+ Nueva OI</button>
            </div>

            <!-- Tab: Ficha -->
            <div class="tab-content active" id="tab-ficha">
                <div class="section">
                    <div class="section-header">
                        Información del Proyecto
                        <span class="estado-proyecto estado-sin-iniciar" id="estadoBadge">
                            <span class="estado-dot"></span>
                            Sin iniciar
                        </span>
                    </div>
                    <div class="section-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="inputCliente">Cliente</label>
                                <select id="inputCliente">
                                    <option value="">Seleccione cliente...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="inputOL">OL</label>
                                <select id="inputOL" disabled>
                                    <option value="">Seleccione cliente primero...</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="inputNombre">Nombre del Proyecto</label>
                                <input type="text" id="inputNombre" placeholder="Nombre descriptivo del proyecto">
                            </div>
                            <div class="form-group">
                                <label for="inputCodigo">Código</label>
                                <input type="text" id="inputCodigo" placeholder="Ej: SGS-2026-005">
                            </div>
                            <div class="form-group">
                                <label for="inputResponsable">Responsable</label>
                                <select id="inputResponsable">
                                    <option value="">Seleccione responsable...</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="inputDescripcion">Descripción</label>
                                <textarea id="inputDescripcion" placeholder="Breve descripción del proyecto y sus objetivos..."></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="limpiarFormulario()">Limpiar</button>
                            <button class="btn btn-primary" id="btnGuardar" onclick="guardarProyecto()">Crear Proyecto</button>
                        </div>
                    </div>
                </div>

                <!-- Sección Puntos de Muestreo -->
                <div class="section">
                    <div class="section-header">
                        Puntos de Muestreo / Estaciones
                    </div>
                    <div class="section-body">
                        <table class="muestreo-table" id="tablaPuntos">
                            <thead>
                                <tr>
                                    <th class="col-num">#</th>
                                    <th>Nombre del Punto Muestreo/Estación</th>
                                    <th>Lugar de Muestreo</th>
                                    <th>Matriz</th>
                                    <th>Latitud</th>
                                    <th>Longitud</th>
                                    <th class="col-input">Estratos</th>
                                    <th class="col-input">Réplicas</th>
                                    <th class="col-input">Muestras</th>
                                    <th class="col-action">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyPuntos">
                            </tbody>
                        </table>
                        <div class="empty-table-msg" id="emptyPuntosMsg">No hay puntos de muestreo agregados</div>

                        <div style="margin-top: 16px;">
                            <button class="btn-agregar-punto" onclick="abrirModalPunto()">+ Agregar Punto de Muestreo</button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Tab: Listado OI -->
            <div class="tab-content" id="tab-listado-oi">
                <div class="section">
                    <div class="section-header">
                        Órdenes de Inspección
                        <span class="oi-count-info" id="oiCountInfo"></span>
                    </div>
                    <div class="section-body">
                        <div class="oi-toolbar">
                            <input type="text" class="oi-search" id="oiSearch" placeholder="Buscar por código, matriz, inspector...">
                        </div>
                        <div class="oi-cards-grid" id="oiCardsContainer"></div>
                        <div class="empty-table-msg" id="emptyOIMsg">No hay órdenes de inspección creadas</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Calendario -->
            <div class="tab-content" id="tab-calendario">
                <div class="cal-workspace">
                    <!-- Panel Inspectores -->
                    <div class="cal-inspectors">
                        <div class="cal-inspectors-title">Inspectores</div>
                        <div class="cal-inspector-card" data-inspector="unassigned">
                            <div class="cal-inspector-info">
                                <div class="cal-inspector-name">Sin asignar</div>
                                <div class="cal-inspector-role">OIs sin inspector</div>
                            </div>
                            <div class="cal-inspector-right">
                                <span class="cal-inspector-count" id="calCount-unassigned">0</span>
                            </div>
                        </div>
                        <div class="cal-inspector-card" data-inspector="1">
                            <div class="cal-inspector-info">
                                <div class="cal-inspector-name">Carlos Mendoza</div>
                                <div class="cal-inspector-role">Inspector Senior</div>
                            </div>
                            <div class="cal-inspector-right">
                                <span class="cal-inspector-count" id="calCount-1">0</span>
                                <button class="cal-inspector-menu-btn" onclick="toggleInspectorMenu(event, '1')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                <div class="cal-inspector-menu" id="inspectorMenu-1">
                                    <button onclick="startBatchAssign('1', 'assign', event)">Asignar OIs</button>
                                    <button onclick="startBatchAssign('1', 'unassign', event)">Desasignar OIs</button>
                                </div>
                            </div>
                        </div>
                        <div class="cal-inspector-card" data-inspector="2">
                            <div class="cal-inspector-info">
                                <div class="cal-inspector-name">María González</div>
                                <div class="cal-inspector-role">Inspector Junior</div>
                            </div>
                            <div class="cal-inspector-right">
                                <span class="cal-inspector-count" id="calCount-2">0</span>
                                <button class="cal-inspector-menu-btn" onclick="toggleInspectorMenu(event, '2')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                <div class="cal-inspector-menu" id="inspectorMenu-2">
                                    <button onclick="startBatchAssign('2', 'assign', event)">Asignar OIs</button>
                                    <button onclick="startBatchAssign('2', 'unassign', event)">Desasignar OIs</button>
                                </div>
                            </div>
                        </div>
                        <div class="cal-inspector-card" data-inspector="3">
                            <div class="cal-inspector-info">
                                <div class="cal-inspector-name">Pedro Sánchez</div>
                                <div class="cal-inspector-role">Inspector Senior</div>
                            </div>
                            <div class="cal-inspector-right">
                                <span class="cal-inspector-count" id="calCount-3">0</span>
                                <button class="cal-inspector-menu-btn" onclick="toggleInspectorMenu(event, '3')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                <div class="cal-inspector-menu" id="inspectorMenu-3">
                                    <button onclick="startBatchAssign('3', 'assign', event)">Asignar OIs</button>
                                    <button onclick="startBatchAssign('3', 'unassign', event)">Desasignar OIs</button>
                                </div>
                            </div>
                        </div>
                        <div class="cal-inspector-card" data-inspector="4">
                            <div class="cal-inspector-info">
                                <div class="cal-inspector-name">Ana Rodríguez</div>
                                <div class="cal-inspector-role">Inspector Junior</div>
                            </div>
                            <div class="cal-inspector-right">
                                <span class="cal-inspector-count" id="calCount-4">0</span>
                                <button class="cal-inspector-menu-btn" onclick="toggleInspectorMenu(event, '4')"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                <div class="cal-inspector-menu" id="inspectorMenu-4">
                                    <button onclick="startBatchAssign('4', 'assign', event)">Asignar OIs</button>
                                    <button onclick="startBatchAssign('4', 'unassign', event)">Desasignar OIs</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Área Calendario -->
                    <div class="cal-area">
                        <div class="cal-controls">
                            <div class="cal-nav">
                                <button class="cal-nav-btn today-btn" onclick="calGoToday()">Hoy</button>
                                <button class="cal-nav-btn" onclick="calChangeYear(-1)">«</button>
                                <button class="cal-nav-btn" onclick="calChangeMonth(-1)">‹</button>
                                <span class="cal-month-title" id="calMonthTitle">diciembre 2025</span>
                                <button class="cal-nav-btn" onclick="calChangeMonth(1)">›</button>
                                <button class="cal-nav-btn" onclick="calChangeYear(1)">»</button>
                            </div>
                        </div>
                        <div class="cal-legend">
                            <div class="cal-legend-item"><span class="cal-legend-dot etfa"></span> ETFA</div>
                            <div class="cal-legend-item"><span class="cal-legend-dot medicion"></span> Solo medición</div>
                            <div class="cal-legend-item"><span class="cal-legend-dot no-autorizado"></span> Plan ETFA no autorizado</div>
                        </div>
                        <div class="cal-grid" id="calGrid">
                            <!-- Se genera dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="cal-assign-bar" id="calAssignBar">
        <div class="cal-assign-left">
            <div class="cal-assign-avatar" id="calAssignAvatar">--</div>
            <div class="cal-assign-text">
                <span id="calAssignActionLabel">Asignando a:</span>
                <strong id="calAssignInspectorName">-</strong>
            </div>
            <div class="cal-assign-count">
                <span class="num" id="calAssignCountNum">0</span>
                OIs seleccionadas
            </div>
        </div>
        <div class="cal-assign-actions">
            <button class="cal-assign-btn" onclick="cancelBatchAssign()">Cancelar</button>
            <button class="cal-assign-btn confirm" id="calAssignConfirmBtn" onclick="confirmBatchAssign()">Confirmar</button>
        </div>
    </div>

    <!-- Modal Agregar Punto de Muestreo -->
    <div class="modal-overlay" id="modalPunto">
        <div class="modal-box">
            <div class="modal-box-header">
                <h3>Agregar punto de muestreo</h3>
                <button class="modal-box-close" onclick="cerrarModalPunto()">&times;</button>
            </div>
            <div class="modal-box-body">
                <div class="form-group">
                    <label>Matriz<span class="required">*</span></label>
                    <select id="newMatriz">
                        <option value="">Seleccionar</option>
                        <option value="POLVO_SEDIMENTABLE">POLVO_SEDIMENTABLE</option>
                        <option value="AGUA_SUPERFICIAL">AGUA_SUPERFICIAL</option>
                        <option value="AGUA_MAR">AGUA_MAR</option>
                        <option value="AGUA_SUBTERRANEA">AGUA_SUBTERRANEA</option>
                        <option value="AGUA_POTABLE">AGUA_POTABLE</option>
                        <option value="AGUA_RESIDUAL">AGUA_RESIDUAL</option>
                        <option value="SEDIMENTO">SEDIMENTO</option>
                        <option value="SUELO">SUELO</option>
                        <option value="AIRE">AIRE</option>
                        <option value="RUIDO">RUIDO</option>
                        <option value="BIOTA">BIOTA</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Lugar de Monitoreo<span class="required">*</span></label>
                    <input type="text" id="newLugar" placeholder="Ingrese un lugar de monitoreo">
                </div>
                <div class="form-group">
                    <label>Nombre del Punto<span class="required">*</span></label>
                    <input type="text" id="newEstacion" placeholder="Ingrese el nombre o ID del punto">
                </div>
                <div style="display:flex; gap:12px;">
                    <div class="form-group" style="flex:1;">
                        <label>Latitud</label>
                        <input type="text" id="newLatitud" placeholder="Ej: -33.4569">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Longitud</label>
                        <input type="text" id="newLongitud" placeholder="Ej: -70.6483">
                    </div>
                </div>
            </div>
            <div class="modal-box-footer">
                <button class="btn-modal-cancel" onclick="cerrarModalPunto()">Cerrar</button>
                <button class="btn-modal-save" onclick="agregarPunto()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Observación de Punto (Enviar a laboratorio) -->
    <div class="modal-overlay" id="modalLabPuntoObs">
        <div class="modal-box" style="max-width:520px;">
            <div class="modal-box-header">
                <h3>Observación del punto (laboratorio)</h3>
                <button class="modal-box-close" onclick="cerrarModalLabPuntoObs()">&times;</button>
            </div>
            <div class="modal-box-body">
                <div class="form-group">
                    <label>Punto</label>
                    <div class="form-value" id="labObsPuntoTitulo">-</div>
                </div>
                <div class="form-group">
                    <label>Observación</label>
                    <textarea id="labObsPuntoTexto" placeholder="Ingrese observación para este punto..." rows="4"></textarea>
                </div>
            </div>
            <div class="modal-box-footer">
                <button class="btn-modal-cancel" onclick="cerrarModalLabPuntoObs()">Cancelar</button>
                <button class="btn-modal-save" onclick="guardarModalLabPuntoObs()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Panel Enviar Muestras a Laboratorio -->
    <div class="panel-overlay" id="panelLabOverlay" onclick="cerrarPanelLaboratorio()"></div>
    <div class="panel-lateral lab-panel-lateral" id="panelLaboratorio">
        <div class="panel-header">
            <h3>Enviar muestras a laboratorio</h3>
            <button class="panel-close" onclick="cerrarPanelLaboratorio()">&times;</button>
        </div>
        <div class="lab-panel-body">
            <div class="lab-header">
                <div class="lab-header-summary">
                    <div class="lab-summary-main">
                        <div class="lab-summary-left">
                            <span class="lab-summary-label">Orden</span>
                            <span class="lab-summary-code" id="labHeadCodigo">OI-000000</span>
                            <span class="lab-pill state" id="labHeadEstado">Pendiente</span>
                            <span class="lab-pill" id="labHeadTipo">Muestreo y Medición</span>
                            <span class="lab-pill" id="labHeadComposicion">Puntual</span>
                        </div>
                        <div class="lab-summary-right">
                        <div class="lab-summary-total">
                            <span class="k">Total muestras</span>
                            <span class="v" id="labHeadTotalMuestras">0</span>
                        </div>
                        </div>
                    </div>
                    <div class="lab-header-line2">
                        <span class="lab-line2-item"><i class="fa-solid fa-calendar-check"></i> Recepción: <strong id="labHeadRecepcion">-</strong></span>
                        <span class="lab-line2-item"><i class="fa-solid fa-layer-group"></i> Matriz: <strong id="labHeadMatriz">-</strong></span>
                        <span class="lab-line2-item"><i class="fa-solid fa-flask-vial"></i> Laboratorio: <strong id="labHeadLaboratorio">-</strong></span>
                        <span class="lab-line2-item"><i class="fa-solid fa-clipboard-list"></i> Plan: <strong id="labHeadPlan">-</strong></span>
                        <span class="lab-line2-item"><i class="fa-solid fa-user-gear"></i> Supervisor: <strong id="labHeadSupervisor">-</strong></span>
                        <span class="lab-line2-item"><i class="fa-solid fa-user-tie"></i> Inspector: <strong id="labHeadInspector">-</strong></span>
                    </div>
                </div>
            </div>

            <div class="lab-section">
                <div class="lab-section-title"><i class="fa-solid fa-vials"></i>Detalle de muestras</div>
                <div class="lab-toolbar">
                    <div class="lab-toolbar-actions">
                        <label><input type="checkbox" id="labCheckAll" onchange="toggleLabTodas(this.checked)"> Confirmar todas</label>
                    </div>
                    <div class="lab-count" id="labConfirmCount">0 / 0 confirmadas</div>
                </div>

                <div class="lab-table-wrap">
                    <table class="lab-table">
                        <thead>
                            <tr>
                                <th style="width:48px;">OK</th>
                                <th>Muestra</th>
                                <th>Punto</th>
                                <th>Lugar</th>
                                <th>Estrato</th>
                                <th>Réplica</th>
                                <th>Obs punto</th>
                                <th>Fecha Muestreo</th>
                                <th>Hora Muestreo</th>
                            </tr>
                        </thead>
                        <tbody id="labMuestrasBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="lab-section">
                <div class="lab-section-title"><i class="fa-solid fa-truck-fast"></i>Datos de envío y transporte</div>
                <div class="lab-fields">
                    <div class="form-group">
                        <label>Responsable de Muestreo<span class="required">*</span></label>
                        <input type="text" id="labRespMuestreo" placeholder="Nombre responsable">
                    </div>
                    <div class="form-group">
                        <label>Fecha Transporte<span class="required">*</span></label>
                        <input type="date" id="labFechaTransporte">
                    </div>
                    <div class="form-group">
                        <label>Hora Transporte<span class="required">*</span></label>
                        <input type="time" id="labHoraTransporte">
                    </div>
                </div>
                <div class="form-group lab-obs-group">
                    <label>Observaciones de terreno</label>
                    <textarea id="labObsTerreno" placeholder="Observaciones relevantes del muestreo y transporte..."></textarea>
                </div>
            </div>
        </div>
        <div class="lab-panel-footer">
            <button class="btn-panel btn-panel-secondary" onclick="cerrarPanelLaboratorio()">Cancelar</button>
            <button class="btn-panel btn-panel-success" onclick="guardarEnvioLaboratorio()">Confirmar envío</button>
        </div>
    </div>

    <!-- Panel Lateral - Crear OI -->
    <div class="panel-overlay" id="panelOIOverlay" onclick="cerrarPanelOI()"></div>
    <div class="panel-lateral" id="panelOI">
        <div class="panel-header">
            <h3 id="panelOITitle">Nueva Orden de Inspección</h3>
            <button class="panel-close" onclick="cerrarPanelOI()">&times;</button>
        </div>
        <div class="oi-resumen" id="oiResumenBox">
            <div class="oi-resumen-top">
                <div class="oi-resumen-left">
                    <div class="oi-resumen-title" id="oiResumenCliente">Cliente no seleccionado</div>
                    <div class="oi-resumen-sub" id="oiResumenOlOi">OL: - / OI: -</div>
                    <div class="oi-resumen-date" id="oiResumenFecha">Pendiente</div>
                    <div class="oi-resumen-tipo" id="oiResumenTipoWrap">
                        <span class="oi-tipo-badge" id="oiResumenTipoBadge">Muestreo y Medición</span>
                        <span class="oi-tipo-badge" id="oiResumenComposicionBadge">Puntual</span>
                    </div>
                </div>
                <div class="oi-resumen-right">
                    <div class="oi-contacto-line">Contacto: <strong id="oiResumenContacto">-</strong></div>
                    <div class="oi-contacto-line">Teléfono: <strong id="oiResumenTelefono">-</strong></div>
                    <span class="oi-estado-badge oi-estado-pendiente" id="oiResumenEstado">Pendiente</span>
                </div>
            </div>
        </div>

        <!-- Step Tabs -->
        <div class="panel-steps">
            <button class="panel-step-tab active" onclick="irPasoOI(1)" id="stepTab1">
                <span class="step-num">1</span> Datos de la OI
            </button>
            <button class="panel-step-tab" onclick="irPasoOI(2)" id="stepTab2">
                <span class="step-num">2</span> Puntos de Muestreo
            </button>
        </div>

        <!-- Body -->
        <div class="panel-body">
            <!-- PASO 1: Datos cabecera -->
            <div class="panel-step-content active" id="panelStep1">
                <div class="form-group" id="oiFechaGroup">
                    <label>Fecha<span class="required">*</span></label>
                    <input type="date" id="newOIFecha">
                </div>

                <div class="form-group" id="oiMatrizGroup">
                    <label>Matriz<span class="required">*</span></label>
                    <select id="oiMatriz" onchange="onChangeOIMatriz()">
                        <option value="">Seleccionar matriz...</option>
                    </select>
                </div>

                <div class="form-group" id="oiPlanGroup">
                    <label>Plan<span class="required">*</span></label>
                    <select id="oiPlan" disabled>
                        <option value="">Seleccionar plan...</option>
                    </select>
                </div>

                <div class="form-group" id="oiTipoGroup">
                    <label class="panel-section-title">Tipo de Orden</label>
                    <div class="type-toggle" id="typeToggle">
                        <button type="button" class="active" onclick="setTipoOI('muestreo_medicion', this)">Muestreo y Medición</button>
                        <button type="button" onclick="setTipoOI('medicion', this)">Solo Medición</button>
                    </div>
                </div>

                <div class="form-group" id="oiComposicionGroup">
                    <label>Tipo de muestra<span class="required">*</span></label>
                    <div class="type-toggle" id="composicionToggle">
                        <button type="button" class="active" onclick="setComposicionOI('puntual', this)">Puntual</button>
                        <button type="button" onclick="setComposicionOI('compuesta', this)">Compuesta</button>
                    </div>
                </div>

                <!-- Recurrencia -->
                <label class="recurrence-toggle" id="recurrenceToggleRow">
                    <input type="checkbox" id="chkRecurrencia" onchange="toggleRecurrencia()">
                    Programar recurrencia
                </label>

                <div class="recurrence-section" id="recurrenciaSection">
                    <div class="freq-toggle" id="freqToggle">
                        <button type="button" class="active" onclick="setFrequencia('diario', this)">Diario</button>
                        <button type="button" onclick="setFrequencia('semanal', this)">Semanal</button>
                        <button type="button" onclick="setFrequencia('cada_x', this)">Cada X días</button>
                    </div>

                    <div class="freq-description" id="freqDescription">Se programará todos los días</div>

                    <div class="week-days" id="weekDays" style="display:none;">
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="1">Lu</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="2">Ma</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="3">Mi</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="4">Ju</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="5">Vi</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="6">Sa</label>
                        <label onclick="toggleWeekDay(this)"><input type="checkbox" value="0">Do</label>
                    </div>

                    <div class="interval-row" id="intervalRow" style="display:none;">
                        Cada <input type="number" id="intervalDias" value="2" min="2" max="365" onchange="actualizarPreviewRecurrencia()"> días
                    </div>

                    <div class="end-options">
                        <label class="end-option">
                            <input type="radio" name="endType" value="hasta" checked onchange="actualizarPreviewRecurrencia()">
                            Hasta el
                            <input type="date" id="endDate" onchange="actualizarPreviewRecurrencia()">
                        </label>
                        <label class="end-option">
                            <input type="radio" name="endType" value="ocurrencias" onchange="actualizarPreviewRecurrencia()">
                            Después de
                            <input type="number" id="endOcurrencias" value="5" min="1" max="365" onchange="actualizarPreviewRecurrencia()">
                            ocurrencias
                        </label>
                    </div>

                    <div class="recurrence-preview" id="recurrencePreview">
                        <span>Se crearán OIs todos los días</span>
                        <span class="preview-count" id="previewCount">0</span>
                    </div>
                </div>

                <div class="oi-personas-section">
                    <label class="panel-section-title">Personas asociadas a la OI</label>
                    <div class="oi-usuarios-list" id="oiUsuariosDatosList"></div>
                </div>
            </div>

            <!-- PASO 2: Puntos de muestreo -->
            <div class="panel-step-content" id="panelStep2">
                <button type="button" class="btn-abrir-form" id="btnAbrirFormMuestras" onclick="toggleAddMuestrasForm(true)">
                    <span class="ico">+</span>
                    Agregar muestras
                </button>

                <div class="add-muestras-form" id="addMuestrasForm">
                    <div class="form-title-bar">
                        <span>Agregar muestras</span>
                        <button type="button" onclick="toggleAddMuestrasForm(false)" title="Cerrar">✕</button>
                    </div>
                    <div class="form-inner">
                        <div class="form-row">
                            <div class="form-field" style="flex:1.1;">
                                <label>ETFA</label>
                                <div class="etfa-toggle-compact" id="formEtfaToggle">
                                    <button type="button" class="active-noetfa" onclick="setFormEtfa(false, this)">No ETFA</button>
                                    <button type="button" onclick="setFormEtfa(true, this)">ETFA</button>
                                </div>
                            </div>
                            <div class="form-field" style="flex:1.9;">
                                <label>Laboratorio</label>
                                <select id="formLaboratorio">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-field">
                                <label>Puntos de muestreo</label>
                                <div class="puntos-toolbar">
                                    <input type="text" id="formPuntosSearch" class="puntos-search-input" placeholder="Buscar por código o lugar..." oninput="setFiltroPuntos(this.value)">
                                </div>
                                <div class="puntos-selection-info" id="formPuntosInfo">0 seleccionados</div>
                                <div class="puntos-check-list modern" id="formPuntosChecklist"></div>
                                <div class="field-help">Los estratos y réplicas se tomarán desde cada punto del proyecto.</div>
                            </div>
                        </div>

                        <button type="button" class="btn-agregar-muestras" onclick="agregarPuntosDesdeForm()">Agregar muestras seleccionadas</button>
                    </div>
                </div>

                <!-- Listado compacto -->
                <div class="puntos-list-header">
                    <span class="panel-section-title">Puntos asignados</span>
                    <span class="puntos-list-count" id="puntosAsignadosCount">0 puntos</span>
                </div>
                <div id="puntosListContainer">
                    <div class="puntos-empty-msg">Sin puntos asignados</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="panel-footer">
            <div class="panel-footer-left">
                <button class="btn-panel btn-panel-secondary" onclick="cerrarPanelOI()">Cancelar</button>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-panel btn-panel-secondary" id="btnPasoAnterior" onclick="irPasoOI(1)" style="display:none;">Anterior</button>
                <button class="btn-panel btn-panel-primary" id="btnPasoSiguiente" onclick="irPasoOI(2)">Siguiente</button>
                <button class="btn-panel btn-panel-success" id="btnCrearOI" onclick="crearOI()" style="display:none;">Crear OI</button>
                <button class="btn-panel btn-panel-primary" id="btnCambiarEdicionOI" onclick="activarEdicionDesdeLectura()" style="display:none;">Editar OI</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Datos maestros: Clientes con sus OLs
        const clientes = [
            { nombre: 'Corp Nacional del Cobre de Chile', ols: ['800504', '800505', '800510', '800520'] },
            { nombre: 'Engie Energía Chile', ols: ['800612', '800615'] },
            { nombre: 'Minera Los Andes SpA', ols: ['800701', '800702'] },
            { nombre: 'Lundin Mining', ols: ['800389', '800390', '800391'] },
            { nombre: 'BHP Billiton', ols: ['800800', '800801', '800802', '800810'] },
            { nombre: 'Antofagasta Minerals', ols: ['800900', '800905'] },
            { nombre: 'Teck Resources', ols: ['801000', '801001'] }
        ];

        // Datos maestros: Responsables
        const responsables = [
            'Viviana López', 'Carlos Mendoza', 'María González', 'Pedro Sánchez',
            'Ana Rodríguez', 'Jorge Alegría', 'Yessenia Gajardo', 'Cynthia Ocaranza'
        ];

        let proyectoGuardado = false;
        let modoEdicion = false;

        // Verificar si venimos con datos de un proyecto existente (editar)
        const urlParams = new URLSearchParams(window.location.search);
        const proyectoCodigo = urlParams.get('proyecto');
        const proyectoClienteParam = urlParams.get('cliente');
        const proyectoOLParam = urlParams.get('ol');
        const proyectoResponsableParam = urlParams.get('responsable');
        const proyectoNombreParam = urlParams.get('nombre');
        const proyectoTabParam = urlParams.get('tab');

        // ==========================================
        // Inicialización de combos
        // ==========================================
        function poblarComboClientes() {
            const select = document.getElementById('inputCliente');
            select.innerHTML = '<option value="">Seleccione cliente...</option>';
            clientes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.nombre;
                opt.textContent = c.nombre;
                select.appendChild(opt);
            });
        }

        function poblarComboOLs(clienteNombre) {
            const select = document.getElementById('inputOL');
            if (!clienteNombre) {
                select.innerHTML = '<option value="">Seleccione cliente primero...</option>';
                select.disabled = true;
                return;
            }
            const cliente = clientes.find(c => c.nombre === clienteNombre);
            if (!cliente || cliente.ols.length === 0) {
                select.innerHTML = '<option value="">Sin OLs disponibles</option>';
                select.disabled = true;
                return;
            }
            select.disabled = false;
            select.innerHTML = '<option value="">Seleccione OL...</option>';
            cliente.ols.forEach(ol => {
                const opt = document.createElement('option');
                opt.value = ol;
                opt.textContent = ol;
                select.appendChild(opt);
            });
        }

        function poblarComboResponsables() {
            const select = document.getElementById('inputResponsable');
            select.innerHTML = '<option value="">Seleccione responsable...</option>';
            responsables.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                select.appendChild(opt);
            });
        }

        // Inicializar
        poblarComboClientes();
        poblarComboResponsables();
        precargarProyectoDesdeURL();

        function precargarProyectoDesdeURL() {
            if (!proyectoCodigo && !proyectoClienteParam && !proyectoOLParam) return;

            const clienteSel = document.getElementById('inputCliente');
            const olSel = document.getElementById('inputOL');
            const respSel = document.getElementById('inputResponsable');
            const nombreInp = document.getElementById('inputNombre');
            const codigoInp = document.getElementById('inputCodigo');

            if (proyectoClienteParam) {
                clienteSel.value = proyectoClienteParam;
                poblarComboOLs(proyectoClienteParam);
            } else if (proyectoOLParam) {
                // fallback: resolver cliente por OL si no viene cliente
                const clienteByOL = clientes.find(c => c.ols.includes(proyectoOLParam));
                if (clienteByOL) {
                    clienteSel.value = clienteByOL.nombre;
                    poblarComboOLs(clienteByOL.nombre);
                }
            }

            if (proyectoOLParam) olSel.value = proyectoOLParam;
            if (proyectoResponsableParam) respSel.value = proyectoResponsableParam;
            if (proyectoNombreParam) nombreInp.value = proyectoNombreParam;
            if (proyectoCodigo) codigoInp.value = proyectoCodigo;

            modoEdicion = true;
            document.getElementById('headerTitle').textContent = 'Ficha Proyecto';
            document.getElementById('btnGuardar').textContent = 'Guardar Cambios';
            actualizarHeader();
        }

        // ==========================================
        // Actualizar header en tiempo real
        // ==========================================
        document.getElementById('inputCliente').addEventListener('change', function() {
            poblarComboOLs(this.value);
            actualizarHeader();
        });

        document.getElementById('inputOL').addEventListener('change', actualizarHeader);
        document.getElementById('inputNombre').addEventListener('input', actualizarHeader);

        function actualizarHeader() {
            const cliente = document.getElementById('inputCliente').value;
            const ol = document.getElementById('inputOL').value;
            const nombre = document.getElementById('inputNombre').value.trim();

            const elCliente = document.getElementById('headerCliente');
            const elOL = document.getElementById('headerOL');
            const elProyecto = document.getElementById('headerProyecto');

            if (cliente) {
                elCliente.textContent = cliente;
                elCliente.classList.remove('empty');
            } else {
                elCliente.textContent = 'Sin definir';
                elCliente.classList.add('empty');
            }

            if (ol) {
                elOL.textContent = ol;
                elOL.classList.remove('empty');
            } else {
                elOL.textContent = '-';
                elOL.classList.add('empty');
            }

            if (nombre) {
                elProyecto.textContent = nombre;
                elProyecto.classList.remove('empty');
            } else {
                elProyecto.textContent = '-';
                elProyecto.classList.add('empty');
            }
        }

        // ==========================================
        // Tabs
        // ==========================================
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                if (!tabId) return;
                activarTab(tabId);
            });
        });

        function activarTab(tabId) {
            const btn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            const content = document.getElementById('tab-' + tabId);
            if (!btn || !content) return;
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            content.classList.add('active');
            actualizarBotonNuevaOITabs(tabId);
        }

        function actualizarBotonNuevaOITabs(tabId) {
            const btn = document.getElementById('btnNuevaOITabs');
            if (!btn) return;
            btn.style.display = (tabId === 'listado-oi' || tabId === 'calendario') ? 'inline-block' : 'none';
            if (tabId !== 'calendario' && assignmentMode) cancelBatchAssign();
        }

        // ==========================================
        // Guardar proyecto
        // ==========================================
        function guardarProyecto() {
            const cliente = document.getElementById('inputCliente').value;
            const ol = document.getElementById('inputOL').value;
            const nombre = document.getElementById('inputNombre').value.trim();
            const codigo = document.getElementById('inputCodigo').value.trim();
            const responsable = document.getElementById('inputResponsable').value;
            const descripcion = document.getElementById('inputDescripcion').value.trim();

            if (!cliente) {
                alert('Por favor seleccione un cliente');
                return;
            }
            if (!ol) {
                alert('Por favor seleccione una OL');
                return;
            }
            if (!nombre) {
                alert('Por favor ingrese el nombre del proyecto');
                return;
            }
            if (!codigo) {
                alert('Por favor ingrese el código del proyecto');
                return;
            }

            proyectoGuardado = true;

            // Actualizar header
            document.getElementById('headerTitle').textContent = nombre;
            actualizarHeader();

            // Actualizar estado
            const badge = document.getElementById('estadoBadge');
            badge.className = 'estado-proyecto estado-sin-iniciar';
            badge.innerHTML = '<span class="estado-dot"></span>Sin iniciar';

            // Habilitar tabs
            document.getElementById('tabListadoOI').classList.remove('disabled');
            document.getElementById('tabCalendario').classList.remove('disabled');

            // Cambiar botón
            document.getElementById('btnGuardar').textContent = 'Guardar Cambios';

            mostrarToast(`Proyecto "${nombre}" creado exitosamente`);
        }

        // ==========================================
        // Limpiar formulario
        // ==========================================
        function limpiarFormulario() {
            document.getElementById('inputCliente').value = '';
            poblarComboOLs('');
            document.getElementById('inputNombre').value = '';
            document.getElementById('inputCodigo').value = '';
            document.getElementById('inputResponsable').value = '';
            document.getElementById('inputDescripcion').value = '';
            actualizarHeader();
        }

        // ==========================================
        // Toast
        // ==========================================
        function mostrarToast(mensaje) {
            const toast = document.getElementById('toast');
            toast.textContent = mensaje;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==========================================
        // PUNTOS DE MUESTREO
        // ==========================================
        const puntosMuestreo = [
            { estacion: 'EST-01', lugar: 'Descarga principal', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4569', longitud: '-70.6483', estratos: 3, replicas: 2, muestras: 1 },
            { estacion: 'EST-02', lugar: 'Canal norte', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4574', longitud: '-70.6472', estratos: 2, replicas: 2, muestras: 1 },
            { estacion: 'EST-03', lugar: 'Canal sur', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4581', longitud: '-70.6490', estratos: 1, replicas: 1, muestras: 1 },
            { estacion: 'EST-04', lugar: 'Poza decantación', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4592', longitud: '-70.6466', estratos: 2, replicas: 1, muestras: 1 },
            { estacion: 'EST-05', lugar: 'Bocatoma este', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4600', longitud: '-70.6454', estratos: 3, replicas: 1, muestras: 1 },
            { estacion: 'EST-06', lugar: 'Bocatoma oeste', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4614', longitud: '-70.6443', estratos: 2, replicas: 2, muestras: 1 },
            { estacion: 'EST-07', lugar: 'Quebrada interna', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4622', longitud: '-70.6432', estratos: 1, replicas: 2, muestras: 1 },
            { estacion: 'EST-08', lugar: 'Vertedero secundario', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4633', longitud: '-70.6421', estratos: 3, replicas: 1, muestras: 1 },
            { estacion: 'EST-09', lugar: 'Punto puente', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4641', longitud: '-70.6410', estratos: 2, replicas: 1, muestras: 1 },
            { estacion: 'EST-10', lugar: 'Salida planta', matriz: 'AGUA_SUPERFICIAL', latitud: '-33.4650', longitud: '-70.6398', estratos: 1, replicas: 3, muestras: 1 },
            { estacion: 'EST-11', lugar: 'Aguas arriba control 1', matriz: 'AGUA_MAR', latitud: '-33.4512', longitud: '-70.6501', estratos: 1, replicas: 1, muestras: 1 },
            { estacion: 'EST-12', lugar: 'Aguas arriba control 2', matriz: 'AGUA_MAR', latitud: '-33.4503', longitud: '-70.6515', estratos: 2, replicas: 1, muestras: 1 },
            { estacion: 'EST-13', lugar: 'Rompeolas norte', matriz: 'AGUA_MAR', latitud: '-33.4495', longitud: '-70.6526', estratos: 3, replicas: 1, muestras: 1 },
            { estacion: 'EST-14', lugar: 'Rompeolas sur', matriz: 'AGUA_MAR', latitud: '-33.4487', longitud: '-70.6538', estratos: 2, replicas: 2, muestras: 1 },
            { estacion: 'EST-15', lugar: 'Boyarín central', matriz: 'AGUA_MAR', latitud: '-33.4478', longitud: '-70.6550', estratos: 1, replicas: 2, muestras: 1 },
            { estacion: 'EST-16', lugar: 'Canal de navegación', matriz: 'AGUA_MAR', latitud: '-33.4470', longitud: '-70.6561', estratos: 2, replicas: 1, muestras: 1 },
            { estacion: 'EST-17', lugar: 'Frente terminal', matriz: 'AGUA_MAR', latitud: '-33.4462', longitud: '-70.6573', estratos: 3, replicas: 2, muestras: 1 },
            { estacion: 'EST-18', lugar: 'Zona fondeo', matriz: 'AGUA_MAR', latitud: '-33.4454', longitud: '-70.6584', estratos: 1, replicas: 1, muestras: 1 },
            { estacion: 'EST-19', lugar: 'Exterior bahía', matriz: 'AGUA_MAR', latitud: '-33.4446', longitud: '-70.6596', estratos: 2, replicas: 3, muestras: 1 },
            { estacion: 'EST-20', lugar: 'Control referencia costa', matriz: 'AGUA_MAR', latitud: '-33.4438', longitud: '-70.6608', estratos: 3, replicas: 1, muestras: 1 }
        ];

        function renderPuntos() {
            const tbody = document.getElementById('tbodyPuntos');
            const emptyMsg = document.getElementById('emptyPuntosMsg');
            const table = document.getElementById('tablaPuntos');

            if (puntosMuestreo.length === 0) {
                emptyMsg.style.display = 'block';
                table.style.display = 'none';
            } else {
                emptyMsg.style.display = 'none';
                table.style.display = 'table';
                tbody.innerHTML = puntosMuestreo.map((p, i) => `
                    <tr>
                        <td class="col-num">${i + 1}</td>
                        <td>${p.estacion}</td>
                        <td>${p.lugar}</td>
                        <td>${p.matriz}</td>
                        <td>${p.latitud || '-'}</td>
                        <td>${p.longitud || '-'}</td>
                        <td class="col-input"><input type="number" value="${p.estratos}" min="1" onchange="actualizarPuntoCampo(${i}, 'estratos', this.value)"></td>
                        <td class="col-input"><input type="number" value="${p.replicas}" min="1" onchange="actualizarPuntoCampo(${i}, 'replicas', this.value)"></td>
                        <td class="col-input" style="font-weight:600; text-align:center;">${p.estratos * p.replicas}</td>
                        <td class="col-action"><button class="btn-delete-row" onclick="eliminarPunto(${i})">✕</button></td>
                    </tr>
                `).join('');
            }

        }

        function actualizarPuntoCampo(idx, campo, valor) {
            puntosMuestreo[idx][campo] = parseInt(valor) || 1;
            renderPuntos();
        }

        function abrirModalPunto() {
            document.getElementById('newMatriz').value = '';
            document.getElementById('newLugar').value = '';
            document.getElementById('newEstacion').value = '';
            document.getElementById('newLatitud').value = '';
            document.getElementById('newLongitud').value = '';
            document.getElementById('modalPunto').classList.add('show');
        }

        function cerrarModalPunto() {
            document.getElementById('modalPunto').classList.remove('show');
        }

        function agregarPunto() {
            const matriz = document.getElementById('newMatriz').value;
            const lugar = document.getElementById('newLugar').value.trim();
            const estacion = document.getElementById('newEstacion').value.trim();
            const latitud = document.getElementById('newLatitud').value.trim();
            const longitud = document.getElementById('newLongitud').value.trim();

            if (!matriz) { alert('Seleccione una matriz'); return; }
            if (!lugar) { alert('Ingrese el lugar de monitoreo'); return; }
            if (!estacion) { alert('Ingrese el nombre del punto'); return; }

            puntosMuestreo.push({
                estacion,
                lugar,
                matriz,
                latitud,
                longitud,
                estratos: 1,
                replicas: 1,
                muestras: 1
            });

            cerrarModalPunto();
            renderPuntos();
            mostrarToast(`Punto "${estacion}" agregado`);
        }

        function eliminarPunto(idx) {
            const nombre = puntosMuestreo[idx].estacion;
            puntosMuestreo.splice(idx, 1);
            renderPuntos();
            mostrarToast(`Punto "${nombre}" eliminado`);
        }

        // Renderizar puntos al inicio
        renderPuntos();

        // ==========================================
        // LISTADO OI
        // ==========================================
        const laboratorios = ['SGS Antofagasta', 'SGS Santiago', 'SGS Concepción', 'SGS Lima', 'SGS Calama'];
        const planesDisponibles = ['PLAN-001', 'PLAN-002', 'PLAN-003', 'PLAN-004', 'PLAN-005'];
        const planesPorMatriz = {
            'AGUA_SUPERFICIAL': ['PLAN-001', 'PLAN-004'],
            'AGUA_MAR': ['PLAN-002', 'PLAN-003', 'PLAN-005']
        };
        const telefonosContacto = {
            'Viviana López': '+56 9 8765 4321',
            'Carlos Mendoza': '+56 9 7654 3210',
            'María González': '+56 9 6543 2109',
            'Pedro Sánchez': '+56 9 5432 1098',
            'Ana Rodríguez': '+56 9 4321 0987',
            'Jorge Alegría': '+56 9 3210 9876',
            'Yessenia Gajardo': '+56 9 2109 8765',
            'Cynthia Ocaranza': '+56 9 1098 7654'
        };
        const correosContacto = {
            'Viviana López': 'vlopez@sgs.com',
            'Carlos Mendoza': 'cmendoza@sgs.com',
            'María González': 'mgonzalez@sgs.com',
            'Pedro Sánchez': 'psanchez@sgs.com',
            'Ana Rodríguez': 'arodriguez@sgs.com',
            'Jorge Alegría': 'jalegria@sgs.com',
            'Yessenia Gajardo': 'ygajardo@sgs.com',
            'Cynthia Ocaranza': 'cocaranza@sgs.com'
        };
        const rutTitularPorCliente = {
            'Corp Nacional del Cobre de Chile': '61.704.000-K',
            'Engie Energía Chile': '96.988.310-9',
            'Minera Los Andes SpA': '76.003.885-7',
            'Lundin Mining': '76.214.332-1',
            'BHP Billiton': '96.636.520-7',
            'Antofagasta Minerals': '96.790.240-3',
            'Teck Resources': '96.846.530-9'
        };
        const rutRrllPorContacto = {
            'Viviana López': '16.905.805-9',
            'Carlos Mendoza': '15.102.334-6',
            'María González': '14.331.887-2',
            'Pedro Sánchez': '12.889.451-0',
            'Ana Rodríguez': '17.220.118-4',
            'Jorge Alegría': '13.443.992-1',
            'Yessenia Gajardo': '18.332.777-5',
            'Cynthia Ocaranza': '19.551.802-3'
        };

        const OI_STATE_STORAGE_KEY = 'sgs_fp_ordenes_v1';
        const LAB_NAV_STORAGE_KEY = 'sgs_lab_nav_v1';

        let ordenesInspeccion = [
            {
                codigo: 'OI-2026-001', fecha: '2026-02-15', tipo: 'muestreo_medicion', composicion: 'puntual', estado: 'programada',
                puntos: [
                    { punto: 'EST-01', matriz: 'AGUA_SUPERFICIAL', plan: 'PLAN-001', estratos: ['S', 'M'], replicas: 2, etfa: true, laboratorio: 'SGS Antofagasta' },
                    { punto: 'EST-02', matriz: 'AGUA_MAR', plan: 'PLAN-002', estratos: ['S'], replicas: 1, etfa: false, laboratorio: 'SGS Antofagasta' }
                ],
                usuarios: [
                    { rol: 'Coordinador', nombre: 'Romina Gonzalez Lopez', tipo: 'coordinador' },
                    { rol: 'Supervisor', nombre: 'Jorge Alegría', tipo: 'supervisor' },
                    { rol: 'Inspector', nombre: 'Carlos Mendoza', tipo: 'inspector' }
                ]
            },
            {
                codigo: 'OI-2026-002', fecha: '2026-02-18', tipo: 'muestreo_medicion', composicion: 'compuesta', estado: 'pendiente',
                puntos: [
                    { punto: 'EST-01', matriz: 'AGUA_SUPERFICIAL', plan: 'PLAN-001', estratos: ['S', 'M', 'F'], replicas: 1, etfa: true, laboratorio: 'SGS Santiago' }
                ],
                usuarios: [
                    { rol: 'Coordinador', nombre: 'Viviana López', tipo: 'coordinador' },
                    { rol: 'Supervisor', nombre: 'Ana Rodríguez', tipo: 'supervisor' },
                    { rol: 'Inspector', nombre: 'Carlos Mendoza', tipo: 'inspector' }
                ]
            },
            {
                codigo: 'OI-2026-003', fecha: '2026-01-10', tipo: 'medicion', composicion: 'puntual', estado: 'ejecutada',
                puntos: [
                    { punto: 'EST-02', matriz: 'AGUA_MAR', plan: 'PLAN-003', estratos: ['S'], replicas: 3, etfa: false, laboratorio: 'SGS Calama' }
                ],
                usuarios: [
                    { rol: 'Coordinador', nombre: 'María González', tipo: 'coordinador' },
                    { rol: 'Supervisor', nombre: 'Jorge Alegría', tipo: 'supervisor' },
                    { rol: 'Inspector', nombre: 'Pedro Sánchez', tipo: 'inspector' }
                ]
            }
        ];

        const oiEstadoLabels = { 'pendiente': 'Pendiente', 'programada': 'Programada', 'ejecutada': 'Ejecutada', 'cancelada': 'Cancelada' };
        const oiTipoLabels = { 'muestreo_medicion': 'Muestreo y Medición', 'medicion': 'Solo Medición' };
        const oiComposicionLabels = { 'puntual': 'Puntual', 'compuesta': 'Compuesta' };

        function saveOIStateToStorage() {
            try {
                sessionStorage.setItem(OI_STATE_STORAGE_KEY, JSON.stringify(ordenesInspeccion));
            } catch (e) {
                // noop
            }
        }

        function loadOIStateFromStorage() {
            try {
                const raw = sessionStorage.getItem(OI_STATE_STORAGE_KEY);
                if (!raw) return;
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return;
                ordenesInspeccion = parsed;
            } catch (e) {
                // noop
            }
        }

        function abrirPaginaLaboratorio(idx) {
            const oi = ordenesInspeccion[idx];
            if (!oi) return;

            saveOIStateToStorage();
            try {
                const navPayload = {
                    oiIdx: idx,
                    from: 'ficha-proyecto-inicial.html',
                    tab: 'listado-oi',
                    proyecto: {
                        proyecto: document.getElementById('inputCodigo').value || proyectoCodigo || '',
                        cliente: document.getElementById('inputCliente').value || proyectoClienteParam || '',
                        ol: document.getElementById('inputOL').value || proyectoOLParam || '',
                        responsable: document.getElementById('inputResponsable').value || proyectoResponsableParam || '',
                        nombre: document.getElementById('inputNombre').value || proyectoNombreParam || ''
                    }
                };
                sessionStorage.setItem(LAB_NAV_STORAGE_KEY, JSON.stringify(navPayload));
            } catch (e) {
                // noop
            }

            window.location.href = `envio-muestras-laboratorio.html?oi=${idx}`;
        }

        let expandedOIs = {};
        let assignmentMode = false;
        let assignmentInspectorId = null;
        let assignmentSelectedOIs = new Set();
        let assignmentAction = 'assign';

        loadOIStateFromStorage();

        function renderOIs(filtro = '') {
            const cardsContainer = document.getElementById('oiCardsContainer');
            const emptyMsg = document.getElementById('emptyOIMsg');
            const countInfo = document.getElementById('oiCountInfo');

            saveOIStateToStorage();

            const filtroLower = filtro.toLowerCase();
            const oiFiltradas = ordenesInspeccion.filter(oi => {
                if (!filtro) return true;
                return oi.codigo.toLowerCase().includes(filtroLower)
                    || oi.estado.toLowerCase().includes(filtroLower)
                    || (oiTipoLabels[oi.tipo] || '').toLowerCase().includes(filtroLower)
                    || oi.puntos.some(p => p.punto.toLowerCase().includes(filtroLower) || p.matriz.toLowerCase().includes(filtroLower));
            });

            countInfo.textContent = `(${ordenesInspeccion.length} total)`;

            if (oiFiltradas.length === 0) {
                emptyMsg.style.display = 'block';
                cardsContainer.style.display = 'none';
                emptyMsg.textContent = filtro ? 'No se encontraron OIs con ese criterio' : 'No hay órdenes de inspección creadas';
            } else {
                emptyMsg.style.display = 'none';
                cardsContainer.style.display = 'grid';
                let html = '';
                oiFiltradas.forEach((oi, i) => {
                    const idxReal = ordenesInspeccion.indexOf(oi);
                    const fechaFmt = oi.fecha ? formatearFecha(oi.fecha) : '-';
                    const inspectores = (oi.usuarios || [])
                        .filter(u => u.tipo === 'inspector' || /inspector/i.test(u.rol || ''))
                        .map(u => u.nombre);
                    const inspectoresTxt = inspectores.length ? inspectores.join(', ') : 'Sin asignar';
                    const supervisores = (oi.usuarios || [])
                        .filter(u => u.tipo === 'supervisor' || /supervisor/i.test(u.rol || ''))
                        .map(u => u.nombre);
                    const supervisoresTxt = supervisores.length ? supervisores.join(', ') : 'Sin asignar';
                    const tipoTxt = oiTipoLabels[oi.tipo] || '-';
                    const composicionTxt = oiComposicionLabels[oi.composicion] || 'Puntual';
                    const estadoTxt = oiEstadoLabels[oi.estado] || oi.estado || '-';
                    const matrizTxt = oi.matriz || (oi.puntos[0] && oi.puntos[0].matriz) || '-';
                    const planes = Array.from(new Set((oi.puntos || []).map(p => p.plan).filter(Boolean)));
                    const planTxt = oi.plan || (planes.length > 1 ? 'Mixto' : (planes[0] || '-'));
                    const laboratoriosOi = Array.from(new Set((oi.puntos || []).map(p => p.laboratorio).filter(Boolean)));
                    const laboratorioTxt = laboratoriosOi.length > 1 ? 'Mixto' : (laboratoriosOi[0] || '-');
                    const etfaActivo = (oi.puntos || []).some(p => !!p.etfa);
                    const etfaTxt = etfaActivo ? 'ETFA' : 'No ETFA';
                    const tipoIcon = oi.tipo === 'medicion'
                        ? '<i class="fa-solid fa-chart-line"></i>'
                        : '<i class="fa-solid fa-vial-circle-check"></i>';

                    html += `<div class="oi-card">
                        <div class="oi-card-head">
                            <div class="oi-card-id">
                                <span class="oi-card-code">${oi.codigo}</span>
                                <span class="oi-pill">${tipoIcon}${tipoTxt}</span>
                                <span class="oi-pill">${composicionTxt}</span>
                                <span class="oi-pill ${etfaActivo ? '' : 'muted'}">${etfaTxt}</span>
                                <span class="oi-pill muted">${estadoTxt}</span>
                            </div>
                            <div class="oi-card-actions">
                                <div class="oi-options-wrap">
                                    <button class="oi-options-btn" onclick="toggleOiOptions(${idxReal}, event)">
                                        Opciones <span>▾</span>
                                    </button>
                                    <div class="oi-options-menu" id="oiOptionsMenu-${idxReal}">
                                        <button class="oi-options-item" onclick="verOI(${idxReal}); closeAllOiOptions();">Ver</button>
                                        <button class="oi-options-item" onclick="editarOI(${idxReal}); closeAllOiOptions();">Editar</button>
                                        <button class="oi-options-item" onclick="abrirPaginaLaboratorio(${idxReal}); closeAllOiOptions();">Enviar a laboratorio</button>
                                        <button class="oi-options-item delete" onclick="eliminarOI(${idxReal}); closeAllOiOptions();">Eliminar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="oi-card-line">
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-calendar-check"></i></span><span class="k">Recepción:</span> <span class="v">${fechaFmt}</span></span>
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-layer-group"></i></span><span class="k">Matriz:</span> <span class="v">${matrizTxt}</span></span>
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-flask-vial"></i></span><span class="k">Laboratorio:</span> <span class="v">${laboratorioTxt}</span></span>
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-clipboard-list"></i></span><span class="k">Plan:</span> <span class="v">${planTxt}</span></span>
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-user-gear"></i></span><span class="k">Supervisor:</span> <span class="v">${supervisoresTxt}</span></span>
                            <span class="oi-info-item"><span class="oi-info-icon"><i class="fa-solid fa-user-tie"></i></span><span class="k">Inspector:</span> <span class="v">${inspectoresTxt}</span></span>
                        </div>`;
                    html += `</div>`;
                });
                cardsContainer.innerHTML = html;
            }
        }

        function closeAllOiOptions() {
            document.querySelectorAll('.oi-options-menu.show').forEach(menu => menu.classList.remove('show'));
        }

        function toggleOiOptions(idx, event) {
            if (event) event.stopPropagation();
            const menu = document.getElementById(`oiOptionsMenu-${idx}`);
            if (!menu) return;
            const willShow = !menu.classList.contains('show');
            closeAllOiOptions();
            menu.classList.toggle('show', willShow);
        }

        function formatearFecha(fechaStr) {
            const [y, m, d] = fechaStr.split('-');
            return `${d}/${m}/${y}`;
        }

        document.getElementById('oiSearch').addEventListener('input', function() {
            renderOIs(this.value);
        });

        // ==========================================
        // PANEL LATERAL OI
        // ==========================================
        let editandoOIIdx = -1;
        let oiPanelPuntos = [];
        let recurrenciaFreq = 'diario';
        let oiTipoActual = 'muestreo_medicion';
        let oiComposicionActual = 'puntual';
        let oiEstadoActual = 'pendiente';
        let pasoActual = 1;
        let oiUsuariosActuales = [];
        let panelOIReadOnly = false;

        function formatearFechaDisplay(fechaISO) {
            if (!fechaISO) return 'Pendiente';
            const [y, m, d] = fechaISO.split('-');
            return `${d}-${m}-${y}`;
        }

        function obtenerUsuariosDefaultOI() {
            const coordinador = document.getElementById('inputResponsable').value || 'Romina Gonzalez Lopez';
            return [
                { rol: 'Coordinador', nombre: coordinador, tipo: 'coordinador' },
                { rol: 'Supervisor', nombre: 'Jorge Alegría', tipo: 'supervisor' }
            ];
        }

        function renderUsuariosOI() {
            const container = document.getElementById('oiUsuariosDatosList');
            if (!container) return;
            const usuarios = (oiUsuariosActuales && oiUsuariosActuales.length) ? oiUsuariosActuales : obtenerUsuariosDefaultOI();
            const canRemoveInspector = !panelOIReadOnly && editandoOIIdx >= 0;
            container.innerHTML = usuarios.map(u => `
                <span class="oi-usuario-chip ${u.tipo || ''}">
                    <span class="dot"></span>
                    ${u.rol}: ${u.nombre}
                    ${canRemoveInspector && (u.tipo === 'inspector' || /inspector/i.test(u.rol || ''))
                        ? `<button type="button" class="oi-usuario-remove" onclick="quitarInspectorOI('${String(u.nombre).replace(/'/g, "\\'")}')" title="Quitar inspector">✕</button>`
                        : ''}
                </span>
            `).join('');
        }

        function quitarInspectorOI(nombreInspector) {
            if (panelOIReadOnly || editandoOIIdx < 0) return;
            oiUsuariosActuales = (oiUsuariosActuales || []).filter(u =>
                !((u.tipo === 'inspector' || /inspector/i.test(u.rol || '')) && u.nombre === nombreInspector)
            );
            renderUsuariosOI();
            mostrarToast(`Inspector "${nombreInspector}" removido de la OI`);
        }

        function actualizarCabeceraOI() {
            const cliente = document.getElementById('inputCliente').value || 'Cliente no seleccionado';
            const ol = document.getElementById('inputOL').value || '-';
            const contacto = document.getElementById('inputResponsable').value || 'Sin contacto';
            const telefono = telefonosContacto[contacto] || '+56 9 0000 0000';
            const fecha = document.getElementById('newOIFecha').value;
            const codigo = editandoOIIdx >= 0 ? (ordenesInspeccion[editandoOIIdx].codigo || '-') : 'Nueva';
            const estadoLabel = oiEstadoLabels[oiEstadoActual] || 'Pendiente';
            const tipoLabel = oiTipoLabels[oiTipoActual] || 'Muestreo y Medición';
            const composicionLabel = oiComposicionLabels[oiComposicionActual] || 'Puntual';

            const elCliente = document.getElementById('oiResumenCliente');
            const elOlOi = document.getElementById('oiResumenOlOi');
            const elFecha = document.getElementById('oiResumenFecha');
            const elContacto = document.getElementById('oiResumenContacto');
            const elTelefono = document.getElementById('oiResumenTelefono');
            const elEstado = document.getElementById('oiResumenEstado');
            const elTipoBadge = document.getElementById('oiResumenTipoBadge');
            const elComposicionBadge = document.getElementById('oiResumenComposicionBadge');

            if (elCliente) elCliente.textContent = cliente;
            if (elOlOi) elOlOi.textContent = `OL: ${ol} / OI: ${codigo}`;
            if (elFecha) elFecha.textContent = formatearFechaDisplay(fecha);
            if (elContacto) elContacto.textContent = contacto;
            if (elTelefono) elTelefono.textContent = telefono;
            if (elTipoBadge) elTipoBadge.textContent = tipoLabel;
            if (elComposicionBadge) elComposicionBadge.textContent = composicionLabel;
            if (elEstado) {
                elEstado.textContent = estadoLabel;
                elEstado.className = `oi-estado-badge oi-estado-${oiEstadoActual}`;
            }
        }

        function aplicarModoPanelOI() {
            const panel = document.getElementById('panelOI');
            if (!panel) return;
            const panelSteps = panel.querySelector('.panel-steps');
            const stepContents = panel.querySelectorAll('.panel-step-content');

            // Campos del panel en read-only
            panel.querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = panelOIReadOnly;
            });
            panel.querySelectorAll('#typeToggle button, #composicionToggle button, #freqToggle button').forEach(btn => {
                btn.disabled = panelOIReadOnly;
            });

            const btnAbrirMuestras = document.getElementById('btnAbrirFormMuestras');
            if (panelOIReadOnly) toggleAddMuestrasForm(false);
            if (btnAbrirMuestras) btnAbrirMuestras.style.display = panelOIReadOnly ? 'none' : 'flex';
            const btnAgregarMuestras = document.querySelector('#addMuestrasForm .btn-agregar-muestras');
            if (btnAgregarMuestras) btnAgregarMuestras.style.display = panelOIReadOnly ? 'none' : 'block';

            // Ocultar botón de guardado en modo lectura
            const btnCrear = document.getElementById('btnCrearOI');
            if (btnCrear) btnCrear.style.display = panelOIReadOnly ? 'none' : (pasoActual === 2 ? 'inline-block' : 'none');

            const btnSig = document.getElementById('btnPasoSiguiente');
            if (btnSig) btnSig.style.display = panelOIReadOnly ? 'none' : (pasoActual < 2 ? 'inline-block' : 'none');
            const btnAnt = document.getElementById('btnPasoAnterior');
            if (btnAnt) btnAnt.style.display = panelOIReadOnly ? 'none' : (pasoActual > 1 ? 'inline-block' : 'none');
            const btnCambiarEdicion = document.getElementById('btnCambiarEdicionOI');
            if (btnCambiarEdicion) btnCambiarEdicion.style.display = panelOIReadOnly ? 'inline-block' : 'none';
            const fechaGroup = document.getElementById('oiFechaGroup');
            const tipoGroup = document.getElementById('oiTipoGroup');
            const composicionGroup = document.getElementById('oiComposicionGroup');
            const tipoWrap = document.getElementById('oiResumenTipoWrap');
            if (fechaGroup) fechaGroup.style.display = panelOIReadOnly ? 'none' : '';
            if (tipoGroup) tipoGroup.style.display = panelOIReadOnly ? 'none' : '';
            if (composicionGroup) composicionGroup.style.display = panelOIReadOnly ? 'none' : '';
            if (tipoWrap) tipoWrap.style.display = panelOIReadOnly ? 'block' : 'none';

            if (panelSteps) panelSteps.style.display = panelOIReadOnly ? 'none' : 'flex';
            if (panelOIReadOnly) {
                panel.classList.add('view-unified');
                stepContents.forEach(c => c.classList.add('active'));
            } else {
                panel.classList.remove('view-unified');
            }

            renderOIPanelPuntos();
        }

        function activarEdicionDesdeLectura() {
            if (editandoOIIdx < 0) return;
            panelOIReadOnly = false;
            pasoActual = 1;
            document.getElementById('panelOITitle').textContent = 'Editar Orden de Inspección';
            document.getElementById('btnCrearOI').textContent = 'Guardar Cambios';
            actualizarVisibilidadRecurrencia(false);
            renderUsuariosOI();
            actualizarPasoUI();
            aplicarModoPanelOI();
        }

        function actualizarVisibilidadRecurrencia(esNuevaOI) {
            const recurrenceToggle = document.getElementById('recurrenceToggleRow');
            const recurrenceSection = document.getElementById('recurrenciaSection');
            const recurrenceCheck = document.getElementById('chkRecurrencia');

            if (!recurrenceToggle || !recurrenceSection || !recurrenceCheck) return;

            recurrenceToggle.style.display = esNuevaOI ? 'flex' : 'none';
            if (!esNuevaOI) {
                recurrenceCheck.checked = false;
                recurrenceSection.classList.remove('show');
            }
        }

        function abrirPanelOI() {
            editandoOIIdx = -1;
            pasoActual = 1;
            oiTipoActual = 'muestreo_medicion';
            oiComposicionActual = 'puntual';
            oiEstadoActual = 'pendiente';
            panelOIReadOnly = false;
            actualizarVisibilidadRecurrencia(true);
            oiUsuariosActuales = obtenerUsuariosDefaultOI();
            document.getElementById('newOIFecha').value = '';
            document.getElementById('oiMatriz').value = '';
            document.getElementById('oiPlan').value = '';
            document.getElementById('chkRecurrencia').checked = false;
            document.getElementById('recurrenciaSection').classList.remove('show');

            // Reset type toggle
            document.querySelectorAll('#typeToggle button').forEach(b => b.classList.remove('active'));
            document.querySelector('#typeToggle button:first-child').classList.add('active');
            document.querySelectorAll('#composicionToggle button').forEach(b => b.classList.remove('active'));
            document.querySelector('#composicionToggle button:first-child').classList.add('active');

            // Reset freq
            document.querySelectorAll('#freqToggle button').forEach(b => b.classList.remove('active'));
            document.querySelector('#freqToggle button:first-child').classList.add('active');
            recurrenciaFreq = 'diario';
            document.getElementById('freqDescription').textContent = 'Se programará todos los días';
            document.getElementById('weekDays').style.display = 'none';
            document.getElementById('intervalRow').style.display = 'none';
            document.getElementById('endDate').value = '';
            document.getElementById('endOcurrencias').value = '5';
            document.querySelectorAll('input[name="endType"]')[0].checked = true;
            document.querySelectorAll('.week-days label').forEach(l => l.classList.remove('checked'));
            document.querySelectorAll('.week-days input').forEach(c => c.checked = false);

            oiPanelPuntos = [];
            initFormSelects();
            actualizarFormPlanes('');
            resetForm();
            renderOIPanelPuntos();
            toggleAddMuestrasForm(false);

            document.getElementById('panelOITitle').textContent = 'Nueva Orden de Inspección';
            document.getElementById('btnCrearOI').textContent = 'Crear OI';

            renderUsuariosOI();
            actualizarCabeceraOI();
            actualizarPasoUI();
            aplicarModoPanelOI();
            document.getElementById('panelOIOverlay').classList.add('show');
            document.getElementById('panelOI').classList.add('show');
        }

        // Alias for onclick in HTML
        function abrirModalOI() { abrirPanelOI(); }

        function cerrarPanelOI() {
            document.getElementById('panelOI').classList.remove('show');
            document.getElementById('panelOIOverlay').classList.remove('show');
            editandoOIIdx = -1;
        }

        function generarCodigoOI() {
            const year = new Date().getFullYear();
            const nextNum = ordenesInspeccion.length + 1;
            return `OI-${year}-${String(nextNum).padStart(3, '0')}`;
        }

        // Step navigation
        function irPasoOI(paso) {
            // Validate step 1 before going to step 2
            if (paso === 2 && pasoActual === 1) {
                const fecha = document.getElementById('newOIFecha').value;
                const matriz = document.getElementById('oiMatriz').value;
                const plan = document.getElementById('oiPlan').value;
                if (!fecha) { alert('Seleccione una fecha'); return; }
                if (!matriz) { alert('Seleccione una matriz'); return; }
                if (!plan) { alert('Seleccione un plan'); return; }
            }
            pasoActual = paso;
            actualizarPasoUI();
        }

        function actualizarPasoUI() {
            document.querySelectorAll('.panel-step-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel-step-content').forEach(c => c.classList.remove('active'));

            document.getElementById(`stepTab${pasoActual}`).classList.add('active');
            document.getElementById(`panelStep${pasoActual}`).classList.add('active');

            // Footer buttons
            const isEditMode = editandoOIIdx >= 0;
            document.getElementById('btnPasoAnterior').style.display = pasoActual > 1 ? 'inline-block' : 'none';
            document.getElementById('btnPasoSiguiente').style.display = pasoActual < 2 ? 'inline-block' : 'none';
            document.getElementById('btnCrearOI').style.display = (pasoActual === 2 || isEditMode) ? 'inline-block' : 'none';
            aplicarModoPanelOI();
        }

        // Tipo de OI
        function setTipoOI(tipo, btn) {
            oiTipoActual = tipo;
            document.querySelectorAll('#typeToggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            actualizarCabeceraOI();
        }

        function setComposicionOI(valor, btn) {
            oiComposicionActual = valor || 'puntual';
            if (btn) {
                document.querySelectorAll('#composicionToggle button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            actualizarCabeceraOI();
        }

        function obtenerUltimoDiaDelMes(fechaISO) {
            let base;
            if (fechaISO) {
                const [y, m] = fechaISO.split('-').map(Number);
                base = new Date(y, m - 1, 1);
            } else {
                const now = new Date();
                base = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            const ultimo = new Date(base.getFullYear(), base.getMonth() + 1, 0);
            const yyyy = ultimo.getFullYear();
            const mm = String(ultimo.getMonth() + 1).padStart(2, '0');
            const dd = String(ultimo.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function syncEndDateToMonthEnd() {
            const endTypeHasta = document.querySelector('input[name="endType"][value="hasta"]');
            if (endTypeHasta && !endTypeHasta.checked) return;
            const fechaBase = document.getElementById('newOIFecha').value;
            document.getElementById('endDate').value = obtenerUltimoDiaDelMes(fechaBase);
        }

        // Recurrencia
        function toggleRecurrencia() {
            const checked = document.getElementById('chkRecurrencia').checked;
            document.getElementById('recurrenciaSection').classList.toggle('show', checked);
            if (checked) {
                syncEndDateToMonthEnd();
                actualizarPreviewRecurrencia();
            }
        }

        function setFrequencia(freq, btn) {
            recurrenciaFreq = freq;
            document.querySelectorAll('#freqToggle button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.getElementById('weekDays').style.display = freq === 'semanal' ? 'flex' : 'none';
            document.getElementById('intervalRow').style.display = freq === 'cada_x' ? 'flex' : 'none';

            const descriptions = {
                'diario': 'Se programará todos los días',
                'semanal': 'Se programará en los días seleccionados',
                'cada_x': 'Se programará cada ciertos días'
            };
            document.getElementById('freqDescription').textContent = descriptions[freq];
            actualizarPreviewRecurrencia();
        }

        function toggleWeekDay(label) {
            setTimeout(() => {
                const cb = label.querySelector('input');
                label.classList.toggle('checked', cb.checked);
                actualizarPreviewRecurrencia();
            }, 0);
        }

        function calcularFechasRecurrencia() {
            const fechaBase = document.getElementById('newOIFecha').value;
            if (!fechaBase) return [];

            const endType = document.querySelector('input[name="endType"]:checked').value;
            const endDate = document.getElementById('endDate').value;
            const endOcurrencias = parseInt(document.getElementById('endOcurrencias').value) || 5;
            const intervalo = parseInt(document.getElementById('intervalDias').value) || 2;

            const fechas = [];
            let current = new Date(fechaBase + 'T12:00:00');
            const maxDate = endType === 'hasta' && endDate ? new Date(endDate + 'T12:00:00') : null;
            const maxCount = endType === 'ocurrencias' ? endOcurrencias : 365;

            const selectedDays = [];
            if (recurrenciaFreq === 'semanal') {
                document.querySelectorAll('.week-days input:checked').forEach(cb => selectedDays.push(parseInt(cb.value)));
                if (selectedDays.length === 0) return [];
            }

            while (fechas.length < maxCount) {
                if (maxDate && current > maxDate) break;
                if (recurrenciaFreq === 'diario') {
                    fechas.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                } else if (recurrenciaFreq === 'semanal') {
                    if (selectedDays.includes(current.getDay())) fechas.push(new Date(current));
                    current.setDate(current.getDate() + 1);
                } else if (recurrenciaFreq === 'cada_x') {
                    fechas.push(new Date(current));
                    current.setDate(current.getDate() + intervalo);
                }
                if (fechas.length >= 365) break;
            }
            return fechas;
        }

        function actualizarPreviewRecurrencia() {
            const fechas = calcularFechasRecurrencia();
            document.getElementById('previewCount').textContent = fechas.length;
            const textos = {
                'diario': 'Se crearán OIs todos los días',
                'semanal': 'Se crearán OIs en los días seleccionados',
                'cada_x': `Se crearán OIs cada ${document.getElementById('intervalDias').value || 2} días`
            };
            document.getElementById('recurrencePreview').querySelector('span:first-child').textContent = textos[recurrenciaFreq];
        }

        // ==========================================
        // PANEL OI - Puntos de muestreo (Paso 2)
        // ==========================================
        // Form state
        let formEtfa = false;
        let formPuntosFiltro = '';
        let formPuntosSeleccionados = new Set();

        function toggleAddMuestrasForm(open) {
            const form = document.getElementById('addMuestrasForm');
            const btn = document.getElementById('btnAbrirFormMuestras');
            if (!form || !btn) return;

            form.classList.toggle('show', open);
            btn.style.display = open ? 'none' : 'flex';
        }

        function initFormSelects() {
            // Laboratorios
            const labSel = document.getElementById('formLaboratorio');
            labSel.innerHTML = '<option value="">Seleccionar...</option>' +
                laboratorios.map(l => `<option value="${l}">${l}</option>`).join('');

            // Matrices
            const matrizSel = document.getElementById('oiMatriz');
            const matrices = [...new Set(puntosMuestreo.map(p => p.matriz).filter(Boolean))];
            matrizSel.innerHTML = '<option value="">Seleccionar matriz...</option>' +
                matrices.map(m => `<option value="${m}">${m}</option>`).join('');

            // Estado inicial dependiente
            actualizarFormPlanes('');
            actualizarFormPuntos();
        }

        function onChangeOIMatriz() {
            const matriz = document.getElementById('oiMatriz').value;
            const matrizActualPuntos = oiPanelPuntos.length ? (oiPanelPuntos[0].matriz || '') : '';
            if (matrizActualPuntos && matriz && matrizActualPuntos !== matriz) {
                const confirmar = confirm('Cambiar la matriz eliminará los puntos ya agregados. ¿Desea continuar?');
                if (!confirmar) {
                    document.getElementById('oiMatriz').value = matrizActualPuntos;
                    return;
                }
                oiPanelPuntos = [];
                renderOIPanelPuntos();
            }
            formPuntosFiltro = '';
            formPuntosSeleccionados = new Set();
            document.getElementById('formPuntosSearch').value = '';
            actualizarFormPlanes(matriz);
            actualizarFormPuntos();
        }

        function actualizarFormPlanes(matriz) {
            const planSel = document.getElementById('oiPlan');
            const planes = matriz
                ? (planesPorMatriz[matriz] || planesDisponibles)
                : [];

            planSel.disabled = !matriz;
            planSel.innerHTML = '<option value="">Seleccionar plan...</option>' +
                planes.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function actualizarFormPuntos() {
            const checklist = document.getElementById('formPuntosChecklist');
            if (!checklist) return;
            const info = document.getElementById('formPuntosInfo');

            const matrizSeleccionada = document.getElementById('oiMatriz').value;
            if (!matrizSeleccionada) {
                checklist.innerHTML = '<div class="punto-check-item disabled">Seleccione una matriz para ver puntos</div>';
                if (info) info.textContent = '0 seleccionados';
                return;
            }

            const asignados = oiPanelPuntos.map(p => p.punto);
            const disponibles = puntosMuestreo.filter(pm =>
                pm.matriz === matrizSeleccionada && !asignados.includes(pm.estacion)
            );
            const filtro = formPuntosFiltro.trim().toLowerCase();
            const visibles = filtro
                ? disponibles.filter(pm =>
                    pm.estacion.toLowerCase().includes(filtro) || pm.lugar.toLowerCase().includes(filtro)
                )
                : disponibles;

            if (disponibles.length === 0) {
                checklist.innerHTML = '<div class="punto-check-item disabled">No hay puntos disponibles para la matriz seleccionada</div>';
                if (info) info.textContent = '0 seleccionados';
                return;
            }

            if (visibles.length === 0) {
                checklist.innerHTML = '<div class="punto-check-item disabled">Sin resultados para el filtro aplicado</div>';
                if (info) info.textContent = `${formPuntosSeleccionados.size} seleccionados`;
                return;
            }

            checklist.innerHTML = visibles.map(pm => `
                <label class="punto-check-item">
                    <input type="checkbox" value="${pm.estacion}" ${formPuntosSeleccionados.has(pm.estacion) ? 'checked' : ''} onchange="togglePuntoSeleccion('${pm.estacion}', this.checked)">
                    <div class="punto-check-text">
                        <div class="punto-check-line">
                            <span class="pci-name">${pm.estacion}</span>
                            <span class="pci-detail">· ${pm.lugar}</span>
                        </div>
                    </div>
                    <div class="punto-check-badges">
                        <span class="pci-badge">E ${pm.estratos || 1}</span>
                        <span class="pci-badge">R ${pm.replicas || 1}</span>
                    </div>
                </label>
            `).join('');

            if (info) info.textContent = `${formPuntosSeleccionados.size} seleccionados · ${visibles.length} visibles`;
        }

        function setFiltroPuntos(valor) {
            formPuntosFiltro = valor || '';
            actualizarFormPuntos();
        }

        function togglePuntoSeleccion(estacion, checked) {
            if (checked) formPuntosSeleccionados.add(estacion);
            else formPuntosSeleccionados.delete(estacion);
            const info = document.getElementById('formPuntosInfo');
            if (info) info.textContent = `${formPuntosSeleccionados.size} seleccionados`;
        }

        function seleccionarPuntosVisibles(seleccionar) {
            const matrizSeleccionada = document.getElementById('oiMatriz').value;
            if (!matrizSeleccionada) return;

            const asignados = oiPanelPuntos.map(p => p.punto);
            const disponibles = puntosMuestreo.filter(pm =>
                pm.matriz === matrizSeleccionada && !asignados.includes(pm.estacion)
            );
            const filtro = formPuntosFiltro.trim().toLowerCase();
            const visibles = filtro
                ? disponibles.filter(pm =>
                    pm.estacion.toLowerCase().includes(filtro) || pm.lugar.toLowerCase().includes(filtro)
                )
                : disponibles;

            visibles.forEach(pm => {
                if (seleccionar) formPuntosSeleccionados.add(pm.estacion);
                else formPuntosSeleccionados.delete(pm.estacion);
            });
            actualizarFormPuntos();
        }

        function obtenerEstratosDesdePunto(totalEstratos) {
            const base = ['S', 'M', 'F'];
            const n = Math.max(1, parseInt(totalEstratos, 10) || 1);
            if (n <= base.length) return base.slice(0, n);
            return Array.from({ length: n }, (_, i) => `E${i + 1}`);
        }

        function setFormEtfa(val, btn) {
            formEtfa = val;
            document.querySelectorAll('#formEtfaToggle button').forEach(b => {
                b.className = '';
            });
            btn.className = val ? 'active-etfa' : 'active-noetfa';
        }

        function resetForm() {
            document.getElementById('formLaboratorio').value = '';
            document.getElementById('formPuntosSearch').value = '';
            formEtfa = false;
            formPuntosFiltro = '';
            formPuntosSeleccionados = new Set();
            // Reset ETFA buttons
            const btns = document.querySelectorAll('#formEtfaToggle button');
            btns[0].className = 'active-noetfa';
            btns[1].className = '';
            actualizarFormPuntos();
        }

        function agregarPuntosDesdeForm() {
            const matriz = document.getElementById('oiMatriz').value;
            const puntosSeleccionados = Array.from(formPuntosSeleccionados);
            const plan = document.getElementById('oiPlan').value;
            const laboratorio = document.getElementById('formLaboratorio').value;

            if (!matriz) { alert('Seleccione una matriz'); return; }
            if (puntosSeleccionados.length === 0) { alert('Seleccione al menos un punto de muestreo'); return; }
            if (!laboratorio) { alert('Seleccione un laboratorio'); return; }
            if (!plan) { alert('Seleccione un plan'); return; }

            puntosSeleccionados.forEach(puntoVal => {
                const pm = puntosMuestreo.find(p => p.estacion === puntoVal);
                if (!pm) return;
                const estratos = obtenerEstratosDesdePunto(pm.estratos);
                const replicas = Math.max(1, parseInt(pm.replicas, 10) || 1);
                const muestras = estratos.length * replicas;

                oiPanelPuntos.push({
                    punto: pm.estacion,
                    matriz: pm.matriz,
                    lugar: pm.lugar,
                    plan: plan,
                    estratos: estratos,
                    replicas: replicas,
                    muestras: muestras,
                    etfa: formEtfa,
                    laboratorio: laboratorio
                });
            });

            renderOIPanelPuntos();
            resetForm();
            toggleAddMuestrasForm(false);
        }

        function agregarPuntoDesdeForm() {
            agregarPuntosDesdeForm();
        }

        // Render compact list
        function renderOIPanelPuntos() {
            const container = document.getElementById('puntosListContainer');
            const countEl = document.getElementById('puntosAsignadosCount');
            countEl.textContent = `${oiPanelPuntos.length} punto${oiPanelPuntos.length !== 1 ? 's' : ''}`;

            if (oiPanelPuntos.length === 0) {
                container.innerHTML = '<div class="puntos-empty-msg">Sin puntos asignados</div>';
                actualizarFormPuntos();
                return;
            }

            container.innerHTML = oiPanelPuntos.map((p, i) => {
                const estratos = Array.isArray(p.estratos) ? p.estratos : (p.estratos ? [p.estratos] : []);
                const estratosTags = estratos.map(e => `<span class="punto-list-tag tag-estrato">${e}</span>`).join('');
                const etfaTag = p.etfa
                    ? '<span class="punto-list-tag tag-etfa">ETFA</span>'
                    : '<span class="punto-list-tag tag-noetfa">No ETFA</span>';
                const muestras = (parseInt(p.replicas, 10) || 1) * (estratos.length || 1);
                const removeBtn = panelOIReadOnly
                    ? ''
                    : `<button class="punto-list-remove" onclick="removeOIPanelPunto(${i})" title="Quitar">✕</button>`;
                return `<div class="punto-list-item">
                    <div class="punto-list-icon">${i + 1}</div>
                    <div class="punto-list-info">
                        <div class="punto-list-name">${p.punto}</div>
                        <div class="punto-list-place"><strong>Lugar:</strong> ${p.lugar || 'Sin lugar de muestreo'}</div>
                        <div class="punto-list-details">
                            ${etfaTag}
                            ${estratosTags}
                            <span class="detail-sep">·</span>
                    ${p.replicas} répl.
                    <span class="detail-sep">·</span>
                    ${muestras} muestras
                    <span class="detail-sep">·</span> ${p.plan || 'Sin plan'}
                    ${p.laboratorio ? `<span class="detail-sep">·</span> ${p.laboratorio}` : ''}
                </div>
            </div>
            ${removeBtn}
        </div>`;
            }).join('');

            actualizarFormPuntos();
        }

        function removeOIPanelPunto(idx) {
            oiPanelPuntos.splice(idx, 1);
            renderOIPanelPuntos();
        }

        // ==========================================
        // CREAR / EDITAR OI
        // ==========================================
        function crearOI() {
            const fecha = document.getElementById('newOIFecha').value;
            const matrizOI = document.getElementById('oiMatriz').value;
            const planOI = document.getElementById('oiPlan').value;
            const composicionOI = oiComposicionActual || 'puntual';
            const codigo = editandoOIIdx >= 0 ? ordenesInspeccion[editandoOIIdx].codigo : generarCodigoOI();

            if (!fecha) { alert('Seleccione una fecha'); return; }
            if (!matrizOI) { alert('Seleccione una matriz'); return; }
            if (!planOI) { alert('Seleccione un plan'); return; }
            if (oiPanelPuntos.length === 0) { alert('Agregue al menos un punto de muestreo'); return; }

            for (let i = 0; i < oiPanelPuntos.length; i++) {
                if (!oiPanelPuntos[i].punto) { alert(`Seleccione un punto de muestreo en la fila ${i + 1}`); return; }
            }

            const puntosClone = JSON.parse(JSON.stringify(oiPanelPuntos));

            if (editandoOIIdx >= 0) {
                ordenesInspeccion[editandoOIIdx].codigo = codigo;
                ordenesInspeccion[editandoOIIdx].fecha = fecha;
                ordenesInspeccion[editandoOIIdx].tipo = oiTipoActual;
                ordenesInspeccion[editandoOIIdx].composicion = composicionOI;
                ordenesInspeccion[editandoOIIdx].matriz = matrizOI;
                ordenesInspeccion[editandoOIIdx].plan = planOI;
                ordenesInspeccion[editandoOIIdx].puntos = puntosClone;
                ordenesInspeccion[editandoOIIdx].usuarios = JSON.parse(JSON.stringify(oiUsuariosActuales));
                cerrarPanelOI();
                renderOIs(document.getElementById('oiSearch').value);
                renderCalendar();
                mostrarToast(`OI "${codigo}" actualizada`);
            } else {
                const useRecurrencia = document.getElementById('chkRecurrencia').checked;

                if (useRecurrencia) {
                    const fechas = calcularFechasRecurrencia();
                    if (fechas.length === 0) { alert('No se generaron fechas. Verifique la configuración de recurrencia.'); return; }
                    fechas.forEach((f, i) => {
                        const codigoNum = ordenesInspeccion.length + 1 + i;
                        const codigoAuto = `OI-${f.getFullYear()}-${String(codigoNum).padStart(3, '0')}`;
                        ordenesInspeccion.push({
                            codigo: codigoAuto,
                            fecha: f.toISOString().split('T')[0],
                            tipo: oiTipoActual,
                            composicion: composicionOI,
                            matriz: matrizOI,
                            plan: planOI,
                            estado: 'pendiente',
                            puntos: JSON.parse(JSON.stringify(puntosClone)),
                            usuarios: JSON.parse(JSON.stringify(oiUsuariosActuales))
                        });
                    });
                    cerrarPanelOI();
                    renderOIs(document.getElementById('oiSearch').value);
                    renderCalendar();
                    mostrarToast(`${fechas.length} OIs creadas con recurrencia`);
                } else {
                    ordenesInspeccion.push({
                        codigo,
                        fecha,
                        tipo: oiTipoActual,
                        composicion: composicionOI,
                        matriz: matrizOI,
                        plan: planOI,
                        estado: 'pendiente',
                        puntos: puntosClone,
                        usuarios: JSON.parse(JSON.stringify(oiUsuariosActuales))
                    });
                    cerrarPanelOI();
                    renderOIs(document.getElementById('oiSearch').value);
                    renderCalendar();
                    mostrarToast(`OI "${codigo}" creada`);
                }
            }
        }

        function abrirPanelOIDesdeRegistro(idx, readOnly) {
            const oi = ordenesInspeccion[idx];
            if (!oi) return;

            editandoOIIdx = idx;
            pasoActual = 1;
            panelOIReadOnly = !!readOnly;
            actualizarVisibilidadRecurrencia(false);
            document.getElementById('newOIFecha').value = oi.fecha;
            document.getElementById('chkRecurrencia').checked = false;
            document.getElementById('recurrenciaSection').classList.remove('show');

            // Set type
            oiTipoActual = oi.tipo || 'muestreo_medicion';
            oiComposicionActual = oi.composicion || 'puntual';
            oiEstadoActual = oi.estado || 'pendiente';
            document.querySelectorAll('#typeToggle button').forEach(b => b.classList.remove('active'));
            const typeIdx = oiTipoActual === 'medicion' ? 1 : 0;
            document.querySelectorAll('#typeToggle button')[typeIdx].classList.add('active');
            document.querySelectorAll('#composicionToggle button').forEach(b => b.classList.remove('active'));
            const compIdx = oiComposicionActual === 'compuesta' ? 1 : 0;
            document.querySelectorAll('#composicionToggle button')[compIdx].classList.add('active');
            oiUsuariosActuales = (oi.usuarios && oi.usuarios.length)
                ? JSON.parse(JSON.stringify(oi.usuarios))
                : obtenerUsuariosDefaultOI();

            oiPanelPuntos = JSON.parse(JSON.stringify(oi.puntos));
            // Enrich with lugar from puntosMuestreo
            oiPanelPuntos.forEach(p => {
                if (!p.lugar) {
                    const pm = puntosMuestreo.find(x => x.estacion === p.punto);
                    if (pm) p.lugar = pm.lugar;
                }
            });
            initFormSelects();
            const matrizOI = oi.matriz || (oiPanelPuntos[0] && oiPanelPuntos[0].matriz) || '';
            const planOI = oi.plan || (oiPanelPuntos[0] && oiPanelPuntos[0].plan) || '';
            document.getElementById('oiMatriz').value = matrizOI;
            actualizarFormPlanes(matrizOI);
            if (planOI) document.getElementById('oiPlan').value = planOI;
            resetForm();
            renderOIPanelPuntos();
            toggleAddMuestrasForm(false);

            document.getElementById('panelOITitle').textContent = readOnly ? 'Ver Orden de Inspección' : 'Editar Orden de Inspección';
            document.getElementById('btnCrearOI').textContent = 'Guardar Cambios';

            renderUsuariosOI();
            actualizarCabeceraOI();
            actualizarPasoUI();
            aplicarModoPanelOI();
            document.getElementById('panelOIOverlay').classList.add('show');
            document.getElementById('panelOI').classList.add('show');
        }

        function verOI(idx) {
            abrirPanelOIDesdeRegistro(idx, true);
        }

        function editarOI(idx) {
            abrirPanelOIDesdeRegistro(idx, false);
        }

        function eliminarOI(idx) {
            const nombre = ordenesInspeccion[idx].codigo;
            if (!confirm(`¿Eliminar la OI "${nombre}"?`)) return;
            delete expandedOIs[idx];
            ordenesInspeccion.splice(idx, 1);
            renderOIs(document.getElementById('oiSearch').value);
            renderCalendar();
            mostrarToast(`OI "${nombre}" eliminada`);
        }

        // ==========================================
        // ENVIO A LABORATORIO
        // ==========================================
        let labOIIndex = -1;
        let labMuestrasDetalladas = [];
        let labMuestrasConfirmadas = new Set();
        let labMuestrasFecha = {};
        let labMuestrasHora = {};
        let labObsPuntoActual = '';

        function splitFechaHora(valor) {
            if (!valor) return { fecha: '', hora: '' };
            const [fecha, horaRaw] = String(valor).split('T');
            const hora = (horaRaw || '').slice(0, 5);
            return { fecha: fecha || '', hora: hora || '' };
        }

        function toFechaHoraISO(fecha, hora) {
            if (!fecha || !hora) return '';
            return `${fecha}T${hora}`;
        }

        function getReplicaLabel(index) {
            let n = index + 1;
            let out = '';
            while (n > 0) {
                const rem = (n - 1) % 26;
                out = String.fromCharCode(65 + rem) + out;
                n = Math.floor((n - 1) / 26);
            }
            return out;
        }

        function getEstratoLabel(estrato, idx) {
            if (estrato === null || estrato === undefined || estrato === '') {
                return getReplicaLabel(idx);
            }
            const s = String(estrato).trim().toUpperCase();
            const match = s.match(/[A-Z]/);
            return match ? match[0] : getReplicaLabel(idx);
        }

        function getEstratosArray(estratos) {
            if (Array.isArray(estratos) && estratos.length) return estratos;
            if (estratos !== null && estratos !== undefined && estratos !== '') return [estratos];
            return ['S'];
        }

        function generarMuestrasDetalladasDesdeOI(oi) {
            const muestras = [];
            (oi.puntos || []).forEach(p => {
                const estratos = getEstratosArray(p.estratos);
                const replicas = Math.max(1, parseInt(p.replicas, 10) || 1);
                estratos.forEach((estrato, idxEstrato) => {
                    const estratoLabel = getEstratoLabel(estrato, idxEstrato);
                    for (let r = 0; r < replicas; r++) {
                        const replicaLabel = getReplicaLabel(r);
                        const codigo = `${p.punto}-${estratoLabel}-${replicaLabel}`;
                        muestras.push({
                            id: codigo,
                            codigo: codigo,
                            punto: p.punto || '-',
                            lugar: p.lugar || '',
                            estrato: estratoLabel,
                            replica: replicaLabel,
                            observacionPunto: p.observacion || ''
                        });
                    }
                });
            });
            return muestras;
        }

        function abrirModalLaboratorio(idx) {
            const oi = ordenesInspeccion[idx];
            if (!oi) return;

            labOIIndex = idx;
            labMuestrasDetalladas = generarMuestrasDetalladasDesdeOI(oi);
            const guardado = oi.labIngreso || {};
            const fallbackFechaHora = guardado.fechaHoraMuestreo || '';
            const muestrasGuardadas = Array.isArray(guardado.muestras) ? guardado.muestras : [];
            labMuestrasFecha = {};
            labMuestrasHora = {};
            labMuestrasDetalladas.forEach(m => {
                const mg = muestrasGuardadas.find(x => x.id === m.id);
                const fechaHora = (mg && (mg.fechaHoraMuestreo || toFechaHoraISO(mg.fechaMuestreo, mg.horaMuestreo)))
                    ? (mg.fechaHoraMuestreo || toFechaHoraISO(mg.fechaMuestreo, mg.horaMuestreo))
                    : fallbackFechaHora;
                const split = splitFechaHora(fechaHora);
                labMuestrasFecha[m.id] = split.fecha;
                labMuestrasHora[m.id] = split.hora;
            });
            const confirmadasPrevias = Array.isArray(guardado.muestrasConfirmadas)
                ? guardado.muestrasConfirmadas
                : [];
            labMuestrasConfirmadas = new Set(
                confirmadasPrevias.length ? confirmadasPrevias : labMuestrasDetalladas.map(m => m.id)
            );

            const inspectoresTxt = (oi.usuarios || [])
                .filter(u => u.tipo === 'inspector' || /inspector/i.test(u.rol || ''))
                .map(u => u.nombre)
                .join(', ') || 'Sin asignar';
            const supervisoresTxt = (oi.usuarios || [])
                .filter(u => u.tipo === 'supervisor' || /supervisor/i.test(u.rol || ''))
                .map(u => u.nombre)
                .join(', ') || 'Sin asignar';
            if (inspectoresTxt === 'Sin asignar') {
                alert('Debe existir al menos un inspector asignado para confirmar muestras');
                return;
            }
            const matrizTxt = oi.matriz || (oi.puntos[0] && oi.puntos[0].matriz) || '-';
            const planTxt = oi.plan || (oi.puntos[0] && oi.puntos[0].plan) || '-';
            const laboratoriosOi = Array.from(new Set((oi.puntos || []).map(p => p.laboratorio).filter(Boolean)));
            const laboratorioTxt = laboratoriosOi.length > 1 ? 'Mixto' : (laboratoriosOi[0] || '-');
            const clienteTxt = document.getElementById('inputCliente').value || 'Cliente no seleccionado';
            const olTxt = document.getElementById('inputOL').value || '-';
            const estadoTxt = oiEstadoLabels[oi.estado] || oi.estado || 'Pendiente';
            const tipoTxt = oiTipoLabels[oi.tipo] || 'Muestreo y Medición';
            const composicionTxt = oiComposicionLabels[oi.composicion] || 'Puntual';
            const contactoTxt = document.getElementById('inputResponsable').value || 'Sin contacto';

            document.getElementById('labHeadCodigo').textContent = oi.codigo || '-';
            document.getElementById('labHeadEstado').textContent = estadoTxt;
            document.getElementById('labHeadTipo').textContent = tipoTxt;
            document.getElementById('labHeadComposicion').textContent = composicionTxt;
            document.getElementById('labHeadRecepcion').textContent = formatearFechaDisplay(oi.fecha);
            document.getElementById('labHeadMatriz').textContent = matrizTxt;
            document.getElementById('labHeadLaboratorio').textContent = laboratorioTxt;
            document.getElementById('labHeadPlan').textContent = planTxt;
            document.getElementById('labHeadSupervisor').textContent = supervisoresTxt;
            document.getElementById('labHeadInspector').textContent = inspectoresTxt;
            document.getElementById('labRespMuestreo').value = guardado.responsableMuestreo || contactoTxt;
            document.getElementById('labFechaTransporte').value = guardado.fechaTransporte || '';
            document.getElementById('labHoraTransporte').value = guardado.horaTransporte || '';
            document.getElementById('labObsTerreno').value = guardado.observacionesTerreno || '';

            renderLabMuestras();
            document.getElementById('panelLabOverlay').classList.add('show');
            document.getElementById('panelLaboratorio').classList.add('show');
        }

        function cerrarPanelLaboratorio() {
            document.getElementById('panelLaboratorio').classList.remove('show');
            document.getElementById('panelLabOverlay').classList.remove('show');
            labOIIndex = -1;
            labMuestrasDetalladas = [];
            labMuestrasConfirmadas = new Set();
            labMuestrasFecha = {};
            labMuestrasHora = {};
            labObsPuntoActual = '';
        }

        function cerrarModalLaboratorio() { cerrarPanelLaboratorio(); }

        function renderLabMuestras() {
            const body = document.getElementById('labMuestrasBody');
            const count = document.getElementById('labConfirmCount');
            const chkAll = document.getElementById('labCheckAll');
            if (!body) return;

            if (labMuestrasDetalladas.length === 0) {
                body.innerHTML = '<tr><td colspan="9" style="text-align:center; color:#94a3b8;">No hay muestras para esta OI</td></tr>';
                if (count) count.textContent = '0 / 0 confirmadas';
                if (chkAll) chkAll.checked = false;
                const totalHeadEmpty = document.getElementById('labHeadTotalMuestras');
                if (totalHeadEmpty) totalHeadEmpty.textContent = '0';
                return;
            }

            body.innerHTML = labMuestrasDetalladas.map(m => `
                <tr>
                    <td><input type="checkbox" ${labMuestrasConfirmadas.has(m.id) ? 'checked' : ''} onchange="toggleLabMuestra('${m.id}', this.checked)"></td>
                    <td class="sample-code">${m.codigo}</td>
                    <td>${m.punto}</td>
                    <td>${m.lugar || '-'}</td>
                    <td>${m.estrato}</td>
                    <td>${m.replica}</td>
                    <td>
                        <div class="lab-obs-cell">
                            <span class="lab-obs-status ${m.observacionPunto ? 'has-note' : ''}">${m.observacionPunto ? 'Con nota' : 'Sin nota'}</span>
                            <button type="button" class="lab-obs-btn" onclick="abrirModalLabPuntoObs('${String(m.punto).replace(/'/g, "\\'")}')"><i class="fa-solid fa-comment-dots"></i></button>
                        </div>
                    </td>
                    <td><input type="date" value="${labMuestrasFecha[m.id] || ''}" onchange="setLabMuestraFecha('${m.id}', this.value)"></td>
                    <td><input type="time" value="${labMuestrasHora[m.id] || ''}" onchange="setLabMuestraHora('${m.id}', this.value)"></td>
                </tr>
            `).join('');

            const total = labMuestrasDetalladas.length;
            const ok = labMuestrasConfirmadas.size;
            if (count) count.textContent = `${ok} / ${total} confirmadas`;
            if (chkAll) chkAll.checked = total > 0 && ok === total;
            const totalHead = document.getElementById('labHeadTotalMuestras');
            if (totalHead) totalHead.textContent = String(total);
        }

        function abrirModalLabPuntoObs(punto) {
            if (labOIIndex < 0) return;
            labObsPuntoActual = punto;
            const muestra = labMuestrasDetalladas.find(m => m.punto === punto);
            document.getElementById('labObsPuntoTitulo').textContent = `${punto}${muestra && muestra.lugar ? ` · ${muestra.lugar}` : ''}`;
            document.getElementById('labObsPuntoTexto').value = (muestra && muestra.observacionPunto) ? muestra.observacionPunto : '';
            document.getElementById('modalLabPuntoObs').classList.add('show');
        }

        function cerrarModalLabPuntoObs() {
            document.getElementById('modalLabPuntoObs').classList.remove('show');
            labObsPuntoActual = '';
        }

        function guardarModalLabPuntoObs() {
            if (!labObsPuntoActual) return;
            const texto = document.getElementById('labObsPuntoTexto').value.trim();
            labMuestrasDetalladas.forEach(m => {
                if (m.punto === labObsPuntoActual) m.observacionPunto = texto;
            });
            const oi = ordenesInspeccion[labOIIndex];
            if (oi && Array.isArray(oi.puntos)) {
                oi.puntos.forEach(p => {
                    if (p.punto === labObsPuntoActual) p.observacion = texto;
                });
            }
            cerrarModalLabPuntoObs();
            renderLabMuestras();
        }

        function setLabMuestraFecha(sampleId, value) {
            labMuestrasFecha[sampleId] = value || '';
        }

        function setLabMuestraHora(sampleId, value) {
            labMuestrasHora[sampleId] = value || '';
        }

        function toggleLabMuestra(sampleId, checked) {
            if (checked) labMuestrasConfirmadas.add(sampleId);
            else labMuestrasConfirmadas.delete(sampleId);
            renderLabMuestras();
        }

        function toggleLabTodas(checked) {
            if (checked) {
                labMuestrasConfirmadas = new Set(labMuestrasDetalladas.map(m => m.id));
            } else {
                labMuestrasConfirmadas = new Set();
            }
            renderLabMuestras();
        }

        function guardarEnvioLaboratorio() {
            if (labOIIndex < 0 || !ordenesInspeccion[labOIIndex]) return;

            const responsableMuestreo = document.getElementById('labRespMuestreo').value.trim();
            const fechaTransporte = document.getElementById('labFechaTransporte').value;
            const horaTransporte = document.getElementById('labHoraTransporte').value;
            const observacionesTerreno = document.getElementById('labObsTerreno').value.trim();

            if (!responsableMuestreo) {
                alert('Ingrese el responsable de muestreo');
                return;
            }
            if (!fechaTransporte || !horaTransporte) {
                alert('Ingrese fecha y hora de transporte');
                return;
            }
            if (labMuestrasConfirmadas.size === 0) {
                alert('Confirme al menos una muestra');
                return;
            }
            const faltantes = labMuestrasDetalladas
                .filter(m => labMuestrasConfirmadas.has(m.id) && (!labMuestrasFecha[m.id] || !labMuestrasHora[m.id]))
                .map(m => m.codigo);
            if (faltantes.length > 0) {
                alert('Complete fecha/hora de muestreo en todas las muestras confirmadas');
                return;
            }

            const oi = ordenesInspeccion[labOIIndex];
            const muestras = labMuestrasDetalladas.map(m => ({
                id: m.id,
                codigo: m.codigo,
                punto: m.punto,
                lugar: m.lugar || '',
                estrato: m.estrato,
                replica: m.replica,
                observacionPunto: m.observacionPunto || '',
                confirmada: labMuestrasConfirmadas.has(m.id),
                fechaMuestreo: labMuestrasFecha[m.id] || '',
                horaMuestreo: labMuestrasHora[m.id] || '',
                fechaHoraMuestreo: toFechaHoraISO(labMuestrasFecha[m.id], labMuestrasHora[m.id])
            }));
            oi.labIngreso = {
                responsableMuestreo,
                fechaTransporte,
                horaTransporte,
                observacionesTerreno,
                muestrasConfirmadas: Array.from(labMuestrasConfirmadas),
                muestras,
                totalMuestras: labMuestrasDetalladas.length,
                actualizacion: new Date().toISOString()
            };

            cerrarPanelLaboratorio();
            renderOIs(document.getElementById('oiSearch').value);
            renderCalendar();
            mostrarToast(`Muestras preparadas para laboratorio (${oi.labIngreso.muestrasConfirmadas.length})`);
        }

        // Renderizar OIs al inicio
        renderOIs();
        const tabInicial = (proyectoTabParam && document.getElementById('tab-' + proyectoTabParam))
            ? proyectoTabParam
            : 'ficha';
        activarTab(tabInicial);

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.oi-options-wrap')) {
                closeAllOiOptions();
            }
            if (!e.target.closest('.cal-inspector-right')) {
                closeInspectorMenus();
            }
        });

        // Sync visual header while editing OI data
        document.getElementById('newOIFecha').addEventListener('change', function() {
            actualizarCabeceraOI();
            if (document.getElementById('chkRecurrencia').checked) {
                syncEndDateToMonthEnd();
                actualizarPreviewRecurrencia();
            }
        });
        document.getElementById('inputCliente').addEventListener('change', actualizarCabeceraOI);
        document.getElementById('inputOL').addEventListener('change', actualizarCabeceraOI);
        document.getElementById('inputResponsable').addEventListener('change', function() {
            if (editandoOIIdx < 0) oiUsuariosActuales = obtenerUsuariosDefaultOI();
            renderUsuariosOI();
            actualizarCabeceraOI();
        });

        // ==========================================
        // CALENDARIO
        // ==========================================
        const inspectorIdByName = {
            'Carlos Mendoza': '1',
            'María González': '2',
            'Pedro Sánchez': '3',
            'Ana Rodríguez': '4'
        };

        const inspectorNameById = {
            '1': 'Carlos Mendoza',
            '2': 'María González',
            '3': 'Pedro Sánchez',
            '4': 'Ana Rodríguez'
        };

        const calMonthNames = [
            'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio',
            'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'
        ];

        let calViewDate = (() => {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1);
        })();
        let calData = {};

        function getInspectorIdsFromOI(oi) {
            return Array.from(new Set(
                (oi.usuarios || [])
                    .filter(u => u.tipo === 'inspector' || /inspector/i.test(u.rol || ''))
                    .map(u => inspectorIdByName[u.nombre])
                    .filter(Boolean)
            ));
        }

        function getMuestrasFromOI(oi) {
            return (oi.puntos || []).reduce((acc, p) => {
                const estratos = Array.isArray(p.estratos) ? p.estratos : (p.estratos ? [p.estratos] : []);
                const replicas = parseInt(p.replicas, 10) || 1;
                return acc + replicas * (estratos.length || 1);
            }, 0);
        }

        function buildCalDataFromOIs() {
            const data = {};
            const year = calViewDate.getFullYear();
            const month = calViewDate.getMonth();

            ordenesInspeccion.forEach((oi, idx) => {
                if (!oi.fecha) return;
                const dt = new Date(`${oi.fecha}T12:00:00`);
                if (isNaN(dt)) return;
                if (dt.getFullYear() !== year || dt.getMonth() !== month) return;

                const day = dt.getDate();
                if (!data[day]) data[day] = [];
                data[day].push({
                    oiIdx: idx,
                    title: oi.codigo,
                    detail: `${(oi.puntos || []).length} pts / ${getMuestrasFromOI(oi)} mues.`,
                    tipo: oi.tipo || 'muestreo_medicion',
                    inspectorIds: getInspectorIdsFromOI(oi),
                    etfa: (oi.puntos || []).some(p => p.etfa) ? 'green' : null
                });
            });

            return data;
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            if (!grid) return;
            calData = buildCalDataFromOIs();

            const days = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES', 'SÁBADO', 'DOMINGO'];
            let html = '';
            const year = calViewDate.getFullYear();
            const month = calViewDate.getMonth();
            const monthTitle = document.getElementById('calMonthTitle');
            if (monthTitle) monthTitle.textContent = `${calMonthNames[month]} ${year}`;

            // Headers
            days.forEach(d => {
                html += `<div class="cal-day-header">${d}</div>`;
            });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const jsFirstDay = new Date(year, month, 1).getDay(); // 0 dom
            const firstDayOffset = (jsFirstDay + 6) % 7; // lunes=0

            // Espacios vacíos antes del día 1
            for (let i = 0; i < firstDayOffset; i++) {
                html += '<div class="cal-day empty"></div>';
            }

            // Días del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dayOfWeek = (firstDayOffset + day - 1) % 7;
                const isWeekend = dayOfWeek >= 5;
                const ois = calData[day] || [];

                html += `<div class="cal-day${isWeekend ? ' weekend' : ''}" data-day="${day}">`;
                html += `<div class="day-num">${day}</div>`;
                html += `<div class="oi-container">`;

                ois.forEach((oi, idx) => {
                    const inspectorIds = Array.isArray(oi.inspectorIds) ? oi.inspectorIds : [];
                    const assignedClass = inspectorIds.length > 0 ? 'assigned' : 'unassigned';
                    let etfaDot = '';
                    if (oi.etfa === 'green') etfaDot = `<span class="etfa-dot green" title="ETFA"><i class="fa-solid fa-circle-check"></i></span>`;
                    else if (oi.etfa === 'red') etfaDot = `<span class="etfa-dot red" title="Plan no autorizado"><i class="fa-solid fa-triangle-exclamation"></i></span>`;
                    else if (oi.etfa === 'blue') etfaDot = `<span class="etfa-dot blue" title="Solo medición"><i class="fa-solid fa-ruler-combined"></i></span>`;
                    const inspectorsAttr = inspectorIds.join(',');
                    const tipoIcon = oi.tipo === 'medicion'
                        ? '<i class="fa-solid fa-chart-line oi-type-icon" title="Solo Medición"></i>'
                        : '<i class="fa-solid fa-vial-circle-check oi-type-icon" title="Muestreo y Medición"></i>';

                    html += `<div class="cal-oi ${assignedClass}" draggable="true" data-day="${day}" data-idx="${idx}" data-oi-idx="${oi.oiIdx}" data-inspectors="${inspectorsAttr}">
                        ${etfaDot}
                        <div class="oi-title">${tipoIcon}<span>${oi.title}</span></div>
                        <div class="oi-detail">${oi.detail}</div>
                    </div>`;
                });

                html += `</div></div>`;
            }

            // Rellenar últimas celdas vacías
            const totalCells = firstDayOffset + daysInMonth;
            const remaining = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remaining; i++) {
                html += '<div class="cal-day empty"></div>';
            }

            grid.innerHTML = html;
            updateCalCounters();
            initDragAndDrop();
            applyAssignmentUIState();
        }

        function updateCalCounters() {
            const counts = { '1': 0, '2': 0, '3': 0, '4': 0, 'unassigned': 0 };

            Object.values(calData).forEach(dayOIs => {
                dayOIs.forEach(oi => {
                    const inspectorIds = Array.isArray(oi.inspectorIds) ? oi.inspectorIds : [];
                    if (inspectorIds.length > 0) {
                        inspectorIds.forEach(id => {
                            counts[id] = (counts[id] || 0) + 1;
                        });
                    } else {
                        counts.unassigned++;
                    }
                });
            });

            Object.keys(counts).forEach(key => {
                const el = document.getElementById(`calCount-${key}`);
                if (el) {
                    el.textContent = counts[key];
                    el.classList.toggle('has-items', counts[key] > 0);
                }
            });
        }

        function calGoToday() {
            const now = new Date();
            calViewDate = new Date(now.getFullYear(), now.getMonth(), 1);
            renderCalendar();
        }

        function calChangeMonth(delta) {
            calViewDate = new Date(calViewDate.getFullYear(), calViewDate.getMonth() + delta, 1);
            renderCalendar();
        }

        function calChangeYear(delta) {
            calViewDate = new Date(calViewDate.getFullYear() + delta, calViewDate.getMonth(), 1);
            renderCalendar();
        }

        function closeInspectorMenus() {
            document.querySelectorAll('.cal-inspector-menu.show').forEach(m => m.classList.remove('show'));
        }

        function toggleInspectorMenu(event, inspectorId) {
            event.stopPropagation();
            const menu = document.getElementById(`inspectorMenu-${inspectorId}`);
            if (!menu) return;
            const show = !menu.classList.contains('show');
            closeInspectorMenus();
            menu.classList.toggle('show', show);
        }

        function getInspectorInitials(name) {
            if (!name) return '--';
            const parts = name.split(' ').filter(Boolean);
            if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
            return `${parts[0][0]}${parts[1][0]}`.toUpperCase();
        }

        function updateAssignBar() {
            const bar = document.getElementById('calAssignBar');
            const nameEl = document.getElementById('calAssignInspectorName');
            const avatarEl = document.getElementById('calAssignAvatar');
            const countEl = document.getElementById('calAssignCountNum');
            const confirmBtn = document.getElementById('calAssignConfirmBtn');
            const labelEl = document.getElementById('calAssignActionLabel');
            if (!bar || !nameEl || !avatarEl || !countEl || !confirmBtn) return;

            if (!assignmentMode || !assignmentInspectorId) {
                bar.classList.remove('show');
                return;
            }
            const name = inspectorNameById[assignmentInspectorId] || 'Inspector';
            nameEl.textContent = name;
            avatarEl.textContent = getInspectorInitials(name);
            countEl.textContent = assignmentSelectedOIs.size;
            confirmBtn.disabled = assignmentSelectedOIs.size === 0;
            if (labelEl) labelEl.textContent = assignmentAction === 'unassign' ? 'Desasignando de:' : 'Asignando a:';
            confirmBtn.textContent = assignmentAction === 'unassign' ? 'Desasignar' : 'Confirmar';
            bar.classList.add('show');
        }

        function applyAssignmentUIState() {
            const grid = document.getElementById('calGrid');
            if (!grid) return;
            grid.classList.toggle('assigning-mode', assignmentMode);
            grid.querySelectorAll('.cal-oi').forEach(card => {
                const oiIdx = parseInt(card.dataset.oiIdx, 10);
                card.classList.toggle('assign-selected', assignmentSelectedOIs.has(oiIdx));
            });
            updateAssignBar();
        }

        function startBatchAssign(inspectorId, action, event) {
            if (event) event.stopPropagation();
            closeInspectorMenus();
            assignmentMode = true;
            assignmentInspectorId = inspectorId;
            assignmentAction = action === 'unassign' ? 'unassign' : 'assign';
            assignmentSelectedOIs = new Set();
            document.querySelectorAll('.cal-inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.cal-oi').forEach(oi => { oi.style.opacity = '1'; });
            applyAssignmentUIState();
            const modeTxt = assignmentAction === 'unassign' ? 'desasignación' : 'asignación';
            mostrarToast(`Modo ${modeTxt}: ${inspectorNameById[inspectorId] || 'Inspector'}`);
        }

        function cancelBatchAssign() {
            assignmentMode = false;
            assignmentInspectorId = null;
            assignmentAction = 'assign';
            assignmentSelectedOIs = new Set();
            applyAssignmentUIState();
        }

        function confirmBatchAssign() {
            if (!assignmentMode || !assignmentInspectorId || assignmentSelectedOIs.size === 0) return;
            const inspectorName = inspectorNameById[assignmentInspectorId] || 'Inspector';

            assignmentSelectedOIs.forEach(oiIdx => {
                const oi = ordenesInspeccion[oiIdx];
                if (!oi) return;
                if (assignmentAction === 'unassign') {
                    oi.usuarios = (oi.usuarios || []).filter(u =>
                        !((u.tipo === 'inspector' || /inspector/i.test(u.rol || '')) && u.nombre === inspectorName)
                    );
                } else {
                    const hasInspector = (oi.usuarios || []).some(u =>
                        (u.tipo === 'inspector' || /inspector/i.test(u.rol || '')) && u.nombre === inspectorName
                    );
                    if (!hasInspector) {
                        oi.usuarios = oi.usuarios || [];
                        oi.usuarios.push({ rol: 'Inspector', nombre: inspectorName, tipo: 'inspector' });
                    }
                }
            });

            const total = assignmentSelectedOIs.size;
            assignmentMode = false;
            assignmentInspectorId = null;
            const actionDone = assignmentAction;
            assignmentAction = 'assign';
            assignmentSelectedOIs = new Set();

            renderOIs(document.getElementById('oiSearch').value);
            renderCalendar();
            if (actionDone === 'unassign') {
                mostrarToast(`${total} OI(s) desasignadas de ${inspectorName}`);
            } else {
                mostrarToast(`${total} OI(s) asignadas a ${inspectorName}`);
            }
        }


        // ==========================================
        // DRAG & DROP - OI Cards entre días
        // ==========================================
        let dragData = null;

        function initDragAndDrop() {
            const grid = document.getElementById('calGrid');
            if (!grid) return;

            // OI card dragstart
            grid.querySelectorAll('.cal-oi').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (assignmentMode) return;
                    if (this.dataset.suppressOpen === '1') {
                        e.preventDefault();
                        return;
                    }
                    const oiIdx = parseInt(this.dataset.oiIdx, 10);
                    if (!isNaN(oiIdx)) verOI(oiIdx);
                });

                card.addEventListener('click', function(e) {
                    if (!assignmentMode) return;
                    e.preventDefault();
                    e.stopPropagation();
                    const oiIdx = parseInt(this.dataset.oiIdx, 10);
                    if (isNaN(oiIdx)) return;
                    if (assignmentSelectedOIs.has(oiIdx)) assignmentSelectedOIs.delete(oiIdx);
                    else assignmentSelectedOIs.add(oiIdx);
                    applyAssignmentUIState();
                });

                card.addEventListener('dragstart', function(e) {
                    if (assignmentMode) {
                        e.preventDefault();
                        return;
                    }
                    this.dataset.suppressOpen = '1';
                    dragData = {
                        type: 'oi',
                        fromDay: parseInt(this.dataset.day),
                        fromIdx: parseInt(this.dataset.idx)
                    };
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', 'oi');
                });

                card.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    // Limpiar todos los estados de drag
                    grid.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    grid.querySelectorAll('.drag-over-oi').forEach(el => el.classList.remove('drag-over-oi'));
                    dragData = null;
                    setTimeout(() => { this.dataset.suppressOpen = '0'; }, 180);
                });
            });

            // Day cell drop targets
            grid.querySelectorAll('.cal-day[data-day]').forEach(dayCell => {
                dayCell.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    // Si estamos sobre una OI card, resaltar esa card
                    const oiTarget = e.target.closest('.cal-oi');
                    if (oiTarget && dragData && dragData.type === 'inspector') {
                        grid.querySelectorAll('.inspector-drop-target').forEach(el => el.classList.remove('inspector-drop-target'));
                        oiTarget.classList.add('inspector-drop-target');
                        this.classList.remove('drag-over');
                    } else {
                        grid.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                        grid.querySelectorAll('.inspector-drop-target').forEach(el => el.classList.remove('inspector-drop-target'));
                        this.classList.add('drag-over');
                    }
                });

                dayCell.addEventListener('dragleave', function(e) {
                    // Solo quitar si realmente salimos de la celda
                    if (!this.contains(e.relatedTarget)) {
                        this.classList.remove('drag-over');
                        this.querySelectorAll('.inspector-drop-target').forEach(el => el.classList.remove('inspector-drop-target'));
                    }
                });

                dayCell.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    grid.querySelectorAll('.inspector-drop-target').forEach(el => el.classList.remove('inspector-drop-target'));

                    if (!dragData) return;

                    const toDay = parseInt(this.dataset.day);

                    if (dragData.type === 'oi') {
                        const fromDay = dragData.fromDay;
                        const fromIdx = dragData.fromIdx;
                        if (fromDay === toDay) return;
                        if (!calData[fromDay] || !calData[fromDay][fromIdx]) return;

                        const oiCard = calData[fromDay][fromIdx];
                        const oiIdx = oiCard.oiIdx;
                        if (oiIdx === undefined || !ordenesInspeccion[oiIdx]) return;

                        const y = calViewDate.getFullYear();
                        const m = String(calViewDate.getMonth() + 1).padStart(2, '0');
                        const d = String(toDay).padStart(2, '0');
                        ordenesInspeccion[oiIdx].fecha = `${y}-${m}-${d}`;

                        renderOIs(document.getElementById('oiSearch').value);
                        renderCalendar();
                        mostrarToast(`OI "${oiCard.title}" movida al día ${toDay}`);

                    } else if (dragData.type === 'inspector') {
                        // Asignar inspector a OI
                        const oiTarget = e.target.closest('.cal-oi');
                        if (oiTarget) {
                            const oiDay = parseInt(oiTarget.dataset.day);
                            const oiIdx = parseInt(oiTarget.dataset.idx);

                            if (calData[oiDay] && calData[oiDay][oiIdx]) {
                                const inspectorId = dragData.inspectorId;
                                const inspectorName = dragData.inspectorName;
                                const oiCard = calData[oiDay][oiIdx];
                                const oiRef = oiCard ? ordenesInspeccion[oiCard.oiIdx] : null;
                                if (!oiRef) return;

                                if (inspectorId === 'unassigned') {
                                    oiRef.usuarios = (oiRef.usuarios || []).filter(u => !(u.tipo === 'inspector' || /inspector/i.test(u.rol || '')));
                                    mostrarToast(`Inspector removido de "${oiCard.title}"`);
                                } else {
                                    const targetName = inspectorNameById[inspectorId] || inspectorName;
                                    const hasInspector = (oiRef.usuarios || []).some(u =>
                                        (u.tipo === 'inspector' || /inspector/i.test(u.rol || '')) && u.nombre === targetName
                                    );
                                    if (!hasInspector) {
                                        oiRef.usuarios = oiRef.usuarios || [];
                                        oiRef.usuarios.push({ rol: 'Inspector', nombre: targetName, tipo: 'inspector' });
                                    }
                                    mostrarToast(`${inspectorName} asignado a "${oiCard.title}"`);
                                }
                                renderOIs(document.getElementById('oiSearch').value);
                                renderCalendar();
                            }
                        }
                    }

                    dragData = null;
                });
            });
        }

        // ==========================================
        // DRAG & DROP - Inspectors a OI Cards
        // ==========================================
        document.querySelectorAll('.cal-inspector-card').forEach(card => {
            card.setAttribute('draggable', 'true');

            card.addEventListener('dragstart', function(e) {
                if (assignmentMode) {
                    e.preventDefault();
                    return;
                }
                const inspectorId = this.dataset.inspector;
                const inspectorName = this.querySelector('.cal-inspector-name').textContent;
                dragData = {
                    type: 'inspector',
                    inspectorId: inspectorId,
                    inspectorName: inspectorName
                };
                this.classList.add('dragging-inspector');
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/plain', 'inspector');
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging-inspector');
                document.querySelectorAll('.inspector-drop-target').forEach(el => el.classList.remove('inspector-drop-target'));
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                dragData = null;
            });
        });

        // ==========================================
        // Inspector filter (click)
        // ==========================================
        document.querySelectorAll('.cal-inspector-card').forEach(card => {
            card.addEventListener('click', function() {
                if (assignmentMode) return;
                const wasSelected = this.classList.contains('selected');
                document.querySelectorAll('.cal-inspector-card').forEach(c => c.classList.remove('selected'));

                if (!wasSelected) {
                    this.classList.add('selected');
                    const inspectorId = this.dataset.inspector;

                    document.querySelectorAll('.cal-oi').forEach(oi => {
                        if (inspectorId === 'unassigned') {
                            oi.style.opacity = oi.classList.contains('unassigned') ? '1' : '0.2';
                        } else {
                            const inspectors = (oi.dataset.inspectors || '').split(',').filter(Boolean);
                            oi.style.opacity = inspectors.includes(inspectorId) ? '1' : '0.2';
                        }
                    });
                } else {
                    // Deselect: show all
                    document.querySelectorAll('.cal-oi').forEach(oi => {
                        oi.style.opacity = '1';
                    });
                }
            });
        });

        // Renderizar calendario al inicio
        renderCalendar();
    </script>
</body>
</html>
