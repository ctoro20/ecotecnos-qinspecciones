<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGS - Calendario de Inspectores</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            display: flex;
            height: 100vh;
        }

        body.assignment-locked .sidebar,
        body.assignment-locked .header,
        body.assignment-locked .filters-panel,
        body.assignment-locked .calendar-controls,
        body.assignment-locked .legend,
        body.assignment-locked .inspectors-panel {
            pointer-events: none;
            opacity: 0.6;
        }

        .assignment-lock-overlay {
            display: none;
            position: fixed;
            top: 90px;
            left: 210px;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.08);
            z-index: 900;
            align-items: flex-start;
            justify-content: center;
            padding-top: 8px;
            pointer-events: none;
        }

        .assignment-lock-overlay.show {
            display: flex;
        }

        .assignment-lock-message {
            background: #fff;
            border: 1px solid #e3e3e3;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 12px;
            color: #333;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
        }

        /* Sidebar */
        .sidebar {
            width: 210px;
            background: #3a3a3a;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .logo-section {
            padding: 20px;
            border-bottom: 1px solid #555;
            text-align: center;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .user-info {
            padding: 15px;
            border-bottom: 1px solid #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-size: 12px;
            font-weight: bold;
        }

        .user-version {
            font-size: 10px;
            color: #999;
        }

        .company-select {
            margin: 15px;
            padding: 8px;
            background: white;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 12px;
        }

        .menu {
            flex: 1;
            overflow-y: auto;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #ccc;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #4a4a4a;
        }

        .menu-item.active {
            background: #555;
            color: #ff6633;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            font-size: 16px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #ddd;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            font-weight: normal;
        }

        .content {
            flex: 1;
            overflow: auto;
            background: #f2f2f2;
            padding: 12px 16px;
        }

        /* Calendar Controls */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .view-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .filter-btn {
            padding: 8px 20px;
            border: 1px solid #999;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #666;
            color: white;
            border-color: #666;
        }

        .filter-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-display {
            font-size: 24px;
            font-weight: normal;
            color: #333;
            min-width: 200px;
            text-align: center;
        }

        .nav-btn {
            padding: 8px 12px;
            border: 1px solid #999;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: #f0f0f0;
        }

        .today-btn {
            padding: 8px 16px;
            border: 1px solid #999;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Inspector Filter */
        .inspector-filter {
            margin-bottom: 20px;
        }

        .filter-dropdown {
            padding: 10px 15px;
            border: 1px solid #999;
            background: white;
            border-radius: 20px;
            font-size: 13px;
            min-width: 200px;
            cursor: pointer;
        }

        .filters-panel {
            background: #fff;
            border: 1px solid #e3e3e3;
            border-radius: 10px;
            padding: 10px 12px;
            margin: 8px 0 12px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(200px, 1fr)) auto;
            gap: 12px;
            align-items: end;
        }

        .filters-advanced {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }

        .filters-advanced.show {
            display: grid;
            grid-template-columns: repeat(3, minmax(200px, 1fr));
            gap: 12px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .filter-select,
        .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #999;
            background: white;
            border-radius: 8px;
            font-size: 13px;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
        }

        .filter-action {
            padding: 10px 16px;
            border-radius: 6px;
            border: 1px solid #999;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }

        .filter-action.primary {
            background: #ff6633;
            border-color: #ff6633;
            color: white;
        }

        .filter-action.secondary {
            background: #4fc3c7;
            border-color: #4fc3c7;
            color: white;
        }

        .calendar-card {
            background: #fff;
            border: 1px solid #e3e3e3;
            border-radius: 12px;
            padding: 10px 12px 12px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }

        .calendar-card .calendar-controls {
            margin-bottom: 12px;
        }

        .calendar-card .legend {
            margin-bottom: 16px;
        }

        @media (max-width: 1100px) {
            .filters-row {
                grid-template-columns: repeat(2, minmax(200px, 1fr));
            }

            .filter-actions {
                justify-content: flex-start;
            }
        }

        @media (max-width: 700px) {
            .filters-row,
            .filters-advanced.show {
                grid-template-columns: 1fr;
            }
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.etfa {
            background: #4CAF50;
        }

        .legend-dot.medicion {
            background: #2196F3;
        }

        .legend-dot.no-autorizado {
            background: #ff0000;
        }

        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border: 1px solid #ddd;
        }

        .day-header {
            background: white;
            padding: 10px;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            text-align: center;
            text-transform: uppercase;
        }

        .day-cell {
            background: white;
            min-height: 120px;
            padding: 5px;
            position: relative;
        }

        .day-number {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .assignment {
            background: #555;
            color: white;
            padding: 4px 6px;
            margin-bottom: 2px;
            font-size: 10px;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .assignment:hover {
            opacity: 0.8;
        }

        .assignment.pending {
            background: #ff6633;
        }

        .assignment.has-dot::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }

        .assignment.has-dot.green::before {
            background: #4CAF50;
        }

        .assignment .company {
            font-weight: bold;
        }

        .assignment .code {
            font-size: 9px;
            opacity: 0.9;
        }

        /* Drag and Drop Styles */
        .assignment.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .day-cell.drag-over {
            background: #e3f2fd;
            border: 2px dashed #2196F3;
        }

        .assignment {
            cursor: grab;
        }

        .assignment:active {
            cursor: grabbing;
        }

        /* Inspectors Panel */
        .inspectors-panel {
            width: 220px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .inspectors-header {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .inspectors-actions {
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
        }

        .inspectors-clear-btn {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #bbb;
            background: #f5f5f5;
            font-size: 12px;
            cursor: pointer;
        }

        .inspectors-clear-btn:hover {
            background: #eee;
        }

        .inspectors-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .inspector-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }

        .inspector-card.unassigned {
            background: #f3f3f3;
            border-color: #cfcfcf;
        }

        .inspector-card:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            background: #f5f5f5;
        }

        .inspector-card.selected {
            border: 2px solid #ff6633;
            background: #fff5f0;
        }

        .inspector-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .inspector-name {
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }

        .inspector-role {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .inspector-counter {
            background: #ff6633;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        .inspector-counter.unassigned {
            background: #9e9e9e;
        }

        .inspector-counter.zero {
            background: #ccc;
            color: #666;
        }

        /* Inspector Menu */
        .inspector-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            margin-top: 5px;
        }

        .inspector-menu.show {
            display: block;
        }

        .inspector-menu-item {
            padding: 10px 12px;
            font-size: 12px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .inspector-menu-item:last-child {
            border-bottom: none;
        }

        .inspector-menu-item:hover {
            background: #f5f5f5;
        }

        .inspector-menu-item.active {
            background: #fff5f0;
            color: #ff6633;
        }

        /* Assignment mode */
        .assignment-mode-banner {
            display: none;
            background: #ff6633;
            color: white;
            padding: 10px 15px;
            font-size: 12px;
            text-align: center;
        }

        .assignment-mode-banner.show {
            display: block;
        }

        .assignment-mode-banner button {
            background: white;
            color: #ff6633;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 11px;
        }

        /* Selectable assignments */
        .assignment.selectable {
            cursor: pointer;
        }

        .assignment.selectable:hover {
            outline: 2px dashed #ff6633;
            outline-offset: 1px;
        }

        /* Tarjetas en proceso de asignaci√≥n (pendientes de confirmar) */
        .assignment.pending-assign {
            background: #ffaa80;
            border: 2px solid #555;
        }

        /* Tarjetas ya confirmadas/asignadas */
        .assignment.assigned {
            background: #ff6633;
        }

        /* Filtered out assignments */
        .assignment.filtered-out {
            opacity: 0.3;
        }

        .assignment.blocked {
            opacity: 0.3;
        }

        /* Floating Assignment Bar */
        .assignment-floating-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 210px;
            right: 0;
            background: white;
            border-top: 3px solid #ff6633;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 15px 30px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        .assignment-floating-bar.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .floating-bar-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .floating-bar-inspector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floating-bar-inspector-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ff6633;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .floating-bar-inspector-name {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .floating-bar-inspector-label {
            font-size: 11px;
            color: #666;
        }

        .floating-bar-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: #fff5f0;
            border-radius: 8px;
            border: 1px solid #ffcdb8;
        }

        .counter-number {
            font-size: 28px;
            font-weight: bold;
            color: #ff6633;
        }

        .counter-label {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        .floating-bar-actions {
            display: flex;
            gap: 10px;
        }

        .floating-bar-btn {
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .floating-bar-btn.cancel {
            background: white;
            border: 2px solid #999;
            color: #666;
        }

        .floating-bar-btn.cancel:hover {
            background: #f5f5f5;
            border-color: #666;
        }

        .floating-bar-btn.confirm {
            background: #ff6633;
            border: 2px solid #ff6633;
            color: white;
        }

        .floating-bar-btn.confirm:hover {
            background: #e55a2b;
            border-color: #e55a2b;
        }

        .floating-bar-btn.confirm:disabled {
            background: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }

        /* Modal/Popup Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            position: relative;
        }

        .modal-header h2 {
            font-size: 13px;
            color: #333;
            margin-bottom: 4px;
            padding-right: 30px;
            line-height: 1.2;
        }

        .modal-header-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
            padding-right: 36px;
        }

        .modal-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            justify-self: center;
        }

        .modal-title-block {
            min-width: 0;
            text-align: left;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            z-index: 2;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-date {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin: 2px 0 0;
        }

        .modal-contact {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            text-align: center;
            font-size: 12px;
            color: #666;
            line-height: 1.3;
            margin-bottom: 4px;
            flex-wrap: wrap;
            flex-direction: column;
        }

        .modal-badge {
            display: inline-block;
            background: #666;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 11px;
            margin-top: 4px;
            white-space: nowrap;
        }

        .modal-badge-wrap {
            display: flex;
            justify-content: flex-end;
            justify-self: end;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }

        .modal-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            color: #666;
            transition: all 0.2s;
        }

        .modal-tab.active {
            background: white;
            color: #ff6633;
            border-bottom: 2px solid #ff6633;
        }

        .modal-tab:hover:not(.active) {
            background: #eee;
        }

        .modal-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .modal-roles-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .modal-role-tag {
            background: #f5f5f5;
            padding: 6px 10px;
            border-radius: 999px;
            text-align: left;
            color: #666;
            font-size: 12px;
            line-height: 1.3;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .modal-role-tag.assigned {
            background: #fff5f0;
            color: #ff6633;
            font-weight: bold;
        }

        .role-icon {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #999;
            position: relative;
            flex: 0 0 14px;
        }

        .role-icon::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #fff;
            top: 2px;
            left: 4px;
        }

        .role-icon::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 5px;
            border-radius: 6px 6px 2px 2px;
            background: #fff;
            bottom: 2px;
            left: 2px;
        }

        .role-icon.coordinator {
            background: #4caf50;
        }

        .role-icon.supervisor {
            background: #2196f3;
        }

        .role-icon.inspector {
            background: #ff6633;
        }

        /* Listado de puntos de muestra */
        .muestra-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .muestra-item:last-child {
            border-bottom: none;
        }

        .muestra-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .muestra-label {
            font-size: 12px;
            color: #999;
            width: 100px;
        }

        .muestra-value {
            font-size: 12px;
            color: #333;
            text-align: right;
            flex: 1;
        }

        .muestra-nombre {
            font-weight: bold;
            color: #333;
            font-size: 13px;
            text-align: center;
            margin-bottom: 8px;
        }

        /* Tabla de muestras detalle */
        .muestras-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .muestras-table th {
            background: #f5f5f5;
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            color: #666;
            border-bottom: 2px solid #ddd;
        }

        .muestras-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .muestras-table .plan-list {
            list-style: disc;
            margin: 0;
            padding-left: 15px;
        }

        .muestras-table .etfa-link {
            color: #ff6633;
            text-decoration: none;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-programado {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-en-proceso {
            background: #fff3e0;
            color: #ef6c00;
        }

        .status-recepcionado {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
        }

        .modal-btn {
            padding: 10px 30px;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.secondary {
            background: #333;
            color: white;
            border: none;
        }

        .modal-btn.secondary:hover {
            background: #444;
        }

        .modal-btn.primary {
            background: #ff6633;
            color: white;
            border: none;
        }

        .modal-btn.primary:hover {
            background: #e55a2b;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-section">
            <a href="#" class="logo">SGS</a>
        </div>
        
        <div class="user-info">
            <div class="user-icon">üë§</div>
            <div class="user-details">
                <div class="user-name">VIVIANA LOPEZ</div>
                <div class="user-version">Versi√≥n 1.0.2</div>
            </div>
        </div>

        <select class="company-select">
            <option>SGS CHILE</option>
        </select>

        <nav class="menu">
            <a href="#" class="menu-item">
                <span class="menu-icon">üè†</span>
                <span>INICIO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">üìÑ</span>
                <span>DOCUMENTOS</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">üìù</span>
                <span>INFORME DE TERRENO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">üìã</span>
                <span>LISTADO OL</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">üìã</span>
                <span>LISTADO OI</span>
            </a>
            <a href="#" class="menu-item active">
                <span class="menu-icon">üìÖ</span>
                <span>CALENDARIO</span>
            </a>
            <a href="#" class="menu-item">
                <span class="menu-icon">üì¶</span>
                <span>PREPARACI√ìN DE MATERIALES</span>
            </a>
        </nav>
    </div>

    <!-- Inspectors Panel -->
    <div class="inspectors-panel">
        <div class="inspectors-header">
            Inspectores
        </div>
        <div class="inspectors-actions">
            <button class="inspectors-clear-btn" type="button" id="clearInspectorFilter">Limpiar filtro</button>
        </div>
        <div class="assignment-mode-banner" id="assignmentBanner">
            Modo asignaci√≥n activo
            <button onclick="exitAssignmentMode()">Cancelar</button>
        </div>
        <div class="inspectors-list" id="inspectorsList">
            <div class="inspector-card unassigned" data-inspector-id="unassigned">
                <div class="inspector-info">
                    <div>
                        <div class="inspector-name">Sin asignar</div>
                        <div class="inspector-role">OIs sin inspector</div>
                    </div>
                    <div class="inspector-counter unassigned" id="counter-unassigned">0</div>
                </div>
                <div class="inspector-menu" id="menu-unassigned">
                    <div class="inspector-menu-item" data-action="filter">Filtrar OIs sin asignar</div>
                    <div class="inspector-menu-item" data-action="assign">Desasignar OIs</div>
                </div>
            </div>
            <div class="inspector-card" data-inspector-id="1">
                <div class="inspector-info">
                    <div>
                        <div class="inspector-name">Carlos Mendoza</div>
                        <div class="inspector-role">Inspector Senior</div>
                    </div>
                    <div class="inspector-counter zero" id="counter-1">0</div>
                </div>
                <div class="inspector-menu" id="menu-1">
                    <div class="inspector-menu-item" data-action="filter">Filtrar OIs asignadas</div>
                    <div class="inspector-menu-item" data-action="assign">Asignar OIs</div>
                    <div class="inspector-menu-item" data-action="remove">Desasignar OIs</div>
                    <div class="inspector-menu-item" data-action="reassign">Reasignar OIs</div>
                </div>
            </div>
            <div class="inspector-card" data-inspector-id="2">
                <div class="inspector-info">
                    <div>
                        <div class="inspector-name">Mar√≠a Gonz√°lez</div>
                        <div class="inspector-role">Inspector Junior</div>
                    </div>
                    <div class="inspector-counter zero" id="counter-2">0</div>
                </div>
                <div class="inspector-menu" id="menu-2">
                    <div class="inspector-menu-item" data-action="filter">Filtrar OIs asignadas</div>
                    <div class="inspector-menu-item" data-action="assign">Asignar OIs</div>
                    <div class="inspector-menu-item" data-action="remove">Desasignar OIs</div>
                    <div class="inspector-menu-item" data-action="reassign">Reasignar OIs</div>
                </div>
            </div>
            <div class="inspector-card" data-inspector-id="3">
                <div class="inspector-info">
                    <div>
                        <div class="inspector-name">Pedro S√°nchez</div>
                        <div class="inspector-role">Inspector Senior</div>
                    </div>
                    <div class="inspector-counter zero" id="counter-3">0</div>
                </div>
                <div class="inspector-menu" id="menu-3">
                    <div class="inspector-menu-item" data-action="filter">Filtrar OIs asignadas</div>
                    <div class="inspector-menu-item" data-action="assign">Asignar OIs</div>
                    <div class="inspector-menu-item" data-action="remove">Desasignar OIs</div>
                    <div class="inspector-menu-item" data-action="reassign">Reasignar OIs</div>
                </div>
            </div>
            <div class="inspector-card" data-inspector-id="4">
                <div class="inspector-info">
                    <div>
                        <div class="inspector-name">Ana Rodr√≠guez</div>
                        <div class="inspector-role">Inspector Junior</div>
                    </div>
                    <div class="inspector-counter zero" id="counter-4">0</div>
                </div>
                <div class="inspector-menu" id="menu-4">
                    <div class="inspector-menu-item" data-action="filter">Filtrar OIs asignadas</div>
                    <div class="inspector-menu-item" data-action="assign">Asignar OIs</div>
                    <div class="inspector-menu-item" data-action="remove">Desasignar OIs</div>
                    <div class="inspector-menu-item" data-action="reassign">Reasignar OIs</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1>Calendario</h1>
        </div>

        <div class="content">
            <div class="filters-panel">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="filterProject">Proyecto/Campa√±a</label>
                        <select id="filterProject" class="filter-select">
                            <option value="">Todos</option>
                            <option>Campa√±a A</option>
                            <option>Proyecto Norte</option>
                            <option>Campa√±a Invierno</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterZone">Zona</label>
                        <select id="filterZone" class="filter-select">
                            <option value="">Todas</option>
                            <option>Zona A_Antofagasta</option>
                            <option>Zona A_Arica</option>
                            <option>Zona A_Iquique</option>
                            <option>Zona B_Calama 2 SGS-CIMM</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterSupervisor">Supervisor</label>
                        <select id="filterSupervisor" class="filter-select">
                            <option value="">Todos</option>
                            <option>Jorge Andres Alegria Morales</option>
                            <option>Jose Benedicto Figueroa</option>
                            <option>Yessenia Gajardo Casanova</option>
                            <option>Cynthia Ocaranza Grez</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="filter-action primary" type="button">Buscar</button>
                        <button class="filter-action secondary" type="button" id="toggleFilters">Ver mas</button>
                    </div>
                </div>

                <div class="filters-advanced" id="advancedFilters">
                    <div class="filter-group">
                        <label for="filterOi">Codigo OI</label>
                        <input id="filterOi" class="filter-input" type="text" placeholder="Buscar OI">
                    </div>
                    <div class="filter-group">
                        <label for="filterOl">Codigo OL</label>
                        <input id="filterOl" class="filter-input" type="text" placeholder="Buscar OL">
                    </div>
                    <div class="filter-group">
                        <label for="filterCliente">Cliente</label>
                        <input id="filterCliente" class="filter-input" type="text" placeholder="Buscar cliente">
                    </div>
                    <div class="filter-group">
                        <label for="filterEtfa">ETFA</label>
                        <select id="filterEtfa" class="filter-select">
                            <option value="">Todos</option>
                            <option>Si</option>
                            <option>No</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterTipoOi">Tipo de OI</label>
                        <select id="filterTipoOi" class="filter-select">
                            <option value="">Todos</option>
                            <option>Muestreo y Medicion</option>
                            <option>Solo muestreo</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterMatriz">Matriz</label>
                        <select id="filterMatriz" class="filter-select">
                            <option value="">Todas</option>
                            <option>Agua</option>
                            <option>Suelo</option>
                            <option>Aire</option>
                            <option>Sedimento</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterMuestreoId">ID Muestreo</label>
                        <input id="filterMuestreoId" class="filter-input" type="text" placeholder="ID Muestreo">
                    </div>
                </div>
            </div>

            <div class="calendar-card">
                <div class="calendar-controls">
                    <div class="view-filters">
                        <button class="filter-btn active">Mes</button>
                        <button class="filter-btn">Semana</button>
                        <button class="filter-btn">D√≠a</button>
                    </div>

                    <div class="calendar-nav">
                        <button class="today-btn">Hoy</button>
                        <button class="nav-btn">¬´</button>
                        <button class="nav-btn">‚Äπ</button>
                        <div class="month-display">diciembre 2025</div>
                        <button class="nav-btn">‚Ä∫</button>
                        <button class="nav-btn">¬ª</button>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot etfa"></div>
                        <span>ETFA</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot medicion"></div>
                        <span>Solo medici√≥n</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot no-autorizado"></div>
                        <span>Plan ETFA no autorizado</span>
                    </div>
                </div>

                <div class="calendar-grid" id="calendar">
                    <div class="day-header">LUNES</div>
                    <div class="day-header">MARTES</div>
                    <div class="day-header">MI√âRCOLES</div>
                    <div class="day-header">JUEVES</div>
                    <div class="day-header">VIERNES</div>
                    <div class="day-header">S√ÅBADO</div>
                    <div class="day-header">DOMINGO</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal OI Detail -->
    <div class="modal-overlay" id="oiModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeModal()">&times;</button>
                <div class="modal-header-content">
                    <div class="modal-title-block">
                        <h2 id="modalTitle">CLIENTE / 0/1<br>OL: 800504 / OI: 200419</h2>
                        <div class="modal-date" id="modalDate">11-12-2024</div>
                    </div>
                    <div class="modal-center">
                        <div class="modal-contact" id="modalContact">
                            <span>Contacto: Juan P√©rez</span>
                            <span>Tel√©fono: +56 9 1234 5678</span>
                        </div>
                    </div>
                    <div class="modal-badge-wrap">
                        <span class="modal-badge" id="modalBadge">Muestreo y Medici√≥n</span>
                    </div>
                </div>
            </div>

            <div class="modal-body">
                <!-- Usuarios/Roles asignados -->
                <div class="modal-section">
                    <div class="modal-section-title">Usuarios asignados</div>
                    <div class="modal-roles-list" id="modalRolesList"></div>
                </div>

                    <table class="muestras-table">
                        <thead>
                            <tr>
                                <th>Punto de muestra</th>
                                <th>Matriz</th>
                                <th>Plan</th>
                                <th>ETFA</th>
                                <th>TIPO</th>
                                <th>Estado</th>
                                <th>Emerg</th>
                            </tr>
                        </thead>
                        <tbody id="muestrasTableBody">
                            <tr>
                                <td>PM-001</td>
                                <td>Agua</td>
                                <td>Plan A</td>
                                <td>Si</td>
                                <td>Puntual</td>
                                <td><span class="status-badge status-programado">Programado</span></td>
                                <td>No</td>
                            </tr>
                            <tr>
                                <td>PM-002</td>
                                <td>Suelo</td>
                                <td>Plan C</td>
                                <td>No</td>
                                <td>Compuesta</td>
                                <td><span class="status-badge status-en-proceso">En proceso</span></td>
                                <td>Si</td>
                            </tr>
                            <tr>
                                <td>PM-003</td>
                                <td>Aire</td>
                                <td>Plan D</td>
                                <td>Si</td>
                                <td>Puntual</td>
                                <td><span class="status-badge status-recepcionado">Recepcionado</span></td>
                                <td>No</td>
                            </tr>
                        </tbody>
                    </table>
            </div>

            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeModal()">Cerrar</button>
                <button class="modal-btn primary">Editar</button>
            </div>
        </div>
    </div>

        <div class="assignment-lock-overlay" id="assignmentLockOverlay">
        <div class="assignment-lock-message" id="assignmentLockMessage">Modo asignaci√≥n activo</div>
        </div>

    <!-- Floating Assignment Bar -->
        <div class="assignment-floating-bar" id="floatingBar">
        <div class="floating-bar-info">
            <div class="floating-bar-inspector">
                <div class="floating-bar-inspector-icon" id="floatingBarInitials">CM</div>
                <div>
                    <div class="floating-bar-inspector-label" id="floatingBarLabel">Asignando a:</div>
                    <div class="floating-bar-inspector-name" id="floatingBarName">Carlos Mendoza</div>
                </div>
            </div>
            <div class="floating-bar-counter">
                <div class="counter-number" id="floatingBarCounter">0</div>
                <div class="counter-label">OIs<br>seleccionadas</div>
            </div>
        </div>
        <div class="floating-bar-actions">
            <button class="floating-bar-btn cancel" onclick="cancelAssignment()">Cancelar</button>
            <button class="floating-bar-btn confirm" id="confirmBtn" onclick="confirmAssignment()">Confirmar</button>
        </div>
    </div>

    <script>
        // Datos de ejemplo para el calendario
        const assignments = {
            1: [
                { company: 'ANGLO', code: '0/1\n800504 / 200419', status: 'normal', inspectorId: '1' },
                { company: 'ANGLO', code: '0/1\n800744 / 199351', status: 'normal', inspectorId: '1' },
                { company: 'ANGLO', code: '0/1\n800744 / 199495', status: 'normal', inspectorId: '2' },
                { company: 'ANGLO', code: '0/10\n800502 / 200434', status: 'normal' },
                { company: 'ANGLO', code: '0/2\n800744 / 200438', status: 'normal' }
            ],
            2: [
                { company: 'COMPA√ë', code: '0/1\n801387 / 213311', status: 'normal', inspectorId: '1' },
                { company: 'COMPA√ë', code: '0/2\n801387 / 213316', status: 'normal' },
                { company: 'COMPA√ë', code: '0/3\n801387 / 213329', status: 'normal', inspectorId: '3' }
            ],
            3: [
                { company: 'COMPA√ë', code: '0/1\n801387 / 213410', status: 'normal', inspectorId: '2' },
                { company: 'COMPA√ë', code: '0/2\n801387 / 213413', status: 'normal' },
                { company: 'COMPA√ë', code: '0/3\n801387 / 213418', status: 'normal', inspectorId: '4' }
            ],
            5: [
                { company: 'COMPA√ë', code: '0/12\n801387 / 213348', status: 'normal' },
                { company: 'MINERA', code: '0/14\n800910 / 135435', status: 'normal', inspectorId: '3' },
                { company: 'MINERA', code: '0/2\n740415 / 213378', status: 'normal' }
            ],
            6: [
                { company: 'MINERA', code: '0/1\n800910 / 135751', status: 'normal', inspectorId: '4' },
                { company: 'MINERA', code: '0/14\n800910 / 135436', status: 'normal' }
            ],
            7: [
                { company: 'MINERA', code: '0/14\n800910 / 135427', status: 'normal', inspectorId: '3' },
                { company: 'MINERA', code: '0/7\n800910 / 135053', status: 'normal' }
            ]
        };

        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const daysInMonth = 31;
            const startDay = 1; // Lunes (0=domingo, 1=lunes, etc.)

            // Agregar celdas vac√≠as para los d√≠as anteriores al 1
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell';
                calendar.appendChild(emptyCell);
            }

            // Generar d√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.dataset.day = day;
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Agregar asignaciones si existen para este d√≠a
                if (assignments[day]) {
                    assignments[day].forEach(assignment => {
                        const assignmentDiv = document.createElement('div');
                        assignmentDiv.className = 'assignment';
                        
                        if (assignment.status === 'pending') {
                            assignmentDiv.classList.add('pending');
                        }
                        
                        if (day <= 3 && assignment.company === 'ANGLO') {
                            assignmentDiv.classList.add('has-dot', 'green');
                        }
                        
                        assignmentDiv.innerHTML = `
                            <div class="company">${assignment.company}_ ${assignment.code.split('\n')[0]}</div>
                            <div class="code">${assignment.code.split('\n')[1]}</div>
                        `;

                        // Si ya tiene inspector asignado, marcar como assigned
                        const inspectorIds = Array.isArray(assignment.inspectorIds)
                            ? assignment.inspectorIds
                            : (assignment.inspectorId ? [assignment.inspectorId] : []);
                        if (inspectorIds.length > 0) {
                            assignmentDiv.classList.add('assigned');
                            assignmentDiv.dataset.inspectorIds = inspectorIds.join(',');
                            assignmentDiv.dataset.inspectorId = inspectorIds[0];
                        }

                        // Hacer la tarjeta draggable
                        assignmentDiv.draggable = true;
                        assignmentDiv.dataset.day = day;
                        assignmentDiv.dataset.index = assignments[day].indexOf(assignment);

                        dayCell.appendChild(assignmentDiv);
                    });
                }

                calendar.appendChild(dayCell);
            }
        }

        // Generar el calendario al cargar la p√°gina
        generateCalendar();

        // Funcionalidad de los botones de navegaci√≥n
        document.querySelectorAll('.nav-btn, .today-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                console.log('Navegaci√≥n de calendario:', this.textContent);
            });
        });

        // Funcionalidad de filtros de vista
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                console.log('Vista cambiada a:', this.textContent);
            });
        });

        // ==========================================
        // Drag and Drop Functionality
        // ==========================================
        let draggedElement = null;
        let sourceDay = null;
        let sourceIndex = null;

        // Event delegation para drag events en assignments
        document.getElementById('calendar').addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('assignment')) {
                if (assignmentMode) {
                    e.preventDefault();
                    return;
                }
                draggedElement = e.target;
                sourceDay = parseInt(e.target.dataset.day);
                sourceIndex = parseInt(e.target.dataset.index);

                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            }
        });

        document.getElementById('calendar').addEventListener('dragend', function(e) {
            if (e.target.classList.contains('assignment')) {
                e.target.classList.remove('dragging');
                draggedElement = null;

                // Remover clase drag-over de todas las celdas
                document.querySelectorAll('.day-cell').forEach(cell => {
                    cell.classList.remove('drag-over');
                });
            }
        });

        // Eventos para las celdas del calendario
        document.getElementById('calendar').addEventListener('dragover', function(e) {
            if (assignmentMode) return;
            const dayCell = e.target.closest('.day-cell');
            if (dayCell && dayCell.dataset.day) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                dayCell.classList.add('drag-over');
            }
        });

        document.getElementById('calendar').addEventListener('dragleave', function(e) {
            const dayCell = e.target.closest('.day-cell');
            if (dayCell) {
                // Verificar si realmente salimos de la celda
                const relatedTarget = e.relatedTarget;
                if (!dayCell.contains(relatedTarget)) {
                    dayCell.classList.remove('drag-over');
                }
            }
        });

        document.getElementById('calendar').addEventListener('drop', function(e) {
            e.preventDefault();
            if (assignmentMode) return;
            const dayCell = e.target.closest('.day-cell');

            if (dayCell && dayCell.dataset.day && draggedElement) {
                const targetDay = parseInt(dayCell.dataset.day);

                // No hacer nada si es el mismo d√≠a
                if (targetDay === sourceDay) {
                    dayCell.classList.remove('drag-over');
                    return;
                }

                // Mover el assignment en los datos
                const assignmentToMove = assignments[sourceDay][sourceIndex];

                // Remover del d√≠a origen
                assignments[sourceDay].splice(sourceIndex, 1);
                if (assignments[sourceDay].length === 0) {
                    delete assignments[sourceDay];
                }

                // Agregar al d√≠a destino
                if (!assignments[targetDay]) {
                    assignments[targetDay] = [];
                }
                assignments[targetDay].push(assignmentToMove);

                // Actualizar el DOM - mover el elemento
                draggedElement.dataset.day = targetDay;
                draggedElement.dataset.index = assignments[targetDay].length - 1;
                dayCell.appendChild(draggedElement);

                // Actualizar los √≠ndices de los elementos restantes en el d√≠a origen
                document.querySelectorAll(`.assignment[data-day="${sourceDay}"]`).forEach((el, idx) => {
                    el.dataset.index = idx;
                });

                dayCell.classList.remove('drag-over');

                console.log(`Tarea movida del d√≠a ${sourceDay} al d√≠a ${targetDay}`);
            }
        });

        // ==========================================
        // Inspector Menu & Assignment Functionality
        // ==========================================
        let selectedInspectorId = null;
        let selectedInspectorName = null;
        let assignmentMode = false;
        let assignmentModeType = null;
        let currentFilter = null;
        let pendingAssignments = []; // Tarjetas pendientes de confirmar

        function getInspectorIdsFromElement(assignmentEl) {
            if (assignmentEl.dataset.inspectorIds) {
                return assignmentEl.dataset.inspectorIds.split(',').map(id => id.trim()).filter(Boolean);
            }
            if (assignmentEl.dataset.inspectorId) {
                return [assignmentEl.dataset.inspectorId];
            }
            return [];
        }

        function setInspectorIdsOnElement(assignmentEl, ids) {
            if (ids.length > 0) {
                assignmentEl.dataset.inspectorIds = ids.join(',');
                assignmentEl.dataset.inspectorId = ids[0];
                assignmentEl.classList.add('assigned');
            } else {
                delete assignmentEl.dataset.inspectorIds;
                delete assignmentEl.dataset.inspectorId;
                assignmentEl.classList.remove('assigned');
            }
        }

        // Mostrar/ocultar men√∫ al hacer clic en inspector
        document.querySelectorAll('.inspector-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.classList.contains('inspector-menu-item')) return;

                const inspectorId = this.dataset.inspectorId;
                const menu = this.querySelector('.inspector-menu');

                // Cerrar otros men√∫s
                document.querySelectorAll('.inspector-menu').forEach(m => {
                    if (m !== menu) m.classList.remove('show');
                });

                // Toggle men√∫ actual
                menu.classList.toggle('show');
            });
        });

        // Manejar acciones del men√∫
        document.querySelectorAll('.inspector-menu-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.stopPropagation();
                const action = this.dataset.action;
                const card = this.closest('.inspector-card');
                const inspectorId = card.dataset.inspectorId;
                const inspectorName = card.querySelector('.inspector-name').textContent;

                // Cerrar men√∫
                this.closest('.inspector-menu').classList.remove('show');

                switch(action) {
                    case 'filter':
                        filterByInspector(inspectorId, inspectorName);
                        break;
                    case 'assign':
                        if (inspectorId === 'unassigned') {
                            enterUnassignMode();
                        } else {
                            enterAssignmentMode(inspectorId, inspectorName);
                        }
                        break;
                    case 'remove':
                        if (inspectorId !== 'unassigned') {
                            enterRemoveInspectorMode(inspectorId, inspectorName);
                        }
                        break;
                    case 'reassign':
                        if (inspectorId !== 'unassigned') {
                            enterReassignMode(inspectorId, inspectorName);
                        }
                        break;
                }
            });
        });

        // Filtrar por inspector
        function filterByInspector(inspectorId, inspectorName) {
            currentFilter = inspectorId;

            // Marcar inspector como seleccionado
            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-inspector-id="${inspectorId}"]`).classList.add('selected');

            // Filtrar tarjetas
            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                const shouldShow = inspectorId === 'unassigned'
                    ? inspectorIds.length === 0
                    : inspectorIds.includes(inspectorId);
                assignment.classList.toggle('filtered-out', !shouldShow);
            });

            console.log(`Filtrando por inspector: ${inspectorName}`);
        }

        // Quitar filtro
        function clearFilter() {
            currentFilter = null;
            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.assignment').forEach(a => a.classList.remove('filtered-out'));
            console.log('Filtro eliminado');
        }

        const clearInspectorFilterBtn = document.getElementById('clearInspectorFilter');
        if (clearInspectorFilterBtn) {
            clearInspectorFilterBtn.addEventListener('click', function() {
                if (!assignmentMode) {
                    clearFilter();
                }
            });
        }

        // Obtener iniciales del nombre
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        }

        // Actualizar contador en la barra flotante
        function updateFloatingBarCounter() {
            const count = pendingAssignments.length;
            document.getElementById('floatingBarCounter').textContent = count;
            document.getElementById('confirmBtn').disabled = count === 0;
        }

        // Actualizar contadores de OIs en las tarjetas de inspectores
        function updateInspectorCounters() {
            // Contar OIs asignadas a cada inspector
            const counts = { '1': 0, '2': 0, '3': 0, '4': 0, 'unassigned': 0 };

            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                if (inspectorIds.length > 0) {
                    inspectorIds.forEach(id => {
                        if (counts.hasOwnProperty(id)) {
                            counts[id]++;
                        }
                    });
                } else {
                    counts.unassigned++;
                }
            });

            // Actualizar los contadores en el DOM
            Object.keys(counts).forEach(id => {
                const counterEl = document.getElementById(`counter-${id}`);
                if (counterEl) {
                    counterEl.textContent = counts[id];
                    if (counts[id] === 0) {
                        counterEl.classList.add('zero');
                    } else {
                        counterEl.classList.remove('zero');
                    }
                }
            });
        }

        // Entrar en modo asignaci√≥n
        function enterAssignmentMode(inspectorId, inspectorName) {
            assignmentMode = true;
            assignmentModeType = 'assign';
            selectedInspectorId = inspectorId;
            selectedInspectorName = inspectorName;
            pendingAssignments = [];
            document.body.classList.add('assignment-locked');
            document.getElementById('assignmentLockOverlay').classList.add('show');
            document.getElementById('assignmentLockMessage').textContent = 'Modo asignaci√≥n activo';
            document.getElementById('floatingBarLabel').textContent = 'Asignando a:';

            // Mostrar barra flotante
            document.getElementById('floatingBar').classList.add('show');
            document.getElementById('floatingBarName').textContent = inspectorName;
            document.getElementById('floatingBarInitials').textContent = getInitials(inspectorName);
            updateFloatingBarCounter();

            // Ocultar banner peque√±o
            document.getElementById('assignmentBanner').classList.remove('show');

            // Marcar inspector
            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-inspector-id="${inspectorId}"]`).classList.add('selected');

            // Marcar tarjetas que no tienen este inspector como seleccionables
            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                if (inspectorIds.includes(inspectorId)) {
                    assignment.classList.remove('selectable');
                    assignment.classList.add('blocked');
                } else {
                    assignment.classList.remove('blocked');
                    assignment.classList.add('selectable');
                }
            });

            console.log(`Modo asignaci√≥n activado para: ${inspectorName}`);
        }

        function enterReassignMode(inspectorId, inspectorName) {
            assignmentMode = true;
            assignmentModeType = 'reassign';
            selectedInspectorId = inspectorId;
            selectedInspectorName = inspectorName;
            pendingAssignments = [];
            document.body.classList.add('assignment-locked');
            document.getElementById('assignmentLockOverlay').classList.add('show');
            document.getElementById('assignmentLockMessage').textContent = 'Modo reasignaci√≥n activo';
            document.getElementById('floatingBarLabel').textContent = 'Reasignando a:';

            document.getElementById('floatingBar').classList.add('show');
            document.getElementById('floatingBarName').textContent = inspectorName;
            document.getElementById('floatingBarInitials').textContent = getInitials(inspectorName);
            updateFloatingBarCounter();

            document.getElementById('assignmentBanner').classList.remove('show');

            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-inspector-id="${inspectorId}"]`).classList.add('selected');

            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                const isOnlySelected = inspectorIds.length === 1 && inspectorIds[0] === inspectorId;
                if (isOnlySelected) {
                    assignment.classList.remove('selectable');
                    assignment.classList.add('blocked');
                } else {
                    assignment.classList.remove('blocked');
                    assignment.classList.add('selectable');
                }
            });

            console.log(`Modo reasignaci√≥n activado para: ${inspectorName}`);
        }

        function enterRemoveInspectorMode(inspectorId, inspectorName) {
            assignmentMode = true;
            assignmentModeType = 'remove';
            selectedInspectorId = inspectorId;
            selectedInspectorName = inspectorName;
            pendingAssignments = [];
            document.body.classList.add('assignment-locked');
            document.getElementById('assignmentLockOverlay').classList.add('show');
            document.getElementById('assignmentLockMessage').textContent = 'Modo desasignaci√≥n activo';
            document.getElementById('floatingBarLabel').textContent = 'Desasignando a:';

            document.getElementById('floatingBar').classList.add('show');
            document.getElementById('floatingBarName').textContent = inspectorName;
            document.getElementById('floatingBarInitials').textContent = getInitials(inspectorName);
            updateFloatingBarCounter();

            document.getElementById('assignmentBanner').classList.remove('show');

            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-inspector-id="${inspectorId}"]`).classList.add('selected');

            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                if (inspectorIds.includes(inspectorId)) {
                    assignment.classList.add('selectable');
                    assignment.classList.remove('blocked');
                } else {
                    assignment.classList.remove('selectable');
                    assignment.classList.add('blocked');
                }
            });

            console.log(`Modo desasignaci√≥n activado para: ${inspectorName}`);
        }

        function enterUnassignMode() {
            assignmentMode = true;
            assignmentModeType = 'unassign';
            selectedInspectorId = null;
            selectedInspectorName = 'Sin asignar';
            pendingAssignments = [];
            document.body.classList.add('assignment-locked');
            document.getElementById('assignmentLockOverlay').classList.add('show');
            document.getElementById('assignmentLockMessage').textContent = 'Modo desasignaci√≥n activo';
            document.getElementById('floatingBarLabel').textContent = 'Desasignando a:';

            document.getElementById('floatingBar').classList.add('show');
            document.getElementById('floatingBarName').textContent = selectedInspectorName;
            document.getElementById('floatingBarInitials').textContent = getInitials(selectedInspectorName);
            updateFloatingBarCounter();

            document.getElementById('assignmentBanner').classList.remove('show');

            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelector('[data-inspector-id="unassigned"]').classList.add('selected');

            document.querySelectorAll('.assignment').forEach(assignment => {
                const inspectorIds = getInspectorIdsFromElement(assignment);
                if (inspectorIds.length > 0) {
                    assignment.classList.add('selectable');
                    assignment.classList.remove('blocked');
                } else {
                    assignment.classList.remove('selectable');
                    assignment.classList.add('blocked');
                }
            });

            console.log('Modo desasignaci√≥n activado');
        }

        // Cancelar asignaci√≥n (deshacer todas las selecciones pendientes)
        function cancelAssignment() {
            // Revertir las tarjetas pendientes a su estado original
            pendingAssignments.forEach(assignment => {
                assignment.classList.remove('pending-assign');
                assignment.classList.add('selectable');
                delete assignment.dataset.tempInspectorId;
            });

            pendingAssignments = [];
            exitAssignmentMode();
        }

        // Confirmar asignaci√≥n
        function confirmAssignment() {
            if (pendingAssignments.length === 0) return;

            if (assignmentModeType === 'unassign') {
                pendingAssignments.forEach(assignment => {
                    setInspectorIdsOnElement(assignment, []);
                    assignment.classList.remove('pending-assign');
                    assignment.classList.remove('selectable');

                    const day = parseInt(assignment.dataset.day);
                    const index = parseInt(assignment.dataset.index);
                    if (assignments[day] && assignments[day][index]) {
                        delete assignments[day][index].inspectorId;
                        delete assignments[day][index].inspectorIds;
                        assignments[day][index].status = 'normal';
                    }
                });

                console.log(`${pendingAssignments.length} OIs desasignadas`);
                updateInspectorCounters();
                pendingAssignments = [];
                exitAssignmentMode();
                return;
            }

            if (assignmentModeType === 'reassign') {
                pendingAssignments.forEach(assignment => {
                    assignment.classList.remove('pending-assign');
                    assignment.classList.remove('selectable');
                    assignment.classList.remove('blocked');

                    const day = parseInt(assignment.dataset.day);
                    const index = parseInt(assignment.dataset.index);
                    if (assignments[day] && assignments[day][index]) {
                        assignments[day][index].inspectorIds = [selectedInspectorId];
                        assignments[day][index].inspectorId = selectedInspectorId;
                        assignments[day][index].status = 'pending';
                        setInspectorIdsOnElement(assignment, [selectedInspectorId]);
                    }
                });

                console.log(`${pendingAssignments.length} OIs reasignadas a ${selectedInspectorName}`);
                updateInspectorCounters();
                pendingAssignments = [];
                exitAssignmentMode();
                return;
            }

            if (assignmentModeType === 'remove') {
                pendingAssignments.forEach(assignment => {
                    assignment.classList.remove('pending-assign');
                    assignment.classList.remove('selectable');
                    assignment.classList.remove('blocked');

                    const day = parseInt(assignment.dataset.day);
                    const index = parseInt(assignment.dataset.index);
                    if (assignments[day] && assignments[day][index]) {
                        const assignmentData = assignments[day][index];
                        const ids = Array.isArray(assignmentData.inspectorIds)
                            ? assignmentData.inspectorIds
                            : (assignmentData.inspectorId ? [assignmentData.inspectorId] : []);
                        const filtered = ids.filter(id => id !== selectedInspectorId);
                        assignmentData.inspectorIds = filtered.length ? filtered : undefined;
                        assignmentData.inspectorId = filtered.length ? filtered[0] : undefined;
                        assignmentData.status = 'normal';
                        setInspectorIdsOnElement(assignment, filtered);
                    }
                });

                console.log(`${pendingAssignments.length} OIs desasignadas de ${selectedInspectorName}`);
                updateInspectorCounters();
                pendingAssignments = [];
                exitAssignmentMode();
                return;
            }

            // Confirmar todas las asignaciones pendientes
            pendingAssignments.forEach(assignment => {
                assignment.classList.remove('pending-assign');
                assignment.classList.remove('selectable');
                assignment.classList.remove('blocked');

                // Actualizar datos
                const day = parseInt(assignment.dataset.day);
                const index = parseInt(assignment.dataset.index);
                if (assignments[day] && assignments[day][index]) {
                    const assignmentData = assignments[day][index];
                    const ids = Array.isArray(assignmentData.inspectorIds)
                        ? assignmentData.inspectorIds
                        : (assignmentData.inspectorId ? [assignmentData.inspectorId] : []);
                    if (!ids.includes(selectedInspectorId)) {
                        ids.push(selectedInspectorId);
                    }
                    assignmentData.inspectorIds = ids;
                    assignmentData.inspectorId = ids[0];
                    assignments[day][index].status = 'pending';
                    setInspectorIdsOnElement(assignment, ids);
                }
            });

            console.log(`${pendingAssignments.length} OIs asignadas a ${selectedInspectorName}`);

            // Actualizar contadores de inspectores
            updateInspectorCounters();

            pendingAssignments = [];
            exitAssignmentMode();
        }

        // Salir del modo asignaci√≥n
        function exitAssignmentMode() {
            assignmentMode = false;
            assignmentModeType = null;
            selectedInspectorId = null;
            selectedInspectorName = null;
            document.body.classList.remove('assignment-locked');
            document.getElementById('assignmentLockOverlay').classList.remove('show');
            document.getElementById('floatingBarLabel').textContent = 'Asignando a:';
            document.getElementById('assignmentLockMessage').textContent = 'Modo asignaci√≥n activo';

            document.getElementById('floatingBar').classList.remove('show');
            document.getElementById('assignmentBanner').classList.remove('show');
            document.querySelectorAll('.inspector-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.assignment').forEach(a => {
                a.classList.remove('selectable');
                a.classList.remove('blocked');
            });

            console.log('Modo asignaci√≥n desactivado');
        }

        // Cerrar men√∫s al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.inspector-card')) {
                document.querySelectorAll('.inspector-menu').forEach(m => m.classList.remove('show'));
            }
        });

        // Actualizar contadores al cargar la p√°gina
        updateInspectorCounters();

        // ==========================================
        // Modal Functionality
        // ==========================================

        // Datos de ejemplo para el detalle de muestras
        const oiDetails = {
            'ANGLO': {
                contact: 'Roberto Silva',
                phone: '+56 9 8765 4321',
                badge: 'ETFA',
                muestras: [
                    { nombre: 'PM-001', tipo: 'Agua Subterr√°nea', tipoInforme: 'Est√°ndar', estado: 'Pendiente' },
                    { nombre: 'PM-002', tipo: 'Suelo', tipoInforme: 'Completo', estado: 'En proceso' }
                ],
                tablaDetalle: [
                    { punto: 'PM-001', matriz: 'Agua', plan: 'Plan Monitoreo A', etfa: true, tipo: 'Puntual', estado: 'Programado', emergencia: 'No' },
                    { punto: 'PM-002', matriz: 'Suelo', plan: 'Plan Suelo B', etfa: false, tipo: 'Compuesta', estado: 'En proceso', emergencia: 'Si' }
                ]
            },
            'COMPA√ë': {
                contact: 'Mar√≠a Torres',
                phone: '+56 9 1234 5678',
                badge: 'SOLO MEDICI√ìN',
                muestras: [
                    { nombre: 'PM-100', tipo: 'Aire', tipoInforme: 'B√°sico', estado: 'Completado' },
                    { nombre: 'PM-101', tipo: 'Agua', tipoInforme: 'Est√°ndar', estado: 'Pendiente' },
                    { nombre: 'PM-102', tipo: 'Sedimento', tipoInforme: 'Completo', estado: 'En proceso' }
                ],
                tablaDetalle: [
                    { punto: 'PM-100', matriz: 'Aire', plan: 'Plan Emisiones', etfa: true, tipo: 'Puntual', estado: 'Programado', emergencia: 'No' },
                    { punto: 'PM-101', matriz: 'Agua', plan: 'Plan Efluentes', etfa: true, tipo: 'Compuesta', estado: 'En proceso', emergencia: 'No' },
                    { punto: 'PM-102', matriz: 'Sedimento', plan: 'Plan Sedimentos', etfa: false, tipo: 'Puntual', estado: 'Recepcionado', emergencia: 'Si' }
                ]
            },
            'MINERA': {
                contact: 'Carlos Vega',
                phone: '+56 9 5555 6666',
                badge: 'ETFA + MEDICI√ìN',
                muestras: [
                    { nombre: 'PM-200', tipo: 'Agua Industrial', tipoInforme: 'Completo', estado: 'Pendiente' },
                    { nombre: 'PM-201', tipo: 'Residuo', tipoInforme: 'Especial', estado: 'Pendiente' }
                ],
                tablaDetalle: [
                    { punto: 'PM-200', matriz: 'Agua', plan: 'Plan RILES', etfa: true, tipo: 'Compuesta', estado: 'En proceso', emergencia: 'No' },
                    { punto: 'PM-201', matriz: 'Residuo', plan: 'Plan RISES', etfa: false, tipo: 'Puntual', estado: 'Programado', emergencia: 'No' }
                ]
            }
        };

        const inspectorNames = {
            '1': 'Carlos Mendoza',
            '2': 'Mar√≠a Gonz√°lez',
            '3': 'Pedro S√°nchez',
            '4': 'Ana Rodr√≠guez'
        };

        const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        function openModal(assignmentEl) {
            const company = assignmentEl.querySelector('.company').textContent.split('_')[0].trim();
            const codeText = assignmentEl.querySelector('.company').textContent;
            const code = assignmentEl.querySelector('.code').textContent;
            const day = parseInt(assignmentEl.dataset.day);
            const inspectorId = assignmentEl.dataset.inspectorId;

            // Obtener datos de la OI
            const details = oiDetails[company] || oiDetails['ANGLO'];

            // Actualizar t√≠tulo
            const olOi = code.split(' / ');
            document.getElementById('modalTitle').innerHTML = `${company} / ${codeText.split('_')[1] || '0/1'}<br>OL: ${olOi[0]} / OI: ${olOi[1] || olOi[0]}`;

            // Actualizar fecha (usando diciembre 2025 como en el calendario)
            const date = new Date(2025, 11, day); // Diciembre 2025
            const dd = String(date.getDate()).padStart(2, '0');
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();
            document.getElementById('modalDate').textContent = `${dd}-${mm}-${yyyy}`;

            // Actualizar contacto
            document.getElementById('modalContact').innerHTML = `<span>Contacto: ${details.contact}</span><span>Tel√©fono: ${details.phone}</span>`;

            // Actualizar badge
            document.getElementById('modalBadge').textContent = 'Muestreo y Medici√≥n';

            // Actualizar roles asignados
            const modalRolesList = document.getElementById('modalRolesList');
            const inspectorIds = getInspectorIdsFromElement(assignmentEl);
            const inspectorsHtml = inspectorIds.length
                ? inspectorIds.map(id => `
                    <div class="modal-role-tag assigned">
                        <span class="role-icon inspector" aria-hidden="true"></span>
                        Inspector: ${inspectorNames[id] || id}
                    </div>
                `).join('')
                : `
                    <div class="modal-role-tag">
                        <span class="role-icon inspector" aria-hidden="true"></span>
                        Inspector: Sin inspector/es asociado/s
                    </div>
                `;
            modalRolesList.innerHTML = `
                <div class="modal-role-tag"><span class="role-icon coordinator" aria-hidden="true"></span>Coordinador: Romina Gonzalez Lopez</div>
                <div class="modal-role-tag"><span class="role-icon supervisor" aria-hidden="true"></span>Supervisor: Jorge Alegria</div>
                ${inspectorsHtml}
            `;

            // Actualizar tabla de muestras (Tab Detalle Muestras)
            const tableBody = document.getElementById('muestrasTableBody');
            const statusClassMap = {
                'Programado': 'status-programado',
                'En proceso': 'status-en-proceso',
                'Recepcionado': 'status-recepcionado'
            };

            tableBody.innerHTML = details.tablaDetalle.map(m => `
                <tr>
                    <td>${m.punto}</td>
                    <td>${m.matriz}</td>
                    <td>${m.plan}</td>
                    <td>${m.etfa ? 'Si' : 'No'}</td>
                    <td>${m.tipo}</td>
                    <td><span class="status-badge ${statusClassMap[m.estado] || ''}">${m.estado}</span></td>
                    <td>${m.emergencia}</td>
                </tr>
            `).join('');

            // Mostrar modal
            document.getElementById('oiModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('oiModal').classList.remove('show');
        }

        function switchTab(tabName) {
            // Actualizar tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Actualizar contenido
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tabName}`);
            });
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('oiModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Modificar el click handler existente para abrir modal cuando no est√° en modo asignaci√≥n
        document.getElementById('calendar').addEventListener('click', function(e) {
            const assignment = e.target.closest('.assignment');

            if (!assignment) return;

            // Si estamos en modo asignaci√≥n, manejar selecci√≥n
            if (assignmentMode) {
                // Si es seleccionable, marcar como pendiente
                if (assignment.classList.contains('selectable')) {
                    assignment.classList.remove('selectable');
                    assignment.classList.add('pending-assign');
                    assignment.dataset.tempInspectorId = selectedInspectorId;
                    pendingAssignments.push(assignment);
                    updateFloatingBarCounter();
                    console.log(`OI agregada a la selecci√≥n`);
                }
                // Si ya est√° pendiente, desmarcar
                else if (assignment.classList.contains('pending-assign')) {
                    assignment.classList.remove('pending-assign');
                    assignment.classList.add('selectable');
                    delete assignment.dataset.tempInspectorId;
                    pendingAssignments = pendingAssignments.filter(a => a !== assignment);
                    updateFloatingBarCounter();
                    console.log(`OI removida de la selecci√≥n`);
                }
            } else {
                // Si no estamos en modo asignaci√≥n, abrir modal
                openModal(assignment);
            }
        }, true);

        const toggleFiltersBtn = document.getElementById('toggleFilters');
        const advancedFilters = document.getElementById('advancedFilters');
        if (toggleFiltersBtn && advancedFilters) {
            toggleFiltersBtn.addEventListener('click', function() {
                const isOpen = advancedFilters.classList.toggle('show');
                toggleFiltersBtn.textContent = isOpen ? 'Ver menos' : 'Ver mas';
            });
        }
    </script>
</body>
</html>
